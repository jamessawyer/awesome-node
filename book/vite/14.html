<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>代码分割 | Awesome Node</title>
    <meta name="description" content="Node + Vite + Webpack + Babel">
    <link rel="preload stylesheet" href="/awesome-node/assets/style.7aaf77d9.css" as="style">
    <script type="module" src="/awesome-node/assets/app.6585a414.js"></script>
    <link rel="preload" href="/awesome-node/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
  <link rel="modulepreload" href="/awesome-node/assets/chunks/framework.7812daa2.js">
  <link rel="modulepreload" href="/awesome-node/assets/chunks/theme.f0f59a04.js">
  <link rel="modulepreload" href="/awesome-node/assets/book_vite_14.md.afa0e735.lean.js">
  <link rel="icon" href="/awesome-node/favicon.ico">
  <link rel="apple-touch-icon" href="/awesome-node/pwa-192x192.png" sizes="192x192">
  <meta name="keywords" content="Node, Vite, Webpack, Babel">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  <link rel="manifest" href="/awesome-node/manifest.webmanifest">
  <script id="vite-plugin-pwa:register-sw" src="/awesome-node/registerSW.js"></script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-49ea956c><!--[--><!--]--><!--[--><span tabindex="-1" data-v-2e416324></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-2e416324> Skip to content </a><!--]--><!----><header class="VPNav" data-v-49ea956c data-v-56b927fe><div class="VPNavBar has-sidebar" data-v-56b927fe data-v-d13d5f92><div class="container" data-v-d13d5f92><div class="title" data-v-d13d5f92><div class="VPNavBarTitle has-sidebar" data-v-d13d5f92 data-v-b63551fd><a class="title" href="/awesome-node/" data-v-b63551fd><!--[--><!--]--><!--[--><img class="VPImage logo" src="/awesome-node/logo.svg" alt data-v-85a9830b><!--]--><!--[-->Awesome Node<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-d13d5f92><div class="curtain" data-v-d13d5f92></div><div class="content-body" data-v-d13d5f92><!--[--><!--]--><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-d13d5f92 data-v-29f8f6a7><span id="main-nav-aria-label" class="visually-hidden" data-v-29f8f6a7>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/awesome-node/v18doc/File-System.html" tabindex="0" data-v-29f8f6a7 data-v-06a499ed data-v-01095d06><!--[-->📄Node文档<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/awesome-node/manager/basic.html" tabindex="0" data-v-29f8f6a7 data-v-06a499ed data-v-01095d06><!--[-->📦工程化<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/awesome-node/core/stream/index.html" tabindex="0" data-v-29f8f6a7 data-v-06a499ed data-v-01095d06><!--[-->💫核心概念<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/awesome-node/blog/first.html" tabindex="0" data-v-29f8f6a7 data-v-06a499ed data-v-01095d06><!--[-->🤔blog<!--]--><!----></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-29f8f6a7 data-v-508c46e6><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-508c46e6><span class="text" data-v-508c46e6><!----> 📚书籍 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-508c46e6><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-508c46e6><div class="VPMenu" data-v-508c46e6 data-v-a8e5986e><div class="items" data-v-a8e5986e><!--[--><!--[--><div class="VPMenuLink" data-v-a8e5986e data-v-4542e1b5><a class="VPLink link" href="/awesome-node/book/patterns/the-node-platform.html" data-v-4542e1b5 data-v-01095d06><!--[-->Node Design Patterns<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-a8e5986e data-v-4542e1b5><a class="VPLink link" href="/awesome-node/book/vite/2.html" data-v-4542e1b5 data-v-01095d06><!--[-->深入理解Vite<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-a8e5986e data-v-4542e1b5><a class="VPLink link" href="/awesome-node/book/webpack/1.html" data-v-4542e1b5 data-v-01095d06><!--[-->Webpack5核心原理<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-a8e5986e data-v-4542e1b5><a class="VPLink link" href="/awesome-node/book/babel/2.html" data-v-4542e1b5 data-v-01095d06><!--[-->Babel插件秘籍<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-29f8f6a7 data-v-508c46e6><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-508c46e6><span class="text" data-v-508c46e6><!----> 🧑‍🚀框架 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-508c46e6><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-508c46e6><div class="VPMenu" data-v-508c46e6 data-v-a8e5986e><div class="items" data-v-a8e5986e><!--[--><!--[--><div class="VPMenuLink" data-v-a8e5986e data-v-4542e1b5><a class="VPLink link" href="/awesome-node/framework/nestjs/index.html" data-v-4542e1b5 data-v-01095d06><!--[-->NestJS<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-a8e5986e data-v-4542e1b5><a class="VPLink link" href="/awesome-node/framework/express/index.html" data-v-4542e1b5 data-v-01095d06><!--[-->Express<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-29f8f6a7 data-v-508c46e6><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-508c46e6><span class="text" data-v-508c46e6><!----> 🔥常用库 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-508c46e6><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-508c46e6><div class="VPMenu" data-v-508c46e6 data-v-a8e5986e><div class="items" data-v-a8e5986e><!--[--><!--[--><div class="VPMenuLink" data-v-a8e5986e data-v-4542e1b5><a class="VPLink link" href="/awesome-node/lib/fs-extra/index.html" data-v-4542e1b5 data-v-01095d06><!--[-->fs-extra<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-d13d5f92 data-v-11927c9d><label title="toggle dark mode" data-v-11927c9d data-v-25ab53b0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-checked="false" data-v-25ab53b0 data-v-785f9bd9><span class="check" data-v-785f9bd9><span class="icon" data-v-785f9bd9><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-25ab53b0><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-25ab53b0><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></label></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-d13d5f92 data-v-eae5c608 data-v-508c46e6><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-508c46e6><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-508c46e6><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-508c46e6><div class="VPMenu" data-v-508c46e6 data-v-a8e5986e><!----><!--[--><!--[--><!----><div class="group" data-v-eae5c608><div class="item appearance" data-v-eae5c608><p class="label" data-v-eae5c608>Appearance</p><div class="appearance-action" data-v-eae5c608><label title="toggle dark mode" data-v-eae5c608 data-v-25ab53b0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-checked="false" data-v-25ab53b0 data-v-785f9bd9><span class="check" data-v-785f9bd9><span class="icon" data-v-785f9bd9><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-25ab53b0><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-25ab53b0><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></label></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-d13d5f92 data-v-f545931e><span class="container" data-v-f545931e><span class="top" data-v-f545931e></span><span class="middle" data-v-f545931e></span><span class="bottom" data-v-f545931e></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav" data-v-49ea956c data-v-1e6acb7f><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-1e6acb7f><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-1e6acb7f><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-1e6acb7f>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-1e6acb7f data-v-8340454f><button data-v-8340454f>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-49ea956c data-v-3fbbbda7><div class="curtain" data-v-3fbbbda7></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-3fbbbda7><span class="visually-hidden" id="sidebar-aria-label" data-v-3fbbbda7> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-3fbbbda7><section class="VPSidebarItem level-0 has-active" data-v-3fbbbda7 data-v-a486264d><div class="item" role="button" tabindex="0" data-v-a486264d><div class="indicator" data-v-a486264d></div><h2 class="text" data-v-a486264d>🔧深入理解Vite</h2><!----></div><div class="items" data-v-a486264d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-a486264d data-v-a486264d><div class="item" data-v-a486264d><div class="indicator" data-v-a486264d></div><a class="VPLink link link" href="/awesome-node/book/vite/1.html" data-v-a486264d data-v-01095d06><!--[--><p class="text" data-v-a486264d>1.Vite开篇</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a486264d data-v-a486264d><div class="item" data-v-a486264d><div class="indicator" data-v-a486264d></div><a class="VPLink link link" href="/awesome-node/book/vite/2.html" data-v-a486264d data-v-01095d06><!--[--><p class="text" data-v-a486264d>2.模块标准</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a486264d data-v-a486264d><div class="item" data-v-a486264d><div class="indicator" data-v-a486264d></div><a class="VPLink link link" href="/awesome-node/book/vite/3.html" data-v-a486264d data-v-01095d06><!--[--><p class="text" data-v-a486264d>3.快速上手Vite</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a486264d data-v-a486264d><div class="item" data-v-a486264d><div class="indicator" data-v-a486264d></div><a class="VPLink link link" href="/awesome-node/book/vite/4.html" data-v-a486264d data-v-01095d06><!--[--><p class="text" data-v-a486264d>4.样式方案</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a486264d data-v-a486264d><div class="item" data-v-a486264d><div class="indicator" data-v-a486264d></div><a class="VPLink link link" href="/awesome-node/book/vite/7.html" data-v-a486264d data-v-01095d06><!--[--><p class="text" data-v-a486264d>7.预构建</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a486264d data-v-a486264d><div class="item" data-v-a486264d><div class="indicator" data-v-a486264d></div><a class="VPLink link link" href="/awesome-node/book/vite/8.html" data-v-a486264d data-v-01095d06><!--[--><p class="text" data-v-a486264d>8.双引擎架构</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a486264d data-v-a486264d><div class="item" data-v-a486264d><div class="indicator" data-v-a486264d></div><a class="VPLink link link" href="/awesome-node/book/vite/9.html" data-v-a486264d data-v-01095d06><!--[--><p class="text" data-v-a486264d>9.性能推手: Esbuild</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a486264d data-v-a486264d><div class="item" data-v-a486264d><div class="indicator" data-v-a486264d></div><a class="VPLink link link" href="/awesome-node/book/vite/10.html" data-v-a486264d data-v-01095d06><!--[--><p class="text" data-v-a486264d>10.Rollup基本用法</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a486264d data-v-a486264d><div class="item" data-v-a486264d><div class="indicator" data-v-a486264d></div><a class="VPLink link link" href="/awesome-node/book/vite/11.html" data-v-a486264d data-v-01095d06><!--[--><p class="text" data-v-a486264d>11.深入理解Rollup插件机制</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a486264d data-v-a486264d><div class="item" data-v-a486264d><div class="indicator" data-v-a486264d></div><a class="VPLink link link" href="/awesome-node/book/vite/12.html" data-v-a486264d data-v-01095d06><!--[--><p class="text" data-v-a486264d>12.Vite插件开发</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link is-active has-active" data-v-a486264d data-v-a486264d><div class="item" data-v-a486264d><div class="indicator" data-v-a486264d></div><a class="VPLink link link" href="/awesome-node/book/vite/14.html" data-v-a486264d data-v-01095d06><!--[--><p class="text" data-v-a486264d>14.代码分割</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a486264d data-v-a486264d><div class="item" data-v-a486264d><div class="indicator" data-v-a486264d></div><a class="VPLink link link" href="/awesome-node/book/vite/15.html" data-v-a486264d data-v-01095d06><!--[--><p class="text" data-v-a486264d>15.Polyfill和语法降级</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a486264d data-v-a486264d><div class="item" data-v-a486264d><div class="indicator" data-v-a486264d></div><a class="VPLink link link" href="/awesome-node/book/vite/16.html" data-v-a486264d data-v-01095d06><!--[--><p class="text" data-v-a486264d>16.Vite搭建SSR工程</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a486264d data-v-a486264d><div class="item" data-v-a486264d><div class="indicator" data-v-a486264d></div><a class="VPLink link link" href="/awesome-node/book/vite/17.html" data-v-a486264d data-v-01095d06><!--[--><p class="text" data-v-a486264d>17.联邦模块以及原理</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a486264d data-v-a486264d><div class="item" data-v-a486264d><div class="indicator" data-v-a486264d></div><a class="VPLink link link" href="/awesome-node/book/vite/18.html" data-v-a486264d data-v-01095d06><!--[--><p class="text" data-v-a486264d>18.Pure ESM时代</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a486264d data-v-a486264d><div class="item" data-v-a486264d><div class="indicator" data-v-a486264d></div><a class="VPLink link link" href="/awesome-node/book/vite/19.html" data-v-a486264d data-v-01095d06><!--[--><p class="text" data-v-a486264d>19.系统对Vite项目性能优化</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-49ea956c data-v-227c3700><div class="VPDoc has-sidebar has-aside" data-v-227c3700 data-v-e08fe318><!--[--><!--]--><div class="container" data-v-e08fe318><div class="aside" data-v-e08fe318><div class="aside-curtain" data-v-e08fe318></div><div class="aside-container" data-v-e08fe318><div class="aside-content" data-v-e08fe318><div class="VPDocAside" data-v-e08fe318 data-v-d53a0c94><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-d53a0c94 data-v-f8cf7442><div class="content" data-v-f8cf7442><div class="outline-marker" data-v-f8cf7442></div><div class="outline-title" data-v-f8cf7442>目录</div><nav aria-labelledby="doc-outline-aria-label" data-v-f8cf7442><span class="visually-hidden" id="doc-outline-aria-label" data-v-f8cf7442> Table of Contents for current page </span><ul class="root" data-v-f8cf7442 data-v-f8a0804d><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-d53a0c94></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-e08fe318><div class="content-container" data-v-e08fe318><!--[--><!--]--><!----><main class="main" data-v-e08fe318><div style="position:relative;" class="vp-doc _awesome-node_book_vite_14" data-v-e08fe318><div><h2 id="代码分割-打包完产物体积太大-怎么拆包" tabindex="-1">代码分割：打包完产物体积太大，怎么拆包？ <a class="header-anchor" href="#代码分割-打包完产物体积太大-怎么拆包" aria-label="Permalink to &quot;代码分割：打包完产物体积太大，怎么拆包？&quot;">​</a></h2><p>在生产环境下，为了提高页面加载性能，构建工具一般将项目的代码打包(bundle)到一起，这样上线之后只需要请求少量的 JS 文件，大大减少 HTTP 请求。当然，Vite 也不例外，默认情况下 Vite 利用底层打包引擎 Rollup 来完成项目的模块打包。</p><p>某种意义上来说，对线上环境进行项目打包是一个必须的操作。但随着前端工程的日渐复杂，单份的打包产物体积越来越庞大，会出现一系列应用加载性能问题，而代码分割可以很好地解决它们。</p><p>在本小节中，我们将围绕<code>代码分割</code>展开学习。首先我们将一起分析<code>Code Splitting</code>解决了单产物打包模式下的哪些问题，然后用具体的项目示例体验一下 Vite 默认自带的 <code>Code Splitting</code> 效果。从中，你将了解到 Vite 的默认分包策略，以及底层所使用的 Rollup 拆包 API——<code>manualChunks</code>。</p><p>当然，在实际的项目场景中，只用 Vite 默认的策略是不够的，我们会更深入一步，学习 Rollup 底层拆包的各种高级姿势，实现<strong>自定义拆包</strong>，同时我也会带大家通过实际案例复现 Rollup 自定义拆包经常遇到的坑——<code>循环引用</code>问题，一起分析问题出现的原因，也分享一些自己的解决思路和方案，让大家对 Vite 及 Rollup 的代码分割有更加深入的掌握。</p><p>需要注意的是，文中会多次提到<code>bundle</code>、<code>chunk</code>、<code>vendor</code>这些构建领域的专业概念，这里给大家提前解释一下:</p><ul><li><code>bundle</code> - 指的是整体的打包产物，包含 JS 和各种静态资源。</li><li><code>chunk</code> - 指的是打包后的 JS 文件，是 <code>bundle</code> 的子集。</li><li><code>vendor</code> - 是指第三方包的打包产物，是一种特殊的 chunk。</li></ul><h2 id="code-splitting-解决的问题" tabindex="-1">Code Splitting 解决的问题 <a class="header-anchor" href="#code-splitting-解决的问题" aria-label="Permalink to &quot;Code Splitting 解决的问题&quot;">​</a></h2><p><strong>在传统的单 chunk 打包模式下，当项目代码越来越庞大，最后会导致浏览器下载一个巨大的文件，从页面加载性能的角度来说，主要会导致两个问题:</strong></p><ol><li>无法做到<strong>按需加载</strong>，即使是当前页面不需要的代码也会进行加载。</li><li>线上<strong>缓存复用率</strong>极低，改动一行代码即可导致整个 bundle 产物缓存失效。</li></ol><p>首先说第一个问题，一般而言，一个前端页面中的 JS 代码可以分为两个部分: <code>Initital Chunk</code>和<code>Async Chunk</code>，前者指页面首屏所需要的 JS 代码，而后者当前页面并不一定需要，一个典型的例子就是 <code>路由组件</code>，与当前路由无关的组件并不用加载。而项目被打包成单 bundle 之后，无论是<code>Initial Chunk</code>还是<code>Async Chunk</code>，都会打包进同一个产物，也就是说，浏览器加载产物代码的时候，会将两者一起加载，导致许多冗余的加载过程，从而影响页面性能。而通过<code>Code Splitting</code>我们可以将按需加载的代码拆分出单独的 chunk，这样应用在首屏加载时只需要加载<code>Initial Chunk</code> 即可，避免了冗余的加载过程，使页面性能得到提升。</p><p>其次，线上的<code>缓存命中率</code>是一个重要的性能衡量标准。对于线上站点而言，服务端一般在响应资源时加上一些 HTTP 响应头，最常见的响应头之一就是<code>cache-control</code>，它可以指定浏览器的<strong>强缓存</strong>，比如设置为下面这样:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">cache-control:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">max-age=</span><span style="color:#F78C6C;">31536000</span></span></code></pre></div><p>表示资源过期时间为一年，在过期之前，访问<strong>相同的资源 url</strong>，浏览器直接利用本地的缓存，并不用给服务端发请求，这就大大降低了页面加载的网络开销。不过，在单 chunk 打包模式下面，一旦有一行代码变动，整个 chunk 的 url 地址都会变化，比如下图所示的场景:</p><p><img src="/awesome-node/assets/14-1.813b462a.webp" alt="缓存失效"></p><p>由于构建工具一般会根据产物的内容生成哈希值，一旦内容变化就会导致整个 chunk 产物的强缓存失效，所以单 chunk 打包模式下的缓存命中率极低，基本为零。</p><p>而进行<code>Code Splitting</code>之后，代码的改动只会影响部分的 chunk 哈希改动，如下图所示:</p><p><img src="/awesome-node/assets/14-2.bf8f3eed.webp" alt="code splitting"></p><p>入口文件引用了<code>A</code>、<code>B</code>、<code>C</code>、<code>D</code>四个组件，当我们修改 A 的代码后，变动的 Chunk 就只有 <code>A</code> 以及<code>依赖 A 的 Chunk</code> 中，A 对应的 chunk 会变动，这很好理解，后者也会变动是因为相应的引入语句会变化，如这里的入口文件会发生如下内容变动:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> CompA </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./A.d3e2f17a.js</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 更新 import 语句</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> CompA </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./A.a5d2f82b.js</span><span style="color:#89DDFF;">&#39;</span></span></code></pre></div><p>也就是说，在改动 <code>A</code> 的代码后，<code>B</code>、<code>C</code>、<code>D</code>的 chunk 产物 url 并没有发生变化，从而可以让浏览器复用本地的强缓存，大大提升线上应用的加载性能。</p><h2 id="vite-默认拆包策略" tabindex="-1">Vite 默认拆包策略 <a class="header-anchor" href="#vite-默认拆包策略" aria-label="Permalink to &quot;Vite 默认拆包策略&quot;">​</a></h2><p>刚刚我们说到了为什么要进行拆包，实际上 Vite 中已经内置了一份拆包的策略，接下来让我们来看看 Vite 默认的拆包模式是怎样的。</p><p>在生产环境下 Vite 完全利用 Rollup 进行构建，因此拆包也是基于 Rollup 来完成的，但 Rollup 本身是一个专注 JS 库打包的工具，对应用构建的能力还尚为欠缺，Vite 正好是补足了 Rollup 应用构建的能力，在拆包能力这一块的扩展就是很好的体现。</p><p>我们先通过具体的项目来体验一下 Vite 拆包，示例项目我已经放到了小册的 Gihub 仓库中，你可以对照着来学习。</p><p>在项目中执行<code>npm run build</code>，接着终端会出现如下的构建信息:</p><p><img src="/awesome-node/assets/14-3.23bb525b.webp" alt="default code splitting"></p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>项目示例使用的是 Vite 2.9 之前的版本，<a href="https://github.com/sanyuan0704/juejin-book-vite/tree/main/14-code-splitting" target="_blank" rel="noreferrer">code splitting - github</a> Vite 2.9 及以后的版本拆包策略会有所不同，后文会介绍。</p></div><p>这里我来解释一下产物的结构:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#82AAFF;">.</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">assets</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">├──</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Dynamic.3df51f7a.js</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">//</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Async</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Chunk</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">├──</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Dynamic.f2cbf023.css</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">//</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Async</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Chunk</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">CSS</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">├──</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">favicon.17e50649.svg</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">//</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">静态资源</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">├──</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">index.1e236845.css</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">//</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Initial</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Chunk</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">CSS</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">├──</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">index.6773c114.js</span><span style="color:#A6ACCD;">      </span><span style="color:#C3E88D;">//</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Initial</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Chunk</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">└──</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">vendor.ab4b9e1f.js</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">//</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">第三方包产物</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Chunk</span></span>
<span class="line"><span style="color:#FFCB6B;">└──</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">index.html</span><span style="color:#A6ACCD;">                 </span><span style="color:#C3E88D;">//</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">入口</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HTML</span></span></code></pre></div><p>对于 Vite 的拆包能力，从产物结构中就可见一斑。</p><p>一方面 Vite 实现了自动 <strong>CSS 代码分割</strong>的能力，即实现一个 chunk 对应一个 css 文件，比如上面产物中<code>index.js</code>对应一份<code>index.css</code>，而按需加载的 chunk <code>Dynamic.js</code>也对应单独的一份<code>Dynamic.css</code>文件，与 JS 文件的代码分割同理，这样做也能提升 CSS 文件的缓存复用率。</p><p>而另一方面， Vite 基于 Rollup 的<code>manualChunks</code>API 实现了<code>应用拆包</code>的策略:</p><ul><li>对于 <code>Initial Chunk</code> 而言，业务代码和第三方包代码分别打包为单独的 chunk，在上述的例子中分别对应<code>index.js</code>和<code>vendor.js</code>。需要说明的是，这是 Vite 2.9 版本之前的做法，而在 Vite 2.9 及以后的版本，默认打包策略更加简单粗暴，将所有的 js 代码全部打包到 <code>index.js</code> 中🚨。</li><li>对于 <code>Async Chunk</code> 而言 ，动态 import 的代码会被拆分成单独的 chunk，如上述的<code>Dynamic</code>组件。</li></ul><p>小结一下，Vite 默认拆包的优势在于实现了 CSS 代码分割与业务代码、第三方库代码、动态 import 模块代码三者的分离，但缺点也比较直观，第三方库的打包产物容易变得比较臃肿，上述例子中的<code>vendor.js</code>的大小已经达到 500 KB 以上，显然是有进一步拆包的优化空间的，这个时候我们就需要用到 Rollup 中的拆包 API ——<code>manualChunks</code> 了。</p><h2 id="自定义拆包策略" tabindex="-1">自定义拆包策略 <a class="header-anchor" href="#自定义拆包策略" aria-label="Permalink to &quot;自定义拆包策略&quot;">​</a></h2><p>针对更细粒度的拆包，Vite 的底层打包引擎 Rollup 提供了<a href="https://rollupjs.org/configuration-options/#output-manualchunks" target="_blank" rel="noreferrer">manualChunks</a>，让我们能自定义拆包策略，它属于 Vite 配置的一部分，示例如下:</p><div class="vp-code-group"><div class="tabs"><input type="radio" name="group-l2HOh" id="tab-4pA4qSZ" checked="checked"><label for="tab-4pA4qSZ">vite.config.ts</label></div><div class="blocks"><div class="language-typescript active"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight has-highlighted-lines"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">build</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">rollupOptions</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">output</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// manualChunks 配置</span></span>
<span class="line highlighted"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">manualChunks</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{},</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div></div></div><p><code>manualChunks</code> 主要有两种配置的形式，可以配置为一个对象或者一个函数。我们先来看看对象的配置，也是最简单的配置方式，你可以在上述的示例项目中添加如下的<code>manualChunks</code>配置代码:</p><div class="vp-code-group"><div class="tabs"><input type="radio" name="group-bW7fo" id="tab-1qoAEDb" checked="checked"><label for="tab-1qoAEDb">vite.config.ts</label></div><div class="blocks"><div class="language-typescript active"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#FFCB6B;">build</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">rollupOptions</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#FFCB6B;">output</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// manualChunks 配置</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#FFCB6B;">manualChunks</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// 将 React 相关库打包成单独的 chunk 中</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">react-vendor</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">: [</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">react</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">react-dom</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// 将 Lodash 库的代码单独打包</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">lodash</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">: [</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">lodash-es</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// 将组件库的代码打包</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">library</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">: [</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">antd</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">@arco-design/web-react</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div></div></div><p>在对象格式的配置中，<code>key</code>代表 chunk 的名称，<code>value</code>为一个字符串数组，每一项为第三方包的包名。在进行了如上的配置之后，我们可以执行<code>npm run build</code>尝试一下打包:</p><p><img src="/awesome-node/assets/14-4.161c7e49.webp" alt="manualChunks"></p><p>你可以看到原来的 vendor 大文件被拆分成了我们手动指定的几个小 chunk，每个 chunk 大概 200 KB 左右，是一个比较理想的 chunk 体积。这样，当第三方包更新的时候，也只会更新其中一个 chunk 的 url，而不会全量更新，从而提高了第三方包产物的缓存命中率。</p><p>除了对象的配置方式之外，我们还可以通过函数进行更加灵活的配置，而 Vite 中的默认拆包策略也是通过函数的方式来进行配置的，我们可以在 Vite 的实现中瞧一瞧:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// Vite 部分源码</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">createMoveToVendorChunkFn</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">config</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ResolvedConfig</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">GetManualChunk</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">cache</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">Map</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">boolean</span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 返回值为 manualChunks 的配置</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">id</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;font-style:italic;">getModuleInfo</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">})</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// Vite 默认的配置逻辑其实很简单</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 主要是为了把 Initial Chunk 中的第三方包代码单独打包成`vendor.[hash].js`</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">includes</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">node_modules</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">!</span><span style="color:#82AAFF;">isCSSRequest</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// 判断是否为 Initial Chunk</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">staticImportedByEntry</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">getModuleInfo</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">cache</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    ) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">vendor</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>Rollup 会对每一个模块调用 manualChunks 函数，在 manualChunks 的函数入参中你可以拿到<code>模块 id</code> 及<code>模块详情信息</code>，经过一定的处理后返回 <code>chunk 文件的名称</code>，这样当前 id 代表的模块便会打包到你所指定的 chunk 文件中。</p><p>我们现在来试着把刚才的拆包逻辑用函数来实现一遍:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#82AAFF;">manualChunks</span><span style="color:#A6ACCD;">(id) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">includes</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">antd</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">includes</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">@arco-design/web-react</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">library</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">includes</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">lodash</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">lodash</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">includes</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">react</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">react</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>打包后结果如下:</p><p><img src="/awesome-node/assets/14-5.574094fa.webp" alt="function manualChunks"></p><p>看上去好像各个第三方包的 chunk (如<code>lodash</code>、<code>react</code>等等)都能拆分出来，但实际上你可以运行 <code>npx vite preview</code> 预览产物，会发现产物根本没有办法运行起来，页面出现白屏，同时控制台出现如下的报错:</p><p><img src="/awesome-node/assets/14-6.d43bca6d.webp" alt="function manualChunks Error"></p><p>这也就是函数配置的坑点所在了，虽然灵活而方便，但稍不注意就陷入此类的产物错误问题当中。那上面的这个报错究竟是什么原因导致的呢？</p><h2 id="解决循环引用问题" tabindex="-1">解决循环引用问题 <a class="header-anchor" href="#解决循环引用问题" aria-label="Permalink to &quot;解决循环引用问题&quot;">​</a></h2><p>从报错信息追溯到产物中，可以发现<code>react-vendor.js</code>与<code>index.js</code>发生了循环引用:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// react-vendor.e2c4883f.js</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">q</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">objectAssign</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">./index.37a7b2eb.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// index.37a7b2eb.js</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">R</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">React</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">./react-vendor.e2c4883f.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span></code></pre></div><p>这是很典型的 ES 模块循环引用的场景，我们可以用一个最基本的例子来复原这个场景:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// a.js</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">funcB</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./b.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">funcB</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">var</span><span style="color:#A6ACCD;"> funcA </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">a</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// b.js</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">funcA</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./a.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">funcA</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">var</span><span style="color:#A6ACCD;"> funcB </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">b</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>接着我们可以执行一下<code>a.js</code>文件:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;!</span><span style="color:#A6ACCD;">DOCTYPE html</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">html</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">lang</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">en</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">meta</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">charset</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">UTF-8</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">title</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">Document</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">title</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">type</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">module</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">src</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/a.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">html</span><span style="color:#89DDFF;">&gt;</span></span></code></pre></div><p>在浏览器中打开会出现类似的报错:</p><p><img src="/awesome-node/assets/14-7.c5eabf14.webp" alt="cycle deps"></p><p>代码的执行原理如下:</p><ol><li>JS 引擎执行 <code>a.js</code> 时，发现引入了 <code>b.js</code>，于是去执行 <code>b.js</code></li><li>引擎执行<code>b.js</code>，发现里面引入了<code>a.js</code>(出现循环引用)，认为<code>a.js</code>已经加载完成，继续往下执行</li><li>执行到<code>funcA()</code>语句时发现 funcA 并没有定义，于是报错。</li></ol><p><img src="/awesome-node/assets/14-8.14e0e0c8.webp" alt="deps"></p><p>而对于如上打包产物的执行过程也是同理:</p><p><img src="/awesome-node/assets/14-9.355489ad.webp" alt="cycle deps bundle"></p><p>可能你会有疑问: <code>react-vendor</code>为什么需要引用<code>index.js</code>的代码呢？其实也很好理解，我们之前在<code>manualChunks</code>中仅仅将路径包含 <code>react</code> 的模块打包到<code>react-vendor</code>中，殊不知，像<code>object-assign</code>这种 react 本身的依赖并没有打包进<code>react-vendor</code>中，而是打包到另外的 chunk 当中，从而导致如下的循环依赖关系:</p><p><img src="/awesome-node/assets/14-10.e67b5ecd.webp" alt="react cycle deps"></p><p>那我们能不能避免这种问题呢？当然是可以的，之前的 <code>manualChunks</code>逻辑过于简单粗暴，仅仅通过路径 id 来决定打包到哪个 chunk 中，而漏掉了间接依赖的情况。如果针对像<code>object-assign</code>这种间接依赖，我们也能识别出它属于 react 的依赖，将其自动打包到<code>react-vendor</code>中，这样就可以避免循环引用的问题。</p><p>我们来梳理一下解决的思路:</p><ol><li>确定 react 相关包的入口路径。</li><li>在 manualChunks 中拿到模块的详细信息，向上追溯它的引用者，如果命中 react 的路径，则将模块放到 <code>react-vendor</code>中。</li></ol><p>接下来让我们进行实际代码的实现:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 确定 react 相关包的入口路径</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> chunkGroups </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">react-vendor</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> [</span></span>
<span class="line"><span style="color:#A6ACCD;">    require</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resolve</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">react</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    require</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resolve</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">react-dom</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  ]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// Vite 中的 manualChunks 配置</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">manualChunks</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">id</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">getModuleInfo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">})</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">group</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">of</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">keys</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">chunkGroups</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">deps</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">chunkGroups</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">group</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">includes</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">node_modules</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// 递归向上查找引用者，检查是否命中 chunkGroups 声明的包 </span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">isDepInclude</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">deps</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> []</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">getModuleInfo</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">     ) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">group</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>实际上核心逻辑包含在<code>isDepInclude</code>函数，用来递归向上查找引用者模块:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 缓存对象</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> cache </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Map</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isDepInclude</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#A6ACCD;font-style:italic;">id</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">depPaths</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#A6ACCD;">[]</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">importChain</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#A6ACCD;">[]</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">getModuleInfo</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">undefined</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">key</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">`${</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">-</span><span style="color:#89DDFF;">${</span><span style="color:#A6ACCD;">depPaths</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">|</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">}`</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 出现循环依赖，不考虑</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">importChain</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">includes</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">cache</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">key</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 验证缓存</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">cache</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">has</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">key</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">cache</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">key</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 命中依赖列表</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">depPaths</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">includes</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 引用链中的文件都记录到缓存中</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">importChain</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">forEach</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;font-style:italic;">item</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">cache</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">`${</span><span style="color:#A6ACCD;">item</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">-</span><span style="color:#89DDFF;">${</span><span style="color:#A6ACCD;">depPaths</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">|</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">}`</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">moduleInfo</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">getModuleInfo</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">moduleInfo</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">moduleInfo</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">importers</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">cache</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">key</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 核心逻辑，递归查找上层引用者</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">isInclude</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">moduleInfo</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">importers</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">some</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;font-style:italic;">importer</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span></span>
<span class="line"><span style="color:#F07178;">    	</span><span style="color:#82AAFF;">isDepInclude</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">importer</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">depPaths</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#F07178;">       	  </span><span style="color:#A6ACCD;">importChain</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">concat</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">getModuleInfo</span></span>
<span class="line"><span style="color:#F07178;">      )</span></span>
<span class="line"><span style="color:#F07178;">  )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 设置缓存</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">cache</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">key</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">isInclude</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">isInclude</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span></code></pre></div><p>对于这个函数的实现，有两个地方需要大家注意:</p><ol><li>我们可以通过 manualChunks 提供的入参<code>getModuleInfo</code>来获取模块的详情<code>moduleInfo</code>，然后通过<code>moduleInfo.importers</code>拿到模块的引用者，针对每个引用者又可以递归地执行这一过程，从而获取引用链的信息。</li><li>尽量使用缓存。由于第三方包模块数量一般比较多，对每个模块都向上查找一遍引用链会导致开销非常大，并且会产生很多重复的逻辑，使用缓存会极大加速这一过程。</li></ol><p>完成上述<code>manualChunks</code>的完整逻辑后，现在我们来执行<code>npm run build</code>来进行打包:</p><p><img src="/awesome-node/assets/14-11.eae8b63e.webp" alt="correct manual bundle"></p><p>可以发现<code>react-vendor</code>可以正常拆分出来，查看它的内容:</p><p><img src="/awesome-node/assets/14-12.52d42fa2.webp" alt="react-vendor content"></p><p>从中你可以看出<code>react</code>的一些间接依赖已经成功打包到了<code>react-vendor</code>当中，执行<code>npx view preview</code>预览产物页面也能正常渲染了:</p><p><img src="/awesome-node/assets/14-13.b4574f1f.webp" alt="dist preview"></p><p>说明循环依赖的问题已经被我们解决掉了。</p><h2 id="终极解决方案" tabindex="-1">终极解决方案 <a class="header-anchor" href="#终极解决方案" aria-label="Permalink to &quot;终极解决方案&quot;">​</a></h2><p>尽管上述的解决方案已经能帮我们正常进行产物拆包，但从实现上来看，还是显得略微繁琐，那么有没有开箱即用的拆包方案，能让我们直接用到项目中呢？</p><p>答案是肯定的，接下来我就给大家介绍 Vite 自定义拆包的终极解决方案——<code>vite-plugin-chunk-split</code>。</p><p>首先安装一下这个插件:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">pnpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">i</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">vite-plugin-chunk-split</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-D</span></span></code></pre></div><p>然后你可以在项目中引入并使用:</p><div class="vp-code-group"><div class="tabs"><input type="radio" name="group-LFUHp" id="tab-KtH8Lrd" checked="checked"><label for="tab-KtH8Lrd">vite.config.ts</label></div><div class="blocks"><div class="language-typescript active"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight has-highlighted-lines"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">chunkSplitPlugin</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">vite-plugin-chunk-split</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">chunkSplitPlugin</span><span style="color:#89DDFF;">({</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 指定拆包策略</span></span>
<span class="line highlighted"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">customSplitting</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// 1. 支持填包名。`react` 和 `react-dom` 会被打包到一个名为`render-vendor`的</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">//   chunk里面(包括它们的依赖，如 object-assign)😎</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">react-vendor</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">react</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">react-dom</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">],</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// 2. 支持填正则表达式。src 中 components 和 utils </span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// 下的所有文件被会被打包为`component-util`的 chunk 中</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">components-util</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">src</span><span style="color:#A6ACCD;">\/</span><span style="color:#C3E88D;">components</span><span style="color:#89DDFF;">/</span><span style="color:#89DDFF;">,</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">src</span><span style="color:#A6ACCD;">\/</span><span style="color:#C3E88D;">utils</span><span style="color:#89DDFF;">/</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">})</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div></div></div><p>相比于手动操作依赖关系，使用插件只需几行配置就能完成，非常方便。当然，这个插件还可以支持多种打包策略，包括 unbundle 模式打包，你可以去 <a href="https://github.com/sanyuan0704/vite-plugin-chunk-split/blob/master/README-CN.md" target="_blank" rel="noreferrer">vite-plugin-chunk-split使用文档</a> 探索更多使用姿势。</p><h2 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-label="Permalink to &quot;小结&quot;">​</a></h2><p>恭喜你，学习完了本小节的内容，我们最后来小结和回顾一下。在本小节，你需要重点掌握<strong>拆包的意义</strong>、<strong>Vite 中的默认拆包策略</strong>和<strong>自定义拆包方法</strong>。</p><p>首先我给你分析了拆包技术所解决的问题，主要包括<strong>无法按需加载</strong>以及<strong>线上缓存命中率低</strong>两个问题，然后我们一起通过具体的项目示例尝试了 Vite 默认的拆包策略，但默认的策略也是有缺陷的，比如对第三方包模块无法做进一步的拆包，这就需要我们自定义拆包策略了。</p><p>由于 Vite 生产环境使用 Rollup 进行打包，在后续的内容我们深入学习了 Rollup 底层的拆包 API——<code>manualChunks</code>，用<code>对象配置</code>和<code>函数配置</code>两种方式来自定义拆包策略，对象配置使用上比较简单，但函数配置更加灵活。随后我和你分析了函数配置中容易遇到的坑——chunk 循环依赖问题，并分享了我的解决思路和方案。不过一般情况下，大家将<code>manualChunks</code>配置为一个对象即可，如果需要进行深度的拆包优化可以采用函数的方式，相信经过今天的学习你也能很好地驾驭函数拆包配置。</p><p>最后，欢迎你在评论区记录你的学习心得和收获，也欢迎和我一起讨论。我们下一节再见👋🏻。</p><ul><li>扩展阅读: <a href="http://es6.ruanyifeng.com/#docs/module-loader#%E5%BE%AA%E7%8E%AF%E5%8A%A0%E8%BD%BD" target="_blank" rel="noreferrer">阮一峰 ECMAScript 6 入门——模块循环依赖加载</a></li></ul><p>2023年02月13日11:41:51</p></div></div></main><footer class="VPDocFooter" data-v-e08fe318 data-v-39c03cd7><!--[--><!--]--><div class="edit-info" data-v-39c03cd7><div class="edit-link" data-v-39c03cd7><a class="VPLink link edit-link-button" href="https://github.com/jamessawyer/awesome-node/edit/main/docs/book/vite/14.md" target="_blank" rel="noreferrer" data-v-39c03cd7 data-v-01095d06><!--[--><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="edit-link-icon" aria-label="edit icon" data-v-39c03cd7><path d="M18,23H4c-1.7,0-3-1.3-3-3V6c0-1.7,1.3-3,3-3h7c0.6,0,1,0.4,1,1s-0.4,1-1,1H4C3.4,5,3,5.4,3,6v14c0,0.6,0.4,1,1,1h14c0.6,0,1-0.4,1-1v-7c0-0.6,0.4-1,1-1s1,0.4,1,1v7C21,21.7,19.7,23,18,23z"></path><path d="M8,17c-0.3,0-0.5-0.1-0.7-0.3C7,16.5,6.9,16.1,7,15.8l1-4c0-0.2,0.1-0.3,0.3-0.5l9.5-9.5c1.2-1.2,3.2-1.2,4.4,0c1.2,1.2,1.2,3.2,0,4.4l-9.5,9.5c-0.1,0.1-0.3,0.2-0.5,0.3l-4,1C8.2,17,8.1,17,8,17zM9.9,12.5l-0.5,2.1l2.1-0.5l9.3-9.3c0.4-0.4,0.4-1.1,0-1.6c-0.4-0.4-1.2-0.4-1.6,0l0,0L9.9,12.5z M18.5,2.5L18.5,2.5L18.5,2.5z"></path></svg> 在GitHub编辑此页<!--]--><!----></a></div><div class="last-updated" data-v-39c03cd7><p class="VPLastUpdated" data-v-39c03cd7 data-v-c0d1d2d4>Last updated: <time datetime="2023-04-14T07:28:51.000Z" data-v-c0d1d2d4></time></p></div></div><div class="prev-next" data-v-39c03cd7><div class="pager" data-v-39c03cd7><a class="pager-link prev" href="/awesome-node/book/vite/12.html" data-v-39c03cd7><span class="desc" data-v-39c03cd7>Previous page</span><span class="title" data-v-39c03cd7>12.Vite插件开发</span></a></div><div class="has-prev pager" data-v-39c03cd7><a class="pager-link next" href="/awesome-node/book/vite/15.html" data-v-39c03cd7><span class="desc" data-v-39c03cd7>Next page</span><span class="title" data-v-39c03cd7>15.Polyfill和语法降级</span></a></div></div></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"lib_fs-extra_move.md\":\"fa2e7b53\",\"lib_fs-extra_outputfile.md\":\"c68d8e5d\",\"lib_fs-extra_outputjson.md\":\"7face63b\",\"lib_fs-extra_pathexists.md\":\"654794f3\",\"lib_fs-extra_readjson.md\":\"2a7ec3a3\",\"lib_fs-extra_remove.md\":\"6de1ffb0\",\"lib_fs-extra_writejson.md\":\"ae2315a4\",\"manager_babel.md\":\"871c7783\",\"manager_basic.md\":\"0e68864a\",\"manager_recipe.md\":\"4e03920c\",\"manager_vite.md\":\"cdcdc276\",\"manager_webpack.md\":\"5b39f06d\",\"v18doc_file-system.md\":\"94a17901\",\"v18doc_path.md\":\"ab487f60\",\"book_babel_index.md\":\"4ae21c3c\",\"book_vite_10.md\":\"94b279a0\",\"blog_translate_web-streams-on-node.md\":\"1605d0ca\",\"book_babel_1.md\":\"fd2d7bd0\",\"book_babel_2.md\":\"bdc019f8\",\"book_babel_3.md\":\"1cd000d2\",\"book_vite_11.md\":\"dbdb9af2\",\"book_vite_12.md\":\"5d8ed56e\",\"book_vite_14.md\":\"afa0e735\",\"book_babel_4.md\":\"4e56863f\",\"book_vite_15.md\":\"7393935a\",\"book_babel_5.md\":\"3d4f4a47\",\"book_vite_17.md\":\"c62a806f\",\"book_babel_6.md\":\"988cfac6\",\"book_patterns_callback-and-events.md\":\"b84a52cb\",\"book_vite_18.md\":\"229e3017\",\"book_patterns_module-system_commonjs-modules.md\":\"d58e3d94\",\"book_vite_19.md\":\"4c4b81bb\",\"book_patterns_module-system_esm-cjs-interoperability.md\":\"3bd8cf89\",\"book_patterns_module-system_esm.md\":\"4204bf0d\",\"book_patterns_module-system_module-define-patterns.md\":\"78aea281\",\"book_patterns_module-system_module-system-in-js-and-node.md\":\"0166f0bc\",\"book_patterns_module-system_summary.md\":\"76c7b3b5\",\"book_patterns_module-system_the-module-system-and-its-patterns.md\":\"4b3531cb\",\"book_patterns_module-system_the-need-for-modules.md\":\"356a6576\",\"book_patterns_the-module-system.md\":\"3cf669ae\",\"book_patterns_the-node-platform.md\":\"1805d0c4\",\"book_vite_3.md\":\"de3a3acc\",\"book_vite_4.md\":\"5d44cfc7\",\"book_vite_7.md\":\"2e3a9bad\",\"book_vite_8.md\":\"c23e7030\",\"book_vite_9.md\":\"daf74a2e\",\"book_webpack_1.md\":\"31f13091\",\"book_webpack_10.md\":\"432f42d2\",\"book_webpack_11.md\":\"58c36101\",\"book_webpack_13.md\":\"fa89613a\",\"book_patterns_module-system_index.md\":\"00506960\",\"book_webpack_16.md\":\"41d2ddd3\",\"book_vite_2.md\":\"6a7ce4e8\",\"book_vite_1.md\":\"62ad9d99\",\"book_vite_16.md\":\"4bfbd572\",\"book_webpack_15.md\":\"e0333a68\",\"book_webpack_2.md\":\"3127b212\",\"book_webpack_3.md\":\"50be4f51\",\"book_webpack_index.md\":\"c8119075\",\"core_events_index.md\":\"7aa64f07\",\"core_stream_index.md\":\"4838a299\",\"blog_translate_fs-in-node.md\":\"705f1ad1\",\"core_stream_stream-in-practice.md\":\"33d45bd7\",\"framework_nestjs_index.md\":\"2d68a237\",\"index.md\":\"08b5552d\",\"lib_fs-extra_copy.md\":\"fd1f602e\",\"lib_fs-extra_emptydir.md\":\"52257059\",\"lib_fs-extra_ensuredir.md\":\"9a1578e7\",\"lib_fs-extra_ensurefile.md\":\"25b05437\",\"lib_fs-extra_ensurelink.md\":\"a4c4da30\",\"lib_fs-extra_ensuresymlink.md\":\"3bdc433c\",\"lib_fs-extra_fs-write-read-writev.md\":\"e71d0db4\",\"lib_fs-extra_index.md\":\"e9881e6d\",\"blog_first.md\":\"09eafac5\",\"blog_misc_module.md\":\"c2ea2578\",\"blog_misc_ts-and-express.md\":\"aa276f8c\",\"blog_resource_advanced.md\":\"bc2e4adc\",\"blog_resource_basic.md\":\"1a214c06\",\"blog_dive_index.md\":\"1f9fd6eb\",\"core_stream_stream-visualization.md\":\"774d9db4\",\"framework_express_index.md\":\"8dfda6c5\",\"blog_translate_file-system-paths.md\":\"a6fb21b1\"}")
__VP_SITE_DATA__ = JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Awesome Node\",\"description\":\"Node + Vite + Webpack + Babel\",\"base\":\"/awesome-node/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"logo\":\"/logo.svg\",\"outlineTitle\":\"目录\",\"outline\":[2,3],\"editLink\":{\"text\":\"在GitHub编辑此页\",\"pattern\":\"https://github.com/jamessawyer/awesome-node/edit/main/docs/:path\"},\"nav\":[{\"text\":\"📄Node文档\",\"activeMatch\":\"^/v18doc/\",\"link\":\"/v18doc/File-System\"},{\"text\":\"📦工程化\",\"link\":\"/manager/basic\"},{\"text\":\"💫核心概念\",\"link\":\"/core/stream/index\"},{\"text\":\"🤔blog\",\"link\":\"/blog/first\"},{\"text\":\"📚书籍\",\"items\":[{\"text\":\"Node Design Patterns\",\"link\":\"/book/patterns/the-node-platform\"},{\"text\":\"深入理解Vite\",\"link\":\"/book/vite/2\"},{\"text\":\"Webpack5核心原理\",\"link\":\"/book/webpack/1\"},{\"text\":\"Babel插件秘籍\",\"link\":\"/book/babel/2\"}]},{\"text\":\"🧑‍🚀框架\",\"items\":[{\"text\":\"NestJS\",\"link\":\"/framework/nestjs/index\"},{\"text\":\"Express\",\"link\":\"/framework/express/index\"}]},{\"text\":\"🔥常用库\",\"items\":[{\"text\":\"fs-extra\",\"link\":\"/lib/fs-extra/index\"}]}],\"sidebar\":{\"/v18doc/\":[{\"text\":\"Node v18.x 中文文档\",\"items\":[{\"text\":\"File System\",\"link\":\"/v18doc/File-System\"},{\"text\":\"Path\",\"link\":\"/v18doc/Path\"}]}],\"/manager/\":[{\"text\":\"基础知识\",\"items\":[{\"text\":\"package.json\",\"link\":\"/manager/basic\"},{\"text\":\"Vite学习\",\"link\":\"/manager/vite\"},{\"text\":\"Webpack学习\",\"link\":\"/manager/webpack\"},{\"text\":\"babel生态\",\"link\":\"/manager/babel\"}]},{\"text\":\"Recipe\",\"items\":[{\"text\":\"Node资源\",\"link\":\"/manager/recipe\"}]}],\"/core/\":[{\"text\":\"EventEmitter\",\"collapsible\":true,\"items\":[{\"text\":\"资源\",\"link\":\"/core/events/index\"}]},{\"text\":\"Streams\",\"collapsible\":true,\"items\":[{\"text\":\"资源\",\"link\":\"/core/stream/index\"},{\"text\":\"⚡Stream图解\",\"link\":\"/core/stream/stream-visualization\"},{\"text\":\"⚡Stream实战\",\"link\":\"/core/stream/stream-in-practice\"}]}],\"/blog/\":[{\"text\":\"资源\",\"items\":[{\"text\":\"Advanced\",\"link\":\"/blog/resource/advanced\"}]},{\"text\":\"🚀 好文翻译\",\"collapsible\":true,\"items\":[{\"text\":\"Path & URL的用法\",\"link\":\"/blog/translate/file-system-paths\"},{\"text\":\"FS in Node\",\"link\":\"/blog/translate/fs-in-node\"},{\"text\":\"Web Streams on Node\",\"link\":\"/blog/translate/web-streams-on-node\"}]},{\"text\":\"MISC\",\"collapsible\":true,\"items\":[{\"text\":\"ESM & CJS模块\",\"link\":\"/blog/misc/module\"},{\"text\":\"Express + typescript设置\",\"link\":\"/blog/misc/ts-and-express\"}]}],\"/book/patterns\":[{\"text\":\"Node设计模式\",\"items\":[{\"text\":\"the node platform\",\"link\":\"/book/patterns/the-node-platform\"},{\"text\":\"callback and events\",\"link\":\"/book/patterns/callback-and-events\"}]},{\"text\":\"Ⅱ.模块系统\",\"collapsible\":true,\"items\":[{\"text\":\"介绍\",\"link\":\"/book/patterns/module-system/index\"},{\"text\":\"模块系统的必要性\",\"link\":\"/book/patterns/module-system/the-need-for-modules\"},{\"text\":\"JS和Node中的模块系统\",\"link\":\"/book/patterns/module-system/module-system-in-js-and-node\"},{\"text\":\"模块系统和其模式\",\"link\":\"/book/patterns/module-system/the-module-system-and-its-patterns\"},{\"text\":\"⚡CommonJS模块\",\"link\":\"/book/patterns/module-system/commonjs-modules\"},{\"text\":\"🙆‍♀️CommonJS模块常用模式定义\",\"link\":\"/book/patterns/module-system/module-define-patterns\"},{\"text\":\"🚀ESM\",\"link\":\"/book/patterns/module-system/esm\"},{\"text\":\"🚀ESM和CJS差异和互操性\",\"link\":\"/book/patterns/module-system/esm-cjs-interoperability\"},{\"text\":\"总结\",\"link\":\"/book/patterns/module-system/summary\"}]}],\"/book/vite\":[{\"text\":\"🔧深入理解Vite\",\"items\":[{\"text\":\"1.Vite开篇\",\"link\":\"/book/vite/1\"},{\"text\":\"2.模块标准\",\"link\":\"/book/vite/2\"},{\"text\":\"3.快速上手Vite\",\"link\":\"/book/vite/3\"},{\"text\":\"4.样式方案\",\"link\":\"/book/vite/4\"},{\"text\":\"7.预构建\",\"link\":\"/book/vite/7\"},{\"text\":\"8.双引擎架构\",\"link\":\"/book/vite/8\"},{\"text\":\"9.性能推手: Esbuild\",\"link\":\"/book/vite/9\"},{\"text\":\"10.Rollup基本用法\",\"link\":\"/book/vite/10\"},{\"text\":\"11.深入理解Rollup插件机制\",\"link\":\"/book/vite/11\"},{\"text\":\"12.Vite插件开发\",\"link\":\"/book/vite/12\"},{\"text\":\"14.代码分割\",\"link\":\"/book/vite/14\"},{\"text\":\"15.Polyfill和语法降级\",\"link\":\"/book/vite/15\"},{\"text\":\"16.Vite搭建SSR工程\",\"link\":\"/book/vite/16\"},{\"text\":\"17.联邦模块以及原理\",\"link\":\"/book/vite/17\"},{\"text\":\"18.Pure ESM时代\",\"link\":\"/book/vite/18\"},{\"text\":\"19.系统对Vite项目性能优化\",\"link\":\"/book/vite/19\"}]}],\"/book/webpack\":[{\"text\":\"Webpack5核心原理与实践\",\"items\":[{\"text\":\"1.重新认识Webpack\",\"link\":\"/book/webpack/1\"},{\"text\":\"2.如何理解Webpack配置底层结构逻辑？\",\"link\":\"/book/webpack/2\"},{\"text\":\"3.配置Babel+TS+ESLint？\",\"link\":\"/book/webpack/3\"},{\"text\":\"10.深入理解图像加载原理和最佳实践\",\"link\":\"/book/webpack/10\"},{\"text\":\"11.深入理解webpack核心配置📚\",\"link\":\"/book/webpack/11\"},{\"text\":\"13.如何使用webpack缓存提升性能⚡\",\"link\":\"/book/webpack/13\"},{\"text\":\"15.应用性能极致优化技巧⚡\",\"link\":\"/book/webpack/15\"},{\"text\":\"16.使用SplitChunk提升性能⚡\",\"link\":\"/book/webpack/16\"}]}],\"/book/babel\":[{\"text\":\"Babel插件秘籍\",\"items\":[{\"text\":\"1.Babel的介绍\",\"link\":\"/book/babel/1\"},{\"text\":\"2.Babel的编译流程\",\"link\":\"/book/babel/2\"},{\"text\":\"3.Babel的AST\",\"link\":\"/book/babel/3\"},{\"text\":\"4.Babel的API\",\"link\":\"/book/babel/4\"},{\"text\":\"5.实战：插入函数调用参数\",\"link\":\"/book/babel/5\"},{\"text\":\"6.JS Parser的历史\",\"link\":\"/book/babel/6\"}]}],\"/lib/fs-extra\":[{\"text\":\"fs-extra\",\"items\":[{\"text\":\"README\",\"link\":\"/lib/fs-extra/index\"},{\"text\":\"copy\",\"link\":\"/lib/fs-extra/copy\"},{\"text\":\"emptyDir\",\"link\":\"/lib/fs-extra/emptyDir\"},{\"text\":\"ensureFile\",\"link\":\"/lib/fs-extra/ensureFile\"},{\"text\":\"ensureDir\",\"link\":\"/lib/fs-extra/ensureDir\"},{\"text\":\"ensureLink\",\"link\":\"/lib/fs-extra/ensureLink\"},{\"text\":\"ensureSymlink\",\"link\":\"/lib/fs-extra/ensureSymlink\"},{\"text\":\"move\",\"link\":\"/lib/fs-extra/move\"},{\"text\":\"outputFile\",\"link\":\"/lib/fs-extra/outputFile\"},{\"text\":\"pathExists\",\"link\":\"/lib/fs-extra/pathExists\"},{\"text\":\"readJson\",\"link\":\"/lib/fs-extra/readJson\"},{\"text\":\"remove\",\"link\":\"/lib/fs-extra/remove\"},{\"text\":\"outputJson\",\"link\":\"/lib/fs-extra/outputJson\"},{\"text\":\"writeJson\",\"link\":\"/lib/fs-extra/writeJson\"},{\"text\":\"fs-write-read-writev\",\"link\":\"/lib/fs-extra/fs-write-read-writev\"}]}],\"/framework/nestjs\":[{\"text\":\"学习NestJS\",\"items\":[{\"text\":\"资源\",\"link\":\"/framework/nestjs/index\"}]}],\"/framework/express\":[{\"text\":\"Learn ExpressJS\",\"items\":[{\"text\":\"资源\",\"link\":\"/framework/express/index\"}]}]}},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}")</script>
    
  </body>
</html>
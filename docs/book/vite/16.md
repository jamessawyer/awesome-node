---
title: Vite SSR
---

åœ¨éå¸¸æ—©æœŸçš„ Web æŠ€æœ¯ä¸­ï¼Œå¤§å®¶è¿˜æ˜¯ä½¿ç”¨ JSP è¿™ç§å¤è€çš„æ¨¡æ¿è¯­æ³•æ¥ç¼–å†™å‰ç«¯çš„é¡µé¢ï¼Œç„¶åç›´æ¥å°† JSP æ–‡ä»¶æ”¾åˆ°æœåŠ¡ç«¯ï¼Œåœ¨æœåŠ¡ç«¯å¡«å…¥æ•°æ®å¹¶æ¸²æŸ“å‡ºå®Œæ•´çš„é¡µé¢å†…å®¹ï¼Œå¯ä»¥è¯´é‚£ä¸ªæ—¶ä»£çš„åšæ³•æ˜¯å¤©ç„¶çš„æœåŠ¡ç«¯æ¸²æŸ“ã€‚ä½†éšç€ AJAX æŠ€æœ¯çš„æˆç†Ÿä»¥åŠå„ç§å‰ç«¯æ¡†æ¶(å¦‚ Vueã€React)çš„å…´èµ·ï¼Œå‰åç«¯åˆ†ç¦»çš„å¼€å‘æ¨¡å¼é€æ¸æˆä¸ºå¸¸æ€ï¼Œå‰ç«¯åªè´Ÿè´£é¡µé¢ UI åŠé€»è¾‘çš„å¼€å‘ï¼Œè€ŒæœåŠ¡ç«¯åªè´Ÿè´£æä¾›æ•°æ®æ¥å£ï¼Œè¿™ç§å¼€å‘æ–¹å¼ä¸‹çš„é¡µé¢æ¸²æŸ“ä¹Ÿå«`å®¢æˆ·ç«¯æ¸²æŸ“`(Client Side Renderï¼Œç®€ç§° CSR)ã€‚

ä½†å®¢æˆ·ç«¯æ¸²æŸ“ä¹Ÿå­˜åœ¨ç€ä¸€å®šçš„é—®é¢˜ï¼Œä¾‹å¦‚é¦–å±åŠ è½½æ¯”è¾ƒæ…¢ã€å¯¹ SEO ä¸å¤ªå‹å¥½ï¼Œå› æ­¤ SSR (Server Side Render)å³æœåŠ¡ç«¯æ¸²æŸ“æŠ€æœ¯åº”è¿è€Œç”Ÿï¼Œå®ƒåœ¨ä¿ç•™ CSR æŠ€æœ¯æ ˆçš„åŒæ—¶ï¼Œä¹Ÿèƒ½è§£å†³ CSR çš„å„ç§é—®é¢˜ã€‚

è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥èŠèŠSSRï¼Œè¯´è¯´å®ƒçš„åŸºæœ¬åŸç†ï¼Œä»¥åŠå¦‚ä½•å€ŸåŠ© Vite çš„å„é¡¹æ„å»ºèƒ½åŠ›å®ç° SSRï¼Œè®©ä½ ä½“ä¼šåˆ° SSR çš„å„ä¸ªç”Ÿå‘½å‘¨æœŸæ˜¯å¦‚ä½•ä¸²è”èµ·æ¥çš„ã€‚

::: info

éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæœ¬èŠ‚æœ€ç»ˆçš„ç›®çš„å¹¶ä¸æ˜¯è®©å¤§å®¶å­¦ä¹ æŸä¸ªç°æœ‰çš„ SSR è§£å†³æ–¹æ¡ˆ(å¦‚ Nuxt)ï¼Œæˆ–è€…ç®€å•äº†è§£ä¸€ä¸‹å®ç°åŸç†ï¼Œè€Œæ˜¯æ•™å¤§å®¶å¦‚ä½•ä»åº•å±‚å¼€å§‹æ‰‹åŠ¨æ­å»ºä¸€ä¸ªå¯ä»¥æ·±åº¦å®šåˆ¶çš„ SSR é¡¹ç›®ï¼Œå¹¶ä¸”è§£å†³å„ç§ SSR ä¸­çš„å·¥ç¨‹åŒ–é—®é¢˜ã€‚

:::



## SSR åŸºæœ¬æ¦‚å¿µ

é¦–å…ˆæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ CSR çš„é—®é¢˜ï¼Œå®ƒçš„ HTML äº§ç‰©ä¸€èˆ¬æ˜¯å¦‚ä¸‹çš„ç»“æ„:

```html {9,11}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title></title>
  <link rel="stylesheet" href="xxx.css" />
</head>
<body>
  <!-- ä¸€å¼€å§‹æ²¡æœ‰é¡µé¢å†…å®¹ -->
  <div id="root"></div>
  <!-- é€šè¿‡ JS æ‰§è¡Œæ¥æ¸²æŸ“é¡µé¢ -->
  <script src="xxx.chunk.js"></script>
</body>
</html>

```

é¡ºä¾¿æˆ‘ä»¬ä¹Ÿå›é¡¾ä¸€ä¸‹æµè§ˆå™¨çš„æ¸²æŸ“æµç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

![browseræ¸²æŸ“æµç¨‹](./imgs/16-1.webp)

å½“æµè§ˆå™¨æ‹¿åˆ°å¦‚ä¸Šçš„ HTML å†…å®¹ä¹‹åï¼Œå…¶å®å¹¶ä¸èƒ½æ¸²æŸ“å®Œæ•´çš„é¡µé¢å†…å®¹ï¼Œå› ä¸ºæ­¤æ—¶çš„ body ä¸­åŸºæœ¬åªæœ‰ä¸€ä¸ªç©ºçš„ div èŠ‚ç‚¹ï¼Œå¹¶æ²¡æœ‰å¡«å…¥çœŸæ­£çš„é¡µé¢å†…å®¹ã€‚è€Œæ¥ä¸‹æ¥æµè§ˆå™¨å¼€å§‹ä¸‹è½½å¹¶æ‰§è¡Œ JS ä»£ç ï¼Œç»å†äº†æ¡†æ¶åˆå§‹åŒ–ã€æ•°æ®è¯·æ±‚ã€DOM æ’å…¥ç­‰æ“ä½œä¹‹åæ‰èƒ½æ¸²æŸ“å‡ºå®Œæ•´çš„é¡µé¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ CSR ä¸­å®Œæ•´çš„é¡µé¢å†…å®¹æœ¬è´¨ä¸Šé€šè¿‡ JS ä»£ç æ‰§è¡Œä¹‹åæ‰èƒ½å¤Ÿæ¸²æŸ“ã€‚è¿™ä¸»è¦ä¼šå¯¼è‡´ä¸¤ä¸ªæ–¹é¢çš„é—®é¢˜:

1. **é¦–å±åŠ è½½é€Ÿåº¦æ¯”è¾ƒæ…¢**ã€‚é¦–å±åŠ è½½éœ€è¦ä¾èµ– JS çš„æ‰§è¡Œï¼Œä¸‹è½½å’Œæ‰§è¡Œ JS éƒ½å¯èƒ½æ˜¯éå¸¸è€—æ—¶çš„æ“ä½œï¼Œå°¤å…¶æ˜¯åœ¨ä¸€äº›ç½‘ç»œä¸ä½³çš„åœºæ™¯ï¼Œæˆ–è€…æ€§èƒ½æ•æ„Ÿçš„ä½ç«¯æœºä¸‹ã€‚
2. **å¯¹ SEO(æœç´¢å¼•æ“ä¼˜åŒ–) ä¸å‹å¥½**ã€‚é¡µé¢ HTML æ²¡æœ‰å…·ä½“çš„é¡µé¢å†…å®¹ï¼Œå¯¼è‡´æœç´¢å¼•æ“çˆ¬è™«æ— æ³•è·å–å…³é”®è¯ä¿¡æ¯ï¼Œå¯¼è‡´ç½‘ç«™æ’åå—åˆ°å½±å“ã€‚

é‚£ä¹ˆ SSR æ˜¯å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„å‘¢ï¼Ÿ

åœ¨ SSR çš„åœºæ™¯ä¸‹ï¼ŒæœåŠ¡ç«¯ç”Ÿæˆå¥½**å®Œæ•´çš„ HTML å†…å®¹**ï¼Œç›´æ¥è¿”å›ç»™æµè§ˆå™¨ï¼Œæµè§ˆå™¨èƒ½å¤Ÿæ ¹æ® HTML æ¸²æŸ“å‡ºå®Œæ•´çš„é¦–å±å†…å®¹ï¼Œè€Œä¸éœ€è¦ä¾èµ– JS çš„åŠ è½½ï¼Œè¿™æ ·ä¸€æ–¹é¢èƒ½å¤Ÿé™ä½é¦–å±æ¸²æŸ“çš„æ—¶é—´ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿèƒ½å°†å®Œæ•´çš„é¡µé¢å†…å®¹å±•ç°ç»™æœç´¢å¼•æ“çš„çˆ¬è™«ï¼Œåˆ©äº SEOã€‚

å½“ç„¶ï¼ŒSSR ä¸­åªèƒ½ç”Ÿæˆé¡µé¢çš„å†…å®¹å’Œç»“æ„ï¼Œå¹¶ä¸èƒ½å®Œæˆäº‹ä»¶ç»‘å®šğŸ“šï¼Œå› æ­¤éœ€è¦åœ¨æµè§ˆå™¨ä¸­æ‰§è¡Œ CSR çš„ JS è„šæœ¬ï¼Œå®Œæˆäº‹ä»¶ç»‘å®šï¼Œè®©é¡µé¢æ‹¥æœ‰äº¤äº’çš„èƒ½åŠ›ï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä½œ`hydrate`(ç¿»è¯‘ä¸º`æ³¨æ°´`æˆ–è€…`æ¿€æ´»`)ã€‚åŒæ—¶ï¼Œåƒè¿™æ ·æœåŠ¡ç«¯æ¸²æŸ“ + å®¢æˆ·ç«¯ hydrate çš„åº”ç”¨ä¹Ÿè¢«ç§°ä¸º`åŒæ„åº”ç”¨`ã€‚



## SSR ç”Ÿå‘½å‘¨æœŸåˆ†æ

å‰é¢æˆ‘ä»¬æåˆ°äº† SSR ä¼šåœ¨æœåŠ¡ç«¯(è¿™é‡Œä¸»è¦æŒ‡ Node.js ç«¯)æå‰æ¸²æŸ“å‡ºå®Œæ•´çš„ HTML å†…å®¹ï¼Œé‚£è¿™æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ

é¦–å…ˆéœ€è¦ä¿è¯å‰ç«¯çš„ä»£ç ç»è¿‡ç¼–è¯‘åæ”¾åˆ°æœåŠ¡ç«¯ä¸­èƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œï¼Œå…¶æ¬¡åœ¨æœåŠ¡ç«¯æ¸²æŸ“å‰ç«¯ç»„ä»¶ï¼Œç”Ÿæˆå¹¶ç»„è£…åº”ç”¨çš„ HTMLã€‚è¿™å°±æ¶‰åŠåˆ° SSR åº”ç”¨çš„ä¸¤å¤§ç”Ÿå‘½å‘¨æœŸ: `æ„å»ºæ—¶`å’Œ`è¿è¡Œæ—¶`ï¼Œæˆ‘ä»¬ä¸å¦¨æ¥ä»”ç»†æ¢³ç†ä¸€ä¸‹ã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹`æ„å»ºæ—¶`éœ€è¦åšå“ªäº›äº‹æƒ…:

1. **è§£å†³æ¨¡å—åŠ è½½é—®é¢˜**ã€‚åœ¨åŸæœ‰çš„æ„å»ºè¿‡ç¨‹ä¹‹å¤–ï¼Œéœ€è¦åŠ å…¥`SSR æ„å»º`çš„è¿‡ç¨‹ ï¼Œå…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦å¦å¤–ç”Ÿæˆä¸€ä»½ `CommonJS` æ ¼å¼çš„äº§ç‰©ï¼Œä½¿ä¹‹èƒ½åœ¨ Node.js æ­£å¸¸åŠ è½½ã€‚å½“ç„¶ï¼Œéšç€ Node.js æœ¬èº«å¯¹ ESM çš„æ”¯æŒè¶Šæ¥è¶Šæˆç†Ÿï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¤ç”¨å‰ç«¯ ESM æ ¼å¼çš„ä»£ç ï¼ŒVite åœ¨å¼€å‘é˜¶æ®µè¿›è¡Œ SSR æ„å»ºä¹Ÿæ˜¯è¿™æ ·çš„æ€è·¯ã€‚

   ![SSRæ„å»ºæµç¨‹](./imgs/16-2.webp)

2. **ç§»é™¤æ ·å¼ä»£ç çš„å¼•å…¥**ã€‚ç›´æ¥å¼•å…¥ä¸€è¡Œ css åœ¨æœåŠ¡ç«¯å…¶å®æ˜¯æ— æ³•æ‰§è¡Œçš„ï¼Œå› ä¸º Node.js å¹¶ä¸èƒ½è§£æ CSS çš„å†…å®¹ã€‚ä½† `CSS Modules` çš„æƒ…å†µé™¤å¤–ï¼Œå¦‚ä¸‹æ‰€ç¤º:

   ```js
   import styles from './index.module.css'
   
   // è¿™é‡Œçš„ styles æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚{ "container": "xxx" }ï¼Œè€Œä¸æ˜¯ CSS ä»£ç 
   console.log(styles)
   ```

3. **ä¾èµ–å¤–éƒ¨åŒ–(external)**ã€‚å¯¹äºæŸäº›ç¬¬ä¸‰æ–¹ä¾èµ–æˆ‘ä»¬å¹¶ä¸éœ€è¦ä½¿ç”¨æ„å»ºåçš„ç‰ˆæœ¬ï¼Œè€Œæ˜¯ç›´æ¥ä» `node_modules` ä¸­è¯»å–ï¼Œæ¯”å¦‚ `react-dom`ï¼Œè¿™æ ·åœ¨ `SSR æ„å»º`çš„è¿‡ç¨‹ä¸­å°†ä¸ä¼šæ„å»ºè¿™äº›ä¾èµ–ï¼Œä»è€Œæå¤§ç¨‹åº¦ä¸ŠåŠ é€Ÿ SSR çš„æ„å»ºã€‚

å¯¹äº SSR çš„è¿è¡Œæ—¶ï¼Œä¸€èˆ¬å¯ä»¥æ‹†åˆ†ä¸ºæ¯”è¾ƒå›ºå®šçš„ç”Ÿå‘½å‘¨æœŸé˜¶æ®µï¼Œç®€å•æ¥è®²å¯ä»¥æ•´ç†ä¸ºä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒçš„é˜¶æ®µ:

![SSR4å¤§ç”Ÿå‘½å‘¨æœŸ](./imgs/16-3.webp)

1. **åŠ è½½ SSR å…¥å£æ¨¡å—**ã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®š SSR æ„å»ºäº§ç‰©çš„å…¥å£ï¼Œå³ç»„ä»¶çš„å…¥å£åœ¨å“ªé‡Œï¼Œå¹¶åŠ è½½å¯¹åº”çš„æ¨¡å—ã€‚
2. **è¿›è¡Œæ•°æ®é¢„å–**ã€‚è¿™æ—¶å€™ Node ä¾§ä¼šé€šè¿‡æŸ¥è¯¢æ•°æ®åº“æˆ–è€…ç½‘ç»œè¯·æ±‚æ¥è·å–åº”ç”¨æ‰€éœ€çš„æ•°æ®ã€‚
3. **æ¸²æŸ“ç»„ä»¶**ã€‚è¿™ä¸ªé˜¶æ®µä¸º SSR çš„æ ¸å¿ƒï¼Œä¸»è¦å°†ç¬¬ `1` æ­¥ä¸­åŠ è½½çš„ç»„ä»¶æ¸²æŸ“æˆ HTML å­—ç¬¦ä¸²æˆ–è€… Stream æµã€‚
4. **HTML æ‹¼æ¥**ã€‚åœ¨ç»„ä»¶æ¸²æŸ“å®Œæˆä¹‹åï¼Œæˆ‘ä»¬éœ€è¦æ‹¼æ¥å®Œæ•´çš„ HTML å­—ç¬¦ä¸²ï¼Œå¹¶å°†å…¶ä½œä¸ºå“åº”è¿”å›ç»™æµè§ˆå™¨ã€‚

ä»ä¸Šé¢çš„åˆ†æä¸­ä½ å¯ä»¥å‘ç°ï¼ŒSSR å…¶å®æ˜¯`æ„å»º`å’Œ`è¿è¡Œæ—¶`äº’ç›¸é…åˆæ‰èƒ½å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»…é æ„å»ºå·¥å…·æ˜¯ä¸å¤Ÿçš„ï¼Œå†™ä¸€ä¸ª Vite æ’ä»¶ä¸¥æ ¼æ„ä¹‰ä¸Šæ— æ³•å®ç° SSR çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ Vite çš„æ„å»ºæµç¨‹åšä¸€äº›æ•´ä½“çš„è°ƒæ•´ï¼Œå¹¶ä¸”åŠ å…¥ä¸€äº›æœåŠ¡ç«¯è¿è¡Œæ—¶çš„é€»è¾‘æ‰èƒ½å®ç°ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä»¥å…·ä½“çš„ä»£ç ç¤ºä¾‹æ¥è®²è§£å¦‚ä½•åœ¨ Vite ä¸­å®Œæˆ SSR å·¥ç¨‹çš„æ­å»ºã€‚



## åŸºäº Vite æ­å»º SSR é¡¹ç›®



### 1. SSR æ„å»º API

é¦–å…ˆ Vite ä½œä¸ºä¸€ä¸ªæ„å»ºå·¥å…·ï¼Œæ˜¯å¦‚ä½•æ”¯æŒ SSR æ„å»ºçš„å‘¢ï¼Ÿæ¢å¥è¯è¯´ï¼Œå®ƒæ˜¯å¦‚ä½•è®©å‰ç«¯çš„ä»£ç ä¹Ÿèƒ½é¡ºåˆ©åœ¨ Node.js ä¸­æˆåŠŸè·‘èµ·æ¥çš„å‘¢ï¼Ÿ

å¯ä»¥åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼ŒVite ä¾ç„¶ç§‰æ‰¿ ESM æ¨¡å—æŒ‰éœ€åŠ è½½å³ `no-bundle`çš„ç†å¿µï¼Œå¯¹å¤–æä¾›äº†`ssrLoadModule` APIï¼Œä½ å¯ä»¥æ— éœ€æ‰“åŒ…é¡¹ç›®ï¼Œå°†å…¥å£æ–‡ä»¶çš„è·¯å¾„ä¼ å…¥`ssrLoadModule` å³å¯:

```tsx
// åŠ è½½æœåŠ¡ç«¯å…¥å£æ¨¡å—
const xxx = await vite.ssrLoadModule('/src/entry-server.tsx')
```

è€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼ŒVite ä¼šé»˜è®¤è¿›è¡Œæ‰“åŒ…ï¼Œå¯¹äº SSR æ„å»ºè¾“å‡º CommonJS æ ¼å¼çš„äº§ç‰©ã€‚æˆ‘ä»¬å¯ä»¥åœ¨`package.json`ä¸­åŠ å…¥è¿™æ ·ç±»ä¼¼çš„æ„å»ºæŒ‡ä»¤:

```json
{
  "build:ssr": "vite build --ssr æœåŠ¡ç«¯å…¥å£è·¯å¾„"
}
```

è¿™æ · Vite ä¼šä¸“é—¨ä¸º SSR æ‰“åŒ…å‡ºä¸€ä»½æ„å»ºäº§ç‰©ã€‚å› æ­¤ä½ å¯ä»¥çœ‹åˆ°ï¼Œå¤§éƒ¨åˆ† SSR æ„å»ºæ—¶çš„äº‹æƒ…ï¼ŒVite å·²ç»å¸®æˆ‘ä»¬æä¾›äº†å¼€ç®±å³ç”¨çš„æ–¹æ¡ˆï¼Œæˆ‘ä»¬åç»­ç›´æ¥ä½¿ç”¨å³å¯ã€‚



### 2. é¡¹ç›®éª¨æ¶æ­å»º

æ¥ä¸‹æ¥æˆ‘ä»¬æ­£å¼å¼€å§‹ SSR é¡¹ç›®çš„æ­å»ºï¼Œä½ å¯ä»¥é€šè¿‡è„šæ‰‹æ¶åˆå§‹åŒ–ä¸€ä¸ª`react+ts`çš„é¡¹ç›®:

```bash
 pnpm create vite@latest vite-react-ssr --template react-ts
 cd vite-react-ssr
 pnpm install
```

::: info

æ­¤å¤„ä½¿ç”¨çš„æ˜¯React `v18+`ï¼ŒåŸå°å†Œä½¿ç”¨çš„ `v17+` ç‰ˆæœ¬ï¼Œç¨æœ‰ä¸åŒã€‚

:::

åˆ é™¤é¡¹ç›®è‡ªå¸¦çš„`src/main.ts`ï¼Œç„¶ååœ¨ src ç›®å½•ä¸‹æ–°å»º`entry-client.tsx`å’Œ`entry-server.tsx`ä¸¤ä¸ªå…¥å£æ–‡ä»¶:

::: code-group

``` typescript [entry-client.tsx]
// å®¢æˆ·ç«¯å…¥å£æ–‡ä»¶
import React from 'react'
import { hydrateRoot } from 'react-dom/client'
import './index.css'
import App from './App'


hydrateRoot(
  document.getElementById('root')!,
  <App />
)
```

``` typescript [entry-server.tsx]
import App from './App'
import './index.css'

function ServerEntry(props: any) {
  return (
    <App />
  )
}

export { ServerEntry }
```

:::



æˆ‘ä»¬ä»¥ Express æ¡†æ¶ä¸ºä¾‹æ¥å®ç° Node åç«¯æœåŠ¡ï¼Œåç»­çš„ SSR é€»è¾‘ä¼šæ¥å…¥åˆ°è¿™ä¸ªæœåŠ¡ä¸­ã€‚å½“ç„¶ä½ éœ€è¦å®‰è£…ä»¥ä¸‹çš„ä¾èµ–:

```bash
pnpm i express -S
pnpm i @types/express -D
```

æ¥ç€æ–°å»º`src/ssr-server/index.ts`:

```typescript
// src/ssr-server/index.ts
// åç«¯æœåŠ¡
import express from 'express';

async function createServer() {
  const app = express();
  
  app.listen(3000, () => {
    console.log('Node æœåŠ¡å™¨å·²å¯åŠ¨~')
    console.log('http://localhost:3000');
  });
}

createServer();
```

ç„¶åä½ å¯ä»¥åœ¨`package.json`ä¸­æ·»åŠ å¦‚ä¸‹çš„ `scripts`:

::: code-group

``` json [package.json]
{
  "scripts": {
    // å¼€å‘é˜¶æ®µå¯åŠ¨ SSR çš„åç«¯æœåŠ¡
    "dev": "nodemon --watch src/ssr-server --exec 'tsx src/ssr-server/index.ts'",
    // æ‰“åŒ…å®¢æˆ·ç«¯äº§ç‰©å’Œ SSR äº§ç‰©
    "build": "pnpm run build:client && pnpm run build:server",
    "build:client": "vite build --outDir dist/client",
    "build:server": "vite build --ssr src/entry-server.tsx --outDir dist/server",
    // ç”Ÿäº§ç¯å¢ƒé¢„è§ˆ SSR æ•ˆæœ
    "preview": "NODE_ENV=production tsx src/ssr-server/index.ts"
  },
}
```

:::

å…¶ä¸­è®¾è®¡åˆ°ä¸¤ä¸ªé¢å¤–çš„å·¥å…·ï¼Œç»™å¤§å®¶è§£é‡Šä¸€ä¸‹:

1. `nodemon`: ä¸€ä¸ªç›‘å¬æ–‡ä»¶å˜åŒ–è‡ªåŠ¨é‡å¯ Node æœåŠ¡çš„å·¥å…·ã€‚
2. [tsx](https://github.com/esbuild-kit/tsx):  ç±»ä¼¼ `ts-node` çš„å·¥å…·ï¼Œç”¨æ¥æ‰§è¡Œ ts æ–‡ä»¶ï¼Œåº•å±‚åŸºäº Esbuild å®ç°ã€‚

åŒæ—¶ä½ ä¹Ÿéœ€è¦å®‰è£…è¿™ä¸¤ä¸ªä¾èµ–:

```bash
pnpm i -D nodemon tsx
```

OKï¼Œç°åœ¨æˆ‘ä»¬å°±åŸºæœ¬ä¸Šæ­å»ºå¥½äº†åŸºæœ¬çš„é¡¹ç›®éª¨æ¶ï¼Œæ¥ä¸‹é‡Œæˆ‘ä»¬ä¸“æ³¨äº SSR è¿è¡Œæ—¶çš„å®ç°é€»è¾‘å³å¯ã€‚



### 3. SSR è¿è¡Œæ—¶å®ç°

SSR ä½œä¸ºä¸€ç§ç‰¹æ®Šçš„åç«¯æœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶å°è£…æˆä¸€ä¸ªä¸­é—´ä»¶çš„å½¢å¼ï¼Œå¦‚ä»¥ä¸‹çš„ä»£ç æ‰€ç¤º:

::: code-group

``` typescript [ssr-server/index.ts]
import express, { RequestHandler, Express } from 'express';
import {
  ViteDevServer,
  createServer as createViteServer
} from 'vite';

const isProd = process.env.NODE_ENV === 'production';
const cwd = process.cwd();

async function createSsrMiddleware(app: Express): Promise<RequestHandler> {
  let vite: ViteDevServer | null = null;
  if (!isProd) {
    // ğŸ“š
    // https://cn.vitejs.dev/config/server-options.html#server-middlewaremode
    vite = await createViteServer({
      root: process.cwd(),
      server: {
        middlewareMode: true,
      },
      appType: 'custom' // ä¸å¼•å…¥ Vite é»˜è®¤çš„ HTML å¤„ç†ä¸­é—´ä»¶
    })
    
    // å°† vite çš„ connect å®ä¾‹ä½œä¸­é—´ä»¶ä½¿ç”¨
    // æ³¨å†Œ Vite Middlewares
    // ä¸»è¦ç”¨æ¥å¤„ç†å®¢æˆ·ç«¯èµ„æº
    app.use(vite.middlewares);
  }
  return async (req, res, next) => {
    // SSR çš„é€»è¾‘
    // 1. åŠ è½½æœåŠ¡ç«¯å…¥å£æ¨¡å—
    // 2. æ•°æ®é¢„å–
    // 3. ã€Œæ ¸å¿ƒã€æ¸²æŸ“ç»„ä»¶
    // 4. æ‹¼æ¥ HTMLï¼Œè¿”å›å“åº”
  };
}

async function createServer() {
  const app = express();
  // åŠ å…¥ Vite SSR ä¸­é—´ä»¶
  app.use(await createSsrMiddleware(app));

  app.listen(3000, () => {
    console.log('Node æœåŠ¡å™¨å·²å¯åŠ¨~')
    console.log('http://localhost:3000');
  });
}

createServer();
```

:::

æ¥ä¸‹æ¥æˆ‘ä»¬æŠŠç„¦ç‚¹æ”¾åœ¨ä¸­é—´ä»¶å†… SSR çš„é€»è¾‘å®ç°ä¸Šï¼Œé¦–å…ˆå®ç°ç¬¬ä¸€æ­¥å³`åŠ è½½æœåŠ¡ç«¯å…¥å£æ¨¡å—`:

::: code-group

``` typescript [ssr-server/index.ts]
// ...
import path from 'node:path'

// çœç•¥å…¶ä½™éƒ¨åˆ†...

// 1. åŠ è½½æœåŠ¡ç«¯å…¥å£æ¨¡å—
async function loadSsrEntryModule(vite: ViteDevServer | null) {
  if (isProd) {  // ç”Ÿäº§æ¨¡å¼ä¸‹ç›´æ¥ require æ‰“åŒ…åçš„äº§ç‰©
    const entryPath = path.join(cwd, 'dist/server/entry-server.js')
    return import(entryPath)
  } else { // å¼€å‘ç¯å¢ƒä¸‹é€šè¿‡ no-bundle æ–¹å¼åŠ è½½
    const entryPath = path.join(cwd, 'src/entry-server.tsx')
    return vite!.ssrLoadModule(entryPath)
  }
}
```

:::

ä¸­é—´ä»¶å†…çš„é€»è¾‘å¦‚ä¸‹:

::: code-group

``` typescript [ssr-server/index.ts]
async function createSsrMiddleware(app: Express): Promise<RequestHandler> {
  // çœç•¥å‰é¢çš„ä»£ç 
  return async (req, res, next) => {
    const url = req.originalUrl;
    // 1. æœåŠ¡ç«¯å…¥å£åŠ è½½
    const { ServerEntry } = await loadSsrEntryModule(vite);
    // ...
  }
}
```

:::

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®ç°æœåŠ¡ç«¯çš„æ•°æ®é¢„å–æ“ä½œï¼Œä½ å¯ä»¥åœ¨`entry-server.tsx`ä¸­æ·»åŠ ä¸€ä¸ªç®€å•çš„è·å–æ•°æ®çš„å‡½æ•°:

::: code-group

``` typescript [entry-server.tsx]
import App from './App'
import './index.css'

export async function fetchData() { // [!code ++]
  return { user: 'xxx' } // [!code ++]
} // [!code ++]

function ServerEntry(props: any) {
  return (
    <App />
  )
}

export { ServerEntry }
```

:::

ç„¶ååœ¨ SSR ä¸­é—´ä»¶ä¸­å®Œæˆæ•°æ®é¢„å–çš„æ“ä½œ:

::: code-group

``` typescript [ssr-server/index.ts]
async function createSsrMiddleware(app: Express): Promise<RequestHandler> {
  // çœç•¥å‰é¢çš„ä»£ç 
  return async (req, res, next) => {
    const url = req.originalUrl;
    // 1. æœåŠ¡ç«¯å…¥å£åŠ è½½
    const { ServerEntry } = await loadSsrEntryModule(vite); // [!code --]
    const { ServerEntry, fetchData } = await loadSsrEntryModule(vite); // [!code ++]
    // 2. é¢„å–æ•°æ®
    const data = await fetchData(); // [!code ++]
    // ...
  }
}
```

:::

æ¥ç€æˆ‘ä»¬è¿›å…¥åˆ°æ ¸å¿ƒçš„ç»„ä»¶æ¸²æŸ“é˜¶æ®µ:

::: code-group

``` typescript [ssr-server/index.ts] {11}
// ...
import { renderToString } from 'react-dom/server'
import React from 'react'

async function createSsrMiddleware(app: Express): Promise<RequestHandler> {
  // çœç•¥å‰é¢çš„ä»£ç 
  return async (req, res, next) => {
    const url = req.originalUrl;
    // 1. æœåŠ¡ç«¯å…¥å£åŠ è½½
    const { ServerEntry, fetchData } = await loadSsrEntryModule(vite);
    // 2. é¢„å–æ•°æ®
    const data = await fetchData();
    // 3. ã€Œæ ¸å¿ƒã€æ¸²æŸ“ç»„ä»¶ - ç»„ä»¶æ¸²æŸ“ -> å­—ç¬¦ä¸²
    const appHtml = renderToString(React.createElement(ServerEntry, { data }))
    // ...
  }
}
```

:::

ç”±äºåœ¨ç¬¬ä¸€æ­¥ä¹‹åæˆ‘ä»¬æ‹¿åˆ°äº†å…¥å£ç»„ä»¶ï¼Œç°åœ¨å¯ä»¥è°ƒç”¨å‰ç«¯æ¡†æ¶çš„`renderToString`API å°†ç»„ä»¶æ¸²æŸ“ä¸ºå­—ç¬¦ä¸²ï¼Œç»„ä»¶çš„å…·ä½“å†…å®¹ä¾¿å°±æ­¤ç”Ÿæˆäº†ã€‚

OKï¼Œç›®å‰æˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†ç»„ä»¶çš„ HTML ä»¥åŠé¢„å–çš„æ•°æ®ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åœ¨æ ¹ç›®å½•ä¸‹çš„ HTML ä¸­æä¾›ç›¸åº”çš„æ’æ§½ï¼Œæ–¹ä¾¿å†…å®¹çš„æ›¿æ¢:

::: code-group

``` html [index.html] {10,12}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/src/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite App</title>
  </head>
  <body>
    <div id="root"><!-- SSR_APP --></div>
    <script type="module" src="/src/entry-client.tsx"></script>
    <!-- SSR_DATA -->
  </body>
</html>
```

:::

ç´§æ¥ç€æˆ‘ä»¬åœ¨ SSR ä¸­é—´ä»¶ä¸­è¡¥å…… HTML æ‹¼æ¥çš„é€»è¾‘:

::: code-group

``` typescript [ssr-server/index.ts] {20}
// ...
import fs from 'node:fs'

function resolveTemplatePath() {
  return isProd ?
    path.join(cwd, 'dist/client/index.html') :
    path.join(cwd, 'index.html');
}

async function createSsrMiddleware(app: Express): Promise<RequestHandler> {
  // çœç•¥å‰é¢çš„ä»£ç 
  return async (req, res, next) => {
    const url = req.originalUrl;
    // 1. æœåŠ¡ç«¯å…¥å£åŠ è½½
    const { ServerEntry, fetchData } = await loadSsrEntryModule(vite);
    // 2. é¢„å–æ•°æ®
    const data = await fetchData();
    // 3. ã€Œæ ¸å¿ƒã€æ¸²æŸ“ç»„ä»¶ - ç»„ä»¶æ¸²æŸ“ -> å­—ç¬¦ä¸²
    const appHtml = renderToString(React.createElement(ServerEntry, { data }))
    // 4. æ‹¼æ¥ HTMLï¼Œè¿”å›å“åº”
    const templatePath = resolveTemplatePath();
    let template = await fs.readFileSync(templatePath, 'utf-8');
    // å¼€å‘æ¨¡å¼ä¸‹éœ€è¦æ³¨å…¥ HMRã€ç¯å¢ƒå˜é‡ç›¸å…³çš„ä»£ç ï¼Œå› æ­¤éœ€è¦è°ƒç”¨ vite.transformIndexHtml
    if (!isProd && vite) {
      template = await vite.transformIndexHtml(url, template);
    }
    const html = template
      .replace('<!-- SSR_APP -->', appHtml)
      // æ³¨å…¥æ•°æ®æ ‡ç­¾ï¼Œç”¨äºå®¢æˆ·ç«¯ hydrate
      .replace(
        '<!-- SSR_DATA -->',
        `<script>window.__SSR_DATA__=${JSON.stringify(data)}</script>`
      );
    res.status(200).setHeader('Content-Type', 'text/html').end(html);
  }
}
```

:::

åœ¨æ‹¼æ¥ HTML çš„é€»è¾‘ä¸­ï¼Œé™¤äº†æ·»åŠ é¡µé¢çš„å…·ä½“å†…å®¹ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿæ³¨å…¥äº†ä¸€ä¸ªæŒ‚è½½å…¨å±€æ•°æ®çš„`script`æ ‡ç­¾ï¼Œè¿™æ˜¯ç”¨æ¥å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿ

åœ¨ SSR çš„åŸºæœ¬æ¦‚å¿µä¸­æˆ‘ä»¬å°±æåˆ°è¿‡ï¼Œä¸ºäº†æ¿€æ´»é¡µé¢çš„äº¤äº’åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œ CSR çš„ JavaScript ä»£ç æ¥è¿›è¡Œ hydrate æ“ä½œï¼Œè€Œå®¢æˆ·ç«¯ hydrate çš„æ—¶å€™éœ€è¦å’ŒæœåŠ¡ç«¯`åŒæ­¥é¢„å–åçš„æ•°æ®`ï¼Œä¿è¯é¡µé¢æ¸²æŸ“çš„ç»“æœå’ŒæœåŠ¡ç«¯æ¸²æŸ“ä¸€è‡´ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬åˆšåˆšæ³¨å…¥çš„æ•°æ® script æ ‡ç­¾ä¾¿æ´¾ä¸Šç”¨åœºäº†ã€‚ç”±äºå…¨å±€çš„ window ä¸ŠæŒ‚è½½æœåŠ¡ç«¯é¢„å–çš„æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨`entry-client.tsx`ä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯æ¸²æŸ“å…¥å£ä¸­æ‹¿åˆ°è¿™ä»½æ•°æ®ï¼Œå¹¶è¿›è¡Œ hydrate:

::: code-group

``` tsx [src/entry-client.tsx]
import React from 'react'
import {hydrateRoot} from 'react-dom/client'
import './index.css'
import App from './App'

// @ts-ignore
const data = window.__SSR_DATA__;

hydrateRoot(
  document.getElementById('root')!,
  <React.StrictMode>
    <App data={data} />
  </React.StrictMode>
)

```

:::



::: tip

ä¸Šé¢çš„ `@ts-ignore` è®©æˆ‘ä»¬å¿½ç•¥windowä¸Šçš„å˜é‡ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å†tsconfig.jsonä¸­å£°æ˜è¯¥ç±»å‹

1. æ–°å»º `types/global.d.ts`

   ``` typescript
   declare global {
     interface Window {
       __SSR_DATA__: any
     }
   }
   
   export {}
   ```

2. åœ¨ `tsconfig.json` ä¸­åŒ…å«è¯¥ç±»å‹

   ``` json
   {
     "include": ["src"], // [!code --]
     "include": ["src", "types/**/*.d.ts"], // [!code ++]
   }
   ```

è¿™æ ·ä¾¿å¯ä»¥å»æ‰ä¸Šé¢çš„ `@ts-ignore` äº†

:::

ç°åœ¨ï¼Œæˆ‘ä»¬åŸºæœ¬å¼€å‘å®Œäº† SSR æ ¸å¿ƒçš„é€»è¾‘ï¼Œæ‰§è¡Œ`pnpm run dev`å¯åŠ¨é¡¹ç›®:

![start ssr server](./imgs/16-4.webp)

æ‰“å¼€æµè§ˆå™¨åæŸ¥çœ‹é¡µé¢æºç ï¼Œä½ å¯ä»¥å‘ç° SSR ç”Ÿæˆçš„ HTML å·²ç»é¡ºåˆ©è¿”å›äº†:

![SSRæºç ](./imgs/16-5.webp)

### 4. ç”Ÿäº§ç¯å¢ƒçš„ CSR èµ„æºå¤„ç†

å¦‚æœä½ ç°åœ¨æ‰§è¡Œ`pnpm run build`åŠ`pnpm run preview`è¿›è¡Œç”Ÿäº§ç¯å¢ƒçš„é¢„è§ˆï¼Œä¼šå‘ç° SSR å¯ä»¥æ­£å¸¸è¿”å›å†…å®¹ï¼Œä½†æ‰€æœ‰çš„é™æ€èµ„æºåŠ CSR çš„ä»£ç éƒ½å¤±æ•ˆäº†:

![ç”Ÿæˆç¯å¢ƒCSRèµ„æºæ‰¾ä¸åˆ°](./imgs/16-6.webp)

ä¸è¿‡å¼€å‘é˜¶æ®µå¹¶æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼Œè¿™æ˜¯å› ä¸ºå¯¹äºå¼€å‘é˜¶æ®µçš„é™æ€èµ„æº Vite Dev Server çš„ä¸­é—´ä»¶å·²ç»å¸®æˆ‘ä»¬å¤„ç†äº†ï¼Œè€Œç”Ÿäº§ç¯å¢ƒæ‰€æœ‰çš„èµ„æºéƒ½å·²ç»æ‰“åŒ…å®Œæˆï¼Œæˆ‘ä»¬éœ€è¦å¯ç”¨å•ç‹¬çš„é™æ€èµ„æºæœåŠ¡æ¥æ‰¿è½½è¿™äº›èµ„æºã€‚è¿™é‡Œä½ å¯ä»¥`serve-static`ä¸­é—´ä»¶æ¥å®Œæˆè¿™ä¸ªæœåŠ¡ï¼Œé¦–å…ˆå®‰è£…å¯¹åº”ç¬¬ä¸‰æ–¹åŒ…:

```bash
pnpm i serve-static -S
pnpm i @types/serve-static -D
```

æ¥ç€æˆ‘ä»¬åˆ° server ç«¯æ³¨å†Œ:

::: code-group

``` typescript [ssr-server/index.ts] {20}
// ...
import serve from 'serve-static'

// è¿‡æ»¤å‡ºé¡µé¢è¯·æ±‚
function matchPageUrl(url: string) {
  if (url === '/') {
    return true;
  }
  return false;
}

async function createSsrMiddleware(app: Express): Promise<RequestHandler> {
  return async (req, res, next) => {
    try {
      const url = req.originalUrl;
      if (!matchPageUrl(url)) {
        // èµ°é™æ€èµ„æºçš„å¤„ç†
        return await next();
      }
      // SSR çš„é€»è¾‘çœç•¥
      // ...
    } catch(e: any) {
      vite?.ssrFixStacktrace(e);
      console.error(e);
      res.status(500).end(e.message);
    }
  }
}

async function createServer() {
  const app = express();
  // åŠ å…¥ Vite SSR ä¸­é—´ä»¶
  app.use(await createSsrMiddleware(app));

  // æ³¨å†Œä¸­é—´ä»¶ï¼Œç”Ÿäº§ç¯å¢ƒç«¯å¤„ç†å®¢æˆ·ç«¯èµ„æº
  if (isProd) {
    app.use(serve(path.join(cwd, 'dist/client')))
  }
  // çœç•¥å…¶å®ƒä»£ç 
}
```

:::

è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±è§£å†³äº†ç”Ÿäº§ç¯å¢ƒä¸‹é™æ€èµ„æºå¤±æ•ˆçš„é—®é¢˜ã€‚ä¸è¿‡ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šå°†é™æ€èµ„æºéƒ¨ä¸Šä¼ åˆ° CDN ä¸Šï¼Œå¹¶ä¸”å°† Vite çš„ `base` é…ç½®ä¸ºåŸŸåå‰ç¼€ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡ CDN ç›´æ¥è®¿é—®åˆ°é™æ€èµ„æºï¼Œè€Œä¸éœ€è¦åŠ ä¸ŠæœåŠ¡ç«¯çš„å¤„ç†ã€‚ä¸è¿‡ä½œä¸ºæœ¬åœ°çš„ç”Ÿäº§ç¯å¢ƒé¢„è§ˆè€Œè¨€ï¼Œ`serve-static`è¿˜æ˜¯ä¸€ä¸ªä¸é”™çš„é™æ€èµ„æºå¤„ç†æ‰‹æ®µã€‚



::: details é¡¹ç›®å®Œæ•´ä»£ç 

é¡¹ç›®åˆå§‹åŒ–ï¼š

```bash
pnpm create vite@latest vite-ssr --template react-ts
```

ç›®å½•ç»“æ„

```bash
.
â”œâ”€â”€ public
â”‚   â””â”€â”€ vite.svg
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ App.css
â”‚   â”œâ”€â”€ App.tsx
â”‚   â”œâ”€â”€ assets
â”‚   â”‚   â””â”€â”€ react.svg
â”‚   â”œâ”€â”€ entry-client.tsx  # å®¢æˆ·ç«¯ç»„ä»¶å…¥å£
â”‚   â”œâ”€â”€ entry-server.tsx  # æœåŠ¡ç«¯ç»„ä»¶å…¥å£
â”‚   â”œâ”€â”€ index.css
â”‚   â”œâ”€â”€ ssr-server
â”‚   â”‚   â””â”€â”€ index.ts  # æœåŠ¡ç«¯æ¸²æŸ“ä¸»é€»è¾‘
â”‚   â””â”€â”€ vite-env.d.ts
â”œâ”€â”€ index.html # å…¥å£HTML
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-lock.yaml
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ tsconfig.node.json
â”œâ”€â”€ types
â”‚   â””â”€â”€ global.d.ts
â””â”€â”€ vite.config.ts
```

ä¾èµ–å®‰è£…ï¼š

```bash
pnpm i express serve-static
pnpm i -D @types/express @types/serve-static nodemon tsx
```

`package.json`

```json
{
  "scripts": {
    "dev": "nodemon --watch src/ssr-server --exec 'tsx src/ssr-server/index.ts'",
    "build": "pnpm run build:client && pnpm run build:server",
    "build:client": "vite build --outDir dist/client",
    "build:server": "vite build --ssr src/entry-server.tsx --outDir dist/server",
    "preview": "NODE_ENV=production tsx src/ssr-server/index.ts"
  }
}
```



`index.html`ï¼š

``` html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/src/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite App</title>
  </head>
  <body>
    <div id="root"><!-- SSR_APP --></div>
    <script type="module" src="/src/entry-client.tsx"></script>
    <!-- SSR_DATA -->
  </body>
</html>
```

`src/entry-client.tsx`:

``` tsx
import React from 'react'
import {hydrateRoot} from 'react-dom/client'
import './index.css'
import App from './App'

const data = window.__SSR_DATA__;

hydrateRoot(
  document.getElementById('root')!,
  <React.StrictMode>
    <App data={data} />
  </React.StrictMode>
)
```

`src/entry-server.tsx`:

```tsx
import App from './App'
import './index.css'

export async function fetchData() {
  return { user: 'xxx' }
}

function ServerEntry(props: any) {
  return (
    <App />
  )
}

export { ServerEntry }
```

`src/ssr-server/index.ts`ï¼š

```typescript
import express, { Express, RequestHandler } from 'express'
import serve from 'serve-static'
import { ViteDevServer, createServer as createViteServer } from 'vite'
import { renderToString } from 'react-dom/server'
import React from 'react'
import path from 'node:path'
import fs from 'node:fs'

const isProd = process.env.NODE_ENV === 'production'
const cwd = process.cwd()

function matchPageUrl(url: string) {
  if (url === '/') {
    return true
  }
  return false
}

async function createSsrMiddleware(app: Express): Promise<RequestHandler> {
  let vite: ViteDevServer | null = null
  if (!isProd) {
    // https://cn.vitejs.dev/config/server-options.html#server-middlewaremode
    vite = await createViteServer({
      root: cwd,
      server: {
        middlewareMode: true,
      },
      appType: 'custom' // ä¸å¼•å…¥ Vite é»˜è®¤çš„ HTML å¤„ç†ä¸­é—´ä»¶
    })

    // å°† vite çš„ connect å®ä¾‹ä½œä¸­é—´ä»¶ä½¿ç”¨
    // æ³¨å†Œ Vite Middlewares
    // ä¸»è¦ç”¨æ¥å¤„ç†å®¢æˆ·ç«¯èµ„æº
    app.use(vite.middlewares)
  }

  return async (req, res, next) => {
    try {

      const url = req.originalUrl
      if (!matchPageUrl(url)) {
        // èµ°é™æ€èµ„æºçš„å¤„ç†
        return await next()
      }
      // SSR çš„é€»è¾‘
      // 1. åŠ è½½æœåŠ¡ç«¯å…¥å£æ¨¡å—
      const { ServerEntry, fetchData } = await loadSsrEntryModule(vite)
      // 2. æ•°æ®é¢„å–
      const data = await fetchData()
      // 3. ã€Œæ ¸å¿ƒã€æ¸²æŸ“ç»„ä»¶ - ç»„ä»¶æ¸²æŸ“ -> å­—ç¬¦ä¸²
      const appHtml = renderToString(React.createElement(ServerEntry, { data }))
      // 4. æ‹¼æ¥ HTMLï¼Œè¿”å›å“åº”
      const templatePath = resolveTemplatePath()
      let template = await fs.readFileSync(templatePath, 'utf-8')
      // å¼€å‘æ¨¡å¼ä¸‹éœ€è¦æ³¨å…¥ HMRã€ç¯å¢ƒå˜é‡ç›¸å…³çš„ä»£ç ï¼Œå› æ­¤éœ€è¦è°ƒç”¨ vite.transformIndexHtml
      if (!isProd && vite) {
        template = await vite.transformIndexHtml(url, template)
      }
      const html = template
        .replace('<!-- SSR_APP -->', appHtml)
          // æ³¨å…¥æ•°æ®æ ‡ç­¾ï¼Œç”¨äºå®¢æˆ·ç«¯ hydrate
          .replace(
            '<!-- SSR_DATA -->',
            `<script>window.__SSR_DATA__=${JSON.stringify(data)}</script>`
          )
      res.status(200).setHeader('Content-Type', 'text/html').end(html);
    } catch (e: any) {
      vite?.ssrFixStacktrace(e)
      console.error(e)
      res.status(500).end(e.message)
    }
    
  }
}

// 1. åŠ è½½æœåŠ¡ç«¯å…¥å£æ¨¡å—
async function loadSsrEntryModule(vite: ViteDevServer | null) {
  if (isProd) {  // ç”Ÿäº§æ¨¡å¼ä¸‹ç›´æ¥ require æ‰“åŒ…åçš„äº§ç‰©
    const entryPath = path.join(cwd, 'dist/server/entry-server.js')
    return import(entryPath)
  } else { // å¼€å‘ç¯å¢ƒä¸‹é€šè¿‡ no-bundle æ–¹å¼åŠ è½½
    const entryPath = path.join(cwd, 'src/entry-server.tsx')
    return vite!.ssrLoadModule(entryPath)
  }
}

function resolveTemplatePath() {
  return isProd 
    ? path.join(cwd, 'dist/client/index.html')
    : path.join(cwd, 'index.html')
}

async function createServer() {
  const app = express()

  app.use(await createSsrMiddleware(app))

  if (isProd) {
    app.use(serve(path.join(cwd, 'dist/client')))
  }

  app.listen(3333, () => {
    console.log('NodeæœåŠ¡å™¨å·²å¯åŠ¨')
    console.log(`http://localhost:3333`)
  })
}

createServer()
```

:::



## å·¥ç¨‹åŒ–é—®é¢˜

ä»¥ä¸Šæˆ‘ä»¬åŸºæœ¬å®ç°äº† SSR æ ¸å¿ƒçš„`æ„å»º`å’Œ`è¿è¡Œæ—¶`åŠŸèƒ½ï¼Œå¯ä»¥åˆæ­¥è¿è¡Œä¸€ä¸ªåŸºäº Vite çš„ SSR é¡¹ç›®ï¼Œä½†åœ¨å®é™…çš„åœºæ™¯ä¸­ä»ç„¶æ˜¯æœ‰ä¸å°‘çš„å·¥ç¨‹åŒ–é—®é¢˜éœ€è¦æˆ‘ä»¬æ³¨æ„ã€‚ä¸‹é¢æˆ‘å°±å’Œä½ ä¸€èµ·æ¢³ç†ä¸€ä¸‹åˆ°åº•éœ€è¦è€ƒè™‘å“ªäº›é—®é¢˜ï¼Œä»¥åŠç›¸åº”çš„è§£å†³æ€è·¯æ˜¯å¦‚ä½•çš„ï¼ŒåŒæ—¶æˆ‘ä¹Ÿä¼šæ¨èä¸€äº›æ¯”è¾ƒæˆç†Ÿçš„è§£å†³æ–¹æ¡ˆã€‚



### 1. è·¯ç”±ç®¡ç†

åœ¨ SPA åœºæ™¯ä¸‹ï¼Œå¯¹äºä¸åŒçš„å‰ç«¯æ¡†æ¶ï¼Œä¸€èˆ¬ä¼šæœ‰ä¸åŒçš„è·¯ç”±ç®¡ç†æ–¹æ¡ˆï¼Œå¦‚ Vue ä¸­çš„ `vue-router`ã€React çš„`react-router`ã€‚ä¸è¿‡å½’æ ¹ç»“åº•ï¼Œè·¯ç”±æ–¹æ¡ˆåœ¨ SSR è¿‡ç¨‹ä¸­æ‰€å®Œæˆçš„åŠŸèƒ½éƒ½æ˜¯å·®ä¸å¤šçš„:

1. å‘Šè¯‰æ¡†æ¶ç°åœ¨æ¸²æŸ“å“ªä¸ªè·¯ç”±ã€‚åœ¨ Vue ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡ `router.push` ç¡®å®šå³å°†æ¸²æŸ“çš„è·¯ç”±ï¼ŒReact ä¸­åˆ™é€šè¿‡ `StaticRouter` é…åˆ`location`å‚æ•°æ¥å®Œæˆã€‚
2. è®¾ç½® `base` å‰ç¼€ã€‚è§„å®šè·¯å¾„çš„å‰ç¼€ï¼Œå¦‚`vue-router` ä¸­ [base å‚æ•°](https://router.vuejs.org/zh/guide/migration/#%E7%A7%BB%E5%8A%A8%E4%BA%86-base-%E9%85%8D%E7%BD%AE)ã€`react-router`ä¸­`StaticRouter`ç»„ä»¶çš„ [basename](https://reactrouter.com/en/main/router-components/static-router)ã€‚



### 2. å…¨å±€çŠ¶æ€ç®¡ç†

å¯¹äºå…¨å±€çš„çŠ¶æ€ç®¡ç†è€Œè¨€ï¼Œå¯¹äºä¸åŒçš„æ¡†æ¶ä¹Ÿæœ‰ä¸åŒçš„ç”Ÿæ€å’Œæ–¹æ¡ˆï¼Œæ¯”å¦‚ Vue ä¸­çš„ [Vuex](https://vuex.vuejs.org/)ã€[Pinia](https://pinia.vuejs.org/)ï¼ŒReact ä¸­çš„ [Redux](https://redux.js.org/introduction/getting-started)ã€[Recoil](https://recoiljs.org/zh-hans/)ã€‚å„ä¸ªçŠ¶æ€ç®¡ç†å·¥å…·çš„ç”¨æ³•å¹¶ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œæ¥å…¥ SSR çš„æ€è·¯ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåœ¨`é¢„å–æ•°æ®`é˜¶æ®µåˆå§‹åŒ–æœåŠ¡ç«¯çš„ `store` ï¼Œå°†å¼‚æ­¥è·å–çš„æ•°æ®å­˜å…¥ `store` ä¸­ï¼Œç„¶ååœ¨ `æ‹¼æ¥ HTML`é˜¶æ®µå°†æ•°æ®ä» store ä¸­å–å‡ºæ”¾åˆ°æ•°æ® script æ ‡ç­¾ä¸­ï¼Œæœ€ååœ¨å®¢æˆ·ç«¯ hydrate çš„æ—¶å€™é€šè¿‡ window å³å¯è®¿é—®åˆ°é¢„å–æ•°æ®ã€‚



::: warning

éœ€è¦æ³¨æ„çš„æœåŠ¡ç«¯å¤„ç†è®¸å¤šä¸åŒçš„è¯·æ±‚ï¼Œå¯¹äºæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦**åˆ†åˆ«**åˆå§‹åŒ– storeï¼Œå³ä¸€ä¸ªè¯·æ±‚ä¸€ä¸ª storeï¼Œä¸ç„¶ä¼šé€ æˆå…¨å±€çŠ¶æ€æ±¡æŸ“çš„é—®é¢˜ã€‚

:::



### 3. CSR é™çº§

åœ¨æŸäº›æ¯”è¾ƒæç«¯çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦é™çº§åˆ° CSRï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯æ¸²æŸ“ã€‚ä¸€èˆ¬è€Œè¨€åŒ…æ‹¬å¦‚ä¸‹çš„é™çº§åœºæ™¯:

1. æœåŠ¡å™¨ç«¯**é¢„å–æ•°æ®**å¤±è´¥ï¼Œéœ€è¦é™çº§åˆ°å®¢æˆ·ç«¯è·å–æ•°æ®ã€‚
2. æœåŠ¡å™¨å‡ºç°å¼‚å¸¸ï¼Œéœ€è¦è¿”å›**å…œåº•çš„ CSR æ¨¡æ¿**ï¼Œå®Œå…¨é™çº§ä¸º CSRã€‚
3. æœ¬åœ°**å¼€å‘è°ƒè¯•**ï¼Œæœ‰æ—¶éœ€è¦è·³è¿‡ SSRï¼Œä»…è¿›è¡Œ CSRã€‚

å¯¹äºç¬¬ä¸€ç§æƒ…å†µï¼Œåœ¨å®¢æˆ·ç«¯å…¥å£æ–‡ä»¶ä¸­éœ€è¦æœ‰é‡æ–°è·å–æ•°æ®çš„é€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œè¿™æ ·çš„è¡¥å……:

```tsx
import React from 'react'
import {hydrateRoot} from 'react-dom/client'
import './index.css'
import App from './App'

async function fetchData() {
  // å®¢æˆ·ç«¯è·å–æ•°æ®
}

async function hydrate() {
  let data;
  if (window.__SSR_DATA__) {
    data = window.__SSR_DATA__;
  } else {
    // é™çº§é€»è¾‘ 
    data = await fetchData();
  }
  // ä¹Ÿå¯ç®€åŒ–ä¸º const data = window.__SSR_DATA__ ?? await fetchData();
  hydrateRoot(
    document.getElementById('root')!,
    <React.StrictMode>
      <App data={data} />
    </React.StrictMode>
  )
}
```

å¯¹äºç¬¬äºŒç§åœºæ™¯ï¼Œå³`æœåŠ¡å™¨æ‰§è¡Œå‡ºé”™`ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¹‹å‰çš„ SSR ä¸­é—´ä»¶é€»è¾‘è¿½åŠ  catch é€»è¾‘:

```typescript {8}
async function createSsrMiddleware(app: Express): Promise<RequestHandler> {
  return async (req, res, next) => {
    try {
      // SSR çš„é€»è¾‘çœç•¥
    } catch(e: any) {
      vite?.ssrFixStacktrace(e);
      console.error(e);
      // åœ¨è¿™é‡Œè¿”å›æµè§ˆå™¨ CSR æ¨¡æ¿å†…å®¹
    }
  }
}
```

å¯¹äºç¬¬ä¸‰ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é€šè¿‡ `?csr` çš„ url query å‚æ•°æ¥å¼ºåˆ¶è·³è¿‡ SSRï¼Œåœ¨ SSR ä¸­é—´ä»¶æ·»åŠ å¦‚ä¸‹é€»è¾‘:

``` typescript {4}
async function createSsrMiddleware(app: Express): Promise<RequestHandler> {
  return async (req, res, next) => {
    try {
      if (req.query?.csr) {
        // å“åº” CSR æ¨¡æ¿å†…å®¹
        return;
      }
      // SSR çš„é€»è¾‘çœç•¥
    } catch(e: any) {
      vite?.ssrFixStacktrace(e);
      console.error(e);
    }
  }
}
```



### 4. æµè§ˆå™¨ API å…¼å®¹

ç”±äº Node.js ä¸­ä¸èƒ½ä½¿ç”¨æµè§ˆå™¨é‡Œé¢è¯¸å¦‚ `window`ã€`document`ä¹‹ç±»çš„ APIï¼Œå› æ­¤ä¸€æ—¦åœ¨æœåŠ¡ç«¯æ‰§è¡Œåˆ°è¿™æ ·çš„ API ä¼šæŠ¥å¦‚ä¸‹çš„é”™è¯¯ï¼š

![Nodeç¯å¢ƒä½¿ç”¨æµè§ˆå™¨APIsæŠ¥é”™](./imgs/16-7.webp)

é‚£ä¹ˆå¦‚ä½•æ¥è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ

é¦–å…ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡`import.meta.env.SSR`è¿™ä¸ª Vite å†…ç½®çš„ç¯å¢ƒå˜é‡æ¥åˆ¤æ–­æ˜¯å¦å¤„äº SSR ç¯å¢ƒï¼Œä»¥æ­¤æ¥è§„é¿ä¸šåŠ¡ä»£ç åœ¨æœåŠ¡ç«¯å‡ºç°æµè§ˆå™¨çš„ API:

```typescript
if (import.meta.env.SSR) {
  // æœåŠ¡ç«¯æ‰§è¡Œçš„é€»è¾‘
} else {
  // åœ¨æ­¤å¯ä»¥è®¿é—®æµè§ˆå™¨çš„ API
}
```

å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ polyfill çš„æ–¹å¼ï¼Œåœ¨ Node ä¸­æ³¨å…¥æµè§ˆå™¨çš„ APIï¼Œä½¿è¿™äº› API èƒ½å¤Ÿæ­£å¸¸è¿è¡Œèµ·æ¥ï¼Œè§£å†³å¦‚ä¸Šçš„é—®é¢˜ã€‚æˆ‘æ¨èä½¿ç”¨ä¸€ä¸ªæ¯”è¾ƒæˆç†Ÿçš„ polyfill åº“ `jsdom`ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹:

``` typescript
const jsdom = require('jsdom');
const { window } = new JSDOM(`<!DOCTYPE html><p>Hello world</p>`);
const { document } = window;
// æŒ‚è½½åˆ° node å…¨å±€
global.window = window;
global.document = document;
```



### 5. è‡ªå®šä¹‰ Head

åœ¨ SSR çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è™½ç„¶å¯ä»¥åœ¨å†³å®šç»„ä»¶çš„å†…å®¹ï¼Œå³`<div id="root"></div>`è¿™ä¸ªå®¹å™¨ div ä¸­çš„å†…å®¹ï¼Œä½†å¯¹äº HTML ä¸­`head`çš„å†…å®¹æˆ‘ä»¬æ— æ³•æ ¹æ®**ç»„ä»¶çš„å†…éƒ¨çŠ¶æ€**æ¥å†³å®šï¼Œæ¯”å¦‚å¯¹äºä¸€ä¸ªç›´æ’­é—´çš„é¡µé¢ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æœåŠ¡ç«¯æ¸²æŸ“å‡º title æ ‡ç­¾ï¼Œtitle çš„å†…å®¹æ˜¯ä¸åŒä¸»æ’­çš„ç›´æ’­é—´åç§°ï¼Œä¸èƒ½åœ¨ä»£ç ä¸­å†™æ­»ï¼Œè¿™ç§æƒ…å†µæ€ä¹ˆåŠï¼Ÿ

React ç”Ÿæ€ä¸­çš„ [react-helmet](https://github.com/nfl/react-helmet) ä»¥åŠ Vue ç”Ÿæ€ä¸­çš„ [vue-meta](https://github.com/nuxt/vue-meta) åº“å°±æ˜¯ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œè®©æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ç»„ä»¶ä¸­å†™ä¸€äº› Head æ ‡ç­¾ï¼Œç„¶ååœ¨æœåŠ¡ç«¯èƒ½å¤Ÿæ‹¿åˆ°ç»„ä»¶å†…éƒ¨çš„çŠ¶æ€ã€‚è¿™é‡Œæˆ‘ä»¥ä¸€ä¸ª`react-helmet`ä¾‹å­æ¥è¯´æ˜:

```tsx
// å‰ç«¯ç»„ä»¶é€»è¾‘
import { Helmet } from "react-helmet";

function App(props) {
  const { data } = props;
  return {
    <div>
       <Helmet>
        <title>{ data.user }çš„é¡µé¢</title>
        <link rel="canonical" href="http://mysite.com/example" />
      </Helmet>
    </div>
  }
}
// æœåŠ¡ç«¯é€»è¾‘
import Helmet from 'react-helmet';

// renderToString æ‰§è¡Œä¹‹å
const helmet = Helmet.renderStatic();
console.log("title å†…å®¹: ", helmet.title.toString());
console.log("link å†…å®¹: ", helmet.link.toString())
```

å¯åŠ¨æœåŠ¡åè®¿é—®é¡µé¢ï¼Œå¯ä»¥å‘ç°ç»ˆç«¯èƒ½æ‰“å°å‡ºå¦‚ä¸‹çš„ä¿¡æ¯:

![meta SEO](./imgs/16-8.webp)

å¦‚æ­¤ä¸€æ¥ï¼Œæˆ‘ä»¬å°±èƒ½æ ¹æ®ç»„ä»¶çš„çŠ¶æ€ç¡®å®š Head å†…å®¹ï¼Œç„¶ååœ¨`æ‹¼æ¥ HTML`é˜¶æ®µå°†è¿™äº›å†…å®¹æ’å…¥åˆ°æ¨¡æ¿ä¸­ã€‚



### 6. æµå¼æ¸²æŸ“

åœ¨ä¸åŒå‰ç«¯æ¡†æ¶çš„åº•å±‚éƒ½å®ç°äº†æµå¼æ¸²æŸ“çš„èƒ½åŠ›ï¼Œå³è¾¹æ¸²æŸ“è¾¹å“åº”ï¼Œè€Œä¸æ˜¯ç­‰æ•´ä¸ªç»„ä»¶æ ‘æ¸²æŸ“å®Œæ¯•ä¹‹åå†å“åº”ï¼Œè¿™ä¹ˆåšå¯ä»¥è®©å“åº”æå‰åˆ°è¾¾æµè§ˆå™¨ï¼Œæå‡é¦–å±çš„åŠ è½½æ€§èƒ½ã€‚Vue ä¸­çš„ [renderToNodeStream](https://www.npmjs.com/package/@vue/server-renderer) å’Œ React ä¸­çš„ [renderToNodeStream](https://reactjs.org/docs/react-dom-server.html#rendertonodestream) éƒ½å®ç°äº†æµå¼æ¸²æŸ“çš„èƒ½åŠ›, å¤§è‡´çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹:

``` tsx
import { renderToNodeStream } from 'react-dom/server';

// è¿”å›ä¸€ä¸ª Nodejs çš„ Stream å¯¹è±¡
const stream = renderToNodeStream(element);
let html = ''

stream.on('data', data => {
  html += data.toString()
  // å‘é€å“åº”
})

stream.on('end', () => {
  console.log(html) // æ¸²æŸ“å®Œæˆ
  // å‘é€å“åº”
})

stream.on('error', err => {
  // é”™è¯¯å¤„ç†
})
```

ä¸è¿‡ï¼Œæµå¼æ¸²æŸ“åœ¨æˆ‘ä»¬å¸¦æ¥é¦–å±æ€§èƒ½æå‡çš„åŒæ—¶ï¼Œä¹Ÿç»™æˆ‘ä»¬å¸¦æ¥äº†ä¸€äº›é™åˆ¶: **å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨ HTML ä¸­å¡«å…¥ä¸€äº›ä¸ç»„ä»¶çŠ¶æ€ç›¸å…³çš„å†…å®¹ï¼Œåˆ™ä¸èƒ½ä½¿ç”¨æµå¼æ¸²æŸ“**ã€‚æ¯”å¦‚`react-helmet`ä¸­è‡ªå®šä¹‰çš„ head å†…å®¹ï¼Œå³ä¾¿åœ¨æ¸²æŸ“ç»„ä»¶çš„æ—¶å€™æ”¶é›†åˆ°äº† head ä¿¡æ¯ï¼Œä½†åœ¨æµå¼æ¸²æŸ“ä¸­ï¼Œæ­¤æ—¶ HTML çš„ head éƒ¨åˆ†å·²ç»å‘é€ç»™æµè§ˆå™¨äº†ï¼Œè€Œè¿™éƒ¨åˆ†å“åº”å†…å®¹å·²ç»æ— æ³•æ›´æ”¹ï¼Œå› æ­¤ `react-helmet` åœ¨ SSR è¿‡ç¨‹ä¸­å°†ä¼šå¤±æ•ˆã€‚



### 7. SSR ç¼“å­˜

SSR æ˜¯ä¸€ç§å…¸å‹çš„ CPU å¯†é›†å‹æ“ä½œï¼Œä¸ºäº†å°½å¯èƒ½é™ä½çº¿ä¸Šæœºå™¨çš„è´Ÿè½½ï¼Œè®¾ç½®ç¼“å­˜æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç¯èŠ‚ã€‚åœ¨ SSR è¿è¡Œæ—¶ï¼Œç¼“å­˜çš„å†…å®¹å¯ä»¥åˆ†ä¸ºè¿™ä¹ˆå‡ ä¸ªéƒ¨åˆ†:

1. `æ–‡ä»¶è¯»å–ç¼“å­˜`ã€‚å°½å¯èƒ½é¿å…å¤šæ¬¡é‡å¤è¯»ç£ç›˜çš„æ“ä½œï¼Œæ¯æ¬¡ç£ç›˜ IO å°½å¯èƒ½åœ°å¤ç”¨ç¼“å­˜ç»“æœã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤º:

   ```typescript
   function createMemoryFsRead() {
     const fileContentMap = new Map();
     return async (filePath) => {
       const cacheResult = fileContentMap.get(filePath);
       if (cacheResult) {
         return cacheResult;
       }
       const fileContent = await fs.readFile(filePath);
       fileContentMap.set(filePath, fileContent);
       return fileContent;
     }
   }
   
   const memoryFsRead = createMemoryFsRead();
   memoryFsRead('file1');
   // ç›´æ¥å¤ç”¨ç¼“å­˜
   memoryFsRead('file1');
   ```

2. `é¢„å–æ•°æ®ç¼“å­˜`ã€‚å¯¹äºæŸäº›å®æ—¶æ€§ä¸é«˜çš„æ¥å£æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡å–ç¼“å­˜çš„ç­–ç•¥ï¼Œåœ¨ä¸‹æ¬¡ç›¸åŒçš„è¯·æ±‚è¿›æ¥æ—¶å¤ç”¨ä¹‹å‰é¢„å–æ•°æ®çš„ç»“æœï¼Œè¿™æ ·é¢„å–æ•°æ®è¿‡ç¨‹çš„å„ç§ IO æ¶ˆè€—ï¼Œä¹Ÿå¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šå‡å°‘é¦–å±æ—¶é—´ã€‚

3. `HTML æ¸²æŸ“ç¼“å­˜`ã€‚æ‹¼æ¥å®Œæˆçš„`HTML`å†…å®¹æ˜¯ç¼“å­˜çš„é‡ç‚¹ï¼Œå¦‚æœèƒ½å°†è¿™éƒ¨åˆ†è¿›è¡Œç¼“å­˜ï¼Œé‚£ä¹ˆä¸‹æ¬¡å‘½ä¸­ç¼“å­˜ä¹‹åï¼Œå°†å¯ä»¥èŠ‚çœ `renderToString`ã€`HTML æ‹¼æ¥`ç­‰ä¸€ç³»åˆ—çš„æ¶ˆè€—ï¼ŒæœåŠ¡ç«¯çš„æ€§èƒ½æ”¶ç›Šä¼šæ¯”è¾ƒæ˜æ˜¾ã€‚

å¯¹äºä»¥ä¸Šçš„ç¼“å­˜å†…å®¹ï¼Œå…·ä½“çš„ç¼“å­˜ä½ç½®å¯ä»¥æ˜¯ï¼š


- `æœåŠ¡å™¨å†…å­˜`ã€‚å¦‚æœæ˜¯æ”¾åˆ°å†…å­˜ä¸­ï¼Œéœ€è¦è€ƒè™‘ç¼“å­˜æ·˜æ±°æœºåˆ¶ï¼Œé˜²æ­¢å†…å­˜è¿‡å¤§å¯¼è‡´æœåŠ¡å®•æœºï¼Œä¸€ä¸ªå…¸å‹çš„ç¼“å­˜æ·˜æ±°æ–¹æ¡ˆæ˜¯ [lru-cache](https://github.com/isaacs/node-lru-cache) (åŸºäº LRU ç®—æ³•)ã€‚
- [Redis æ•°æ®åº“](https://github.com/redis/node-redis)ï¼Œç›¸å½“äºä»¥ä¼ ç»Ÿåç«¯æœåŠ¡å™¨çš„è®¾è®¡æ€è·¯æ¥å¤„ç†ç¼“å­˜ã€‚
- CDN æœåŠ¡ã€‚æˆ‘ä»¬å¯ä»¥å°†é¡µé¢å†…å®¹ç¼“å­˜åˆ° CDN æœåŠ¡ä¸Šï¼Œåœ¨ä¸‹ä¸€æ¬¡ç›¸åŒçš„è¯·æ±‚è¿›æ¥æ—¶ï¼Œä½¿ç”¨ CDN ä¸Šçš„ç¼“å­˜å†…å®¹ï¼Œè€Œä¸ç”¨æ¶ˆè´¹æºæœåŠ¡å™¨çš„èµ„æºã€‚å¯¹äº CDN ä¸Šçš„ SSR ç¼“å­˜ï¼Œå¤§å®¶å¯ä»¥é€šè¿‡é˜…è¯»[è¿™ç¯‡æ–‡ç« ](https://juejin.cn/post/6887884087915184141#heading-8)æ·±å…¥äº†è§£ã€‚

::: tip

éœ€è¦è¡¥å……çš„æ˜¯ï¼ŒVue ä¸­å¦å¤–å®ç°äº†[ç»„ä»¶çº§åˆ«çš„ç¼“å­˜](https://ssr.vuejs.org/zh/guide/caching.html#ç»„ä»¶çº§åˆ«ç¼“å­˜-component-level-caching)ï¼Œè¿™éƒ¨åˆ†ç¼“å­˜ä¸€èˆ¬æ”¾åœ¨å†…å­˜ä¸­ï¼Œå¯ä»¥å®ç°æ›´ç»†ç²’åº¦çš„ SSR ç¼“å­˜ã€‚

:::



### 8. æ€§èƒ½ç›‘æ§

åœ¨å®é™…çš„ SSR é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬æ—¶å¸¸ä¼šé‡åˆ°ä¸€äº› SSR çº¿ä¸Šæ€§èƒ½é—®é¢˜ï¼Œå¦‚æœæ²¡æœ‰ä¸€ä¸ªå®Œæ•´çš„æ€§èƒ½ç›‘æ§æœºåˆ¶ï¼Œé‚£ä¹ˆå°†å¾ˆéš¾å‘ç°å’Œæ’æŸ¥é—®é¢˜ã€‚å¯¹äº SSR æ€§èƒ½æ•°æ®ï¼Œæœ‰ä¸€äº›æ¯”è¾ƒé€šç”¨çš„æŒ‡æ ‡:

- SSR äº§ç‰©åŠ è½½æ—¶é—´
- æ•°æ®é¢„å–çš„æ—¶é—´
- ç»„ä»¶æ¸²æŸ“çš„æ—¶é—´
- æœåŠ¡ç«¯æ¥å—è¯·æ±‚åˆ°å“åº”çš„å®Œæ•´æ—¶é—´
- SSR ç¼“å­˜å‘½ä¸­æƒ…å†µ
- SSR æˆåŠŸç‡ã€é”™è¯¯æ—¥å¿—

æˆ‘ä»¬å¯ä»¥é€šè¿‡`perf_hooks`æ¥å®Œæˆæ•°æ®çš„é‡‡é›†ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤º:

``` typescript
import { performance, PerformanceObserver } from 'perf_hooks';

// åˆå§‹åŒ–ç›‘å¬å™¨é€»è¾‘
const perfObserver = new PerformanceObserver((items) => {
  items.getEntries().forEach(entry => { 
    console.log('[performance]', entry.name, entry.duration.toFixed(2), 'ms');
  });
  performance.clearMarks();
});

perfObserver.observe({ entryTypes: ["measure"] })

// æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨ SSR è¿›è¡Œæ‰“ç‚¹
// ä»¥ renderToString  ä¸ºä¾‹
performance.mark('render-start');
// renderToString ä»£ç çœç•¥
performance.mark('render-end');
performance.measure('renderToString', 'render-start', 'render-end');
```

æ¥ç€æˆ‘ä»¬å¯åŠ¨æœåŠ¡åè®¿é—®ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„æ‰“ç‚¹æ—¥å¿—ä¿¡æ¯:

![perf monitor](./imgs/16-9.webp)

åŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶å®ƒé˜¶æ®µçš„æŒ‡æ ‡é€šè¿‡ä¸Šè¿°çš„æ–¹å¼æ”¶é›†èµ·æ¥ï¼Œä½œä¸ºæ€§èƒ½æ—¥å¿—ï¼›å¦ä¸€æ–¹é¢ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ä¸€èˆ¬éœ€è¦ç»“åˆå…·ä½“çš„æ€§èƒ½ç›‘æ§å¹³å°ï¼Œå¯¹ä¸Šè¿°çš„å„é¡¹æŒ‡æ ‡è¿›è¡Œæ‰“ç‚¹ä¸ŠæŠ¥ï¼Œå®Œæˆçº¿ä¸Šçš„ SSR æ€§èƒ½ç›‘æ§æœåŠ¡ã€‚



### 9. SSG/ISR/SPR

æœ‰æ—¶å€™å¯¹äºä¸€äº›é™æ€ç«™ç‚¹(å¦‚åšå®¢ã€æ–‡æ¡£)ï¼Œä¸æ¶‰åŠåˆ°åŠ¨æ€å˜åŒ–çš„æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬å¹¶ä¸éœ€è¦ç”¨ä¸ŠæœåŠ¡ç«¯æ¸²æŸ“ã€‚æ­¤æ—¶åªéœ€è¦åœ¨æ„å»ºé˜¶æ®µäº§å‡ºå®Œæ•´çš„ HTML è¿›è¡Œéƒ¨ç½²å³å¯ï¼Œè¿™ç§æ„å»ºé˜¶æ®µç”Ÿæˆ HTML çš„åšæ³•ä¹Ÿå«`SSG`(Static Site Generationï¼Œé™æ€ç«™ç‚¹ç”Ÿæˆ)ã€‚

SSG ä¸ SSR æœ€å¤§çš„åŒºåˆ«å°±æ˜¯äº§å‡º HTML çš„æ—¶é—´ç‚¹ä» SSR `è¿è¡Œæ—¶`å˜æˆäº†`æ„å»ºæ—¶`ï¼Œä½†æ ¸å¿ƒçš„ç”Ÿå‘½å‘¨æœŸæµç¨‹å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–:

![SSR Flow](./imgs/16-3.webp)

è¿™é‡Œç»™ä¸€æ®µç®€å•çš„å®ç°ä»£ç :

```tsx
// scripts/ssg.ts
// ä»¥ä¸‹çš„å·¥å…·å‡½æ•°å‡å¯ä»¥ä» SSR æµç¨‹å¤ç”¨
async function ssg() {
  // 1. åŠ è½½æœåŠ¡ç«¯å…¥å£
  const { ServerEntry, fetchData } = await loadSsrEntryModule(null);
  // 2. æ•°æ®é¢„å–
  const data = await fetchData();
  // 3. ç»„ä»¶æ¸²æŸ“
  const appHtml = renderToString(React.createElement(ServerEntry, { data }));
  // 4. HTML æ‹¼æ¥
  const template = await resolveTemplatePath();
  const templateHtml = await fs.readFileSync(template, 'utf-8');
  const html = templateHtml
  .replace('<!-- SSR_APP -->', appHtml)
  .replace(
    '<!-- SSR_DATA -->',
    `<script>window.__SSR_DATA__=${JSON.stringify(data)}</script>`
  ); 
  // æœ€åï¼Œæˆ‘ä»¬éœ€è¦å°† HTML çš„å†…å®¹å†™åˆ°ç£ç›˜ä¸­ï¼Œå°†å…¶ä½œä¸ºæ„å»ºäº§ç‰©
  fs.mkdirSync('./dist/client', { recursive: true });
  fs.writeFileSync('./dist/client/index.html', html);
}

ssg();
```

æ¥ç€ä½ å¯ä»¥åœ¨`package.json`ä¸­åŠ å…¥è¿™æ ·ä¸€æ®µ npm scripts:

```json
{
  "scripts": {
    "build:ssg": "npm run build && NODE_ENV=production tsx scripts/ssg.ts"  
  }
}
```

è¿™æ ·æˆ‘ä»¬ä¾¿åˆæ­¥å®ç°äº† SSG çš„é€»è¾‘ã€‚å½“ç„¶ï¼Œé™¤äº† SSGï¼Œä¸šç•Œè¿˜æµä¼ ç€ä¸€äº›å…¶å®ƒçš„æ¸²æŸ“æ¨¡å¼ï¼Œè¯¸å¦‚`SPR`ã€`ISR`ï¼Œå¬èµ·æ¥æ¯”è¾ƒé«˜å¤§ä¸Šï¼Œä½†å®é™…ä¸Šåªæ˜¯ SSR å’Œ SSG æ‰€è¡ç”Ÿå‡ºæ¥çš„æ–°åŠŸèƒ½ç½¢äº†ï¼Œè¿™é‡Œç®€å•ç»™å¤§å®¶è§£é‡Šä¸€ä¸‹:

- `SPR`å³`Serverless Pre Render`ï¼Œå³æŠŠ SSR çš„æœåŠ¡éƒ¨ç½²åˆ° Serverless(FaaS) ç¯å¢ƒä¸­ï¼Œå®ç°æœåŠ¡å™¨å®ä¾‹çš„è‡ªåŠ¨æ‰©ç¼©å®¹ï¼Œé™ä½æœåŠ¡å™¨è¿ç»´çš„æˆæœ¬ã€‚
- `ISR`å³`Incremental Site Rendering`ï¼Œå³å¢é‡ç«™ç‚¹æ¸²æŸ“ï¼Œå°†ä¸€éƒ¨åˆ†çš„ SSG é€»è¾‘ä»æ„å»ºæ—¶æ¬åˆ°äº† `SSR` è¿è¡Œæ—¶ï¼Œè§£å†³çš„æ˜¯å¤§é‡é¡µé¢ SSG æ„å»ºè€—æ—¶é•¿çš„é—®é¢˜ã€‚



## å°ç»“

æ­å–œä½ ï¼Œå­¦ä¹ å®Œäº† `Vite SSR` å°èŠ‚çš„å†…å®¹ã€‚åœ¨æœ¬å°èŠ‚ä¸­ï¼Œä½ éœ€è¦é‡ç‚¹æŒæ¡ **Vite ä¸­ SSR é¡¹ç›®çš„æ­å»º**å’Œ **SSR å·¥ç¨‹åŒ–é—®é¢˜åŠå…¶å¯¹åº”çš„è§£å†³æ–¹æ¡ˆ**ã€‚

é¦–å…ˆï¼Œæˆ‘ç»™ä½ ä»‹ç»äº† SSR çš„åŸºæœ¬æ¦‚å¿µï¼Œå…ˆåˆ†æä¼ ç»Ÿçš„ CSR åˆ°åº•å­˜åœ¨å“ªäº›é—®é¢˜ï¼Œç„¶åä»‹ç» SSR æ˜¯å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„ã€‚æ¥ç€æˆ‘ç»™ä½ åˆ†æäº† SSR åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸»è¦åŒ…å«`æ„å»ºæ—¶`å’Œ`è¿è¡Œæ—¶`ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå¸¦ä½ ä»å®è§‚ä¸Šäº†è§£äº†è¦å®ç° SSR ç©¶ç«Ÿéœ€è¦åšå“ªäº›äº‹æƒ…ã€‚å½“ç„¶ï¼Œå…‰ä»‹ç»æ¦‚å¿µæ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼Œåœ¨æ¥ä¸‹æ¥çš„æ—¶é—´ï¼Œæˆ‘ç”¨å…·ä½“çš„é¡¹ç›®ç¤ºä¾‹å¸¦ä½ ä¸€æ­¥æ­¥æ­å»ºèµ·äº†ä¸€ä¸ªç®€å•çš„ SSR å·¥ç¨‹ï¼Œå€ŸåŠ© `Vite`å®ç°äº†`å®¢æˆ·ç«¯äº§ç‰©`ä¸`SSR äº§ç‰©`çš„æ„å»ºï¼Œç„¶åé€šè¿‡ SSR ä¸­é—´ä»¶çš„å¼€å‘å®ç°äº† SSR è¿è¡Œæ—¶çš„é€»è¾‘ï¼ŒåŒ…æ‹¬`åŠ è½½æœåŠ¡ç«¯å…¥å£`ã€`æ•°æ®é¢„å–`ã€`ç»„ä»¶æ¸²æŸ“`å’Œ`HTML æ‹¼æ¥`è¿™å››ä¸ªæ ¸å¿ƒçš„æ­¥éª¤ã€‚

è™½ç„¶è¯´åŸºäºç¤ºä¾‹ä»£ç æˆ‘ä»¬å¯ä»¥æ­å»º Vite çš„ SSR é¡¹ç›®ï¼Œä½†é¢å¯¹å®é™…çš„å¼€å‘åœºæ™¯ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦è€ƒè™‘è¯¸å¤šçš„å·¥ç¨‹åŒ–é—®é¢˜ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢è¿™å¼ å›¾:

![SSRå·¥ç¨‹åŒ–éœ€è¦è§£å†³çš„é—®é¢˜](./imgs/16-10.webp)

å…¶ä¸­åŒ…æ‹¬`è·¯ç”±ç®¡ç†`ã€`çŠ¶æ€ç®¡ç†`ã€`CSR é™çº§`ã€`æµè§ˆå™¨ API çš„ SSR å…¼å®¹`ã€`è‡ªå®šä¹‰ Head`ã€`æµå¼æ¸²æŸ“`ã€`SSR ç¼“å­˜`ã€`æ€§èƒ½ç›‘æ§`ä»¥åŠæ›´å¤šçš„é¢„æ¸²æŸ“æ¨¡å¼`SSG/SPR/ISR`ã€‚åœ¨åé¢çš„ç¯‡å¹…ï¼Œæˆ‘å¸¦ä½ è¯¦ç»†æ¢³ç†äº†è¿™äº›é—®é¢˜ï¼Œåˆ†æå„ä¸ªé—®é¢˜çš„å‡ºç°åœºæ™¯ï¼Œå¹¶ç»™å‡ºä¸€äº›æ¯”è¾ƒé€šç”¨çš„è§£å†³æ€è·¯å’Œè§£å†³æ–¹æ¡ˆã€‚ç›¸ä¿¡é€šè¿‡è¿™éƒ¨åˆ†çš„å­¦ä¹ ï¼Œä½ ä¹Ÿèƒ½é©¾é©­æ›´åŠ å¤æ‚çš„ SSR å¼€å‘åœºæ™¯äº†ã€‚

OKï¼Œæœ¬æ–‡çš„å†…å®¹åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œå¸Œæœ›èƒ½å¯¹ä½ æœ‰æ‰€å¯å‘ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè‡ªå·±çš„å­¦ä¹ å¿ƒå¾—å’Œæ”¶è·æ‰“åœ¨è¯„è®ºåŒºï¼Œæˆ‘ä»¬ä¸‹ä¸€èŠ‚å†è§ğŸ‘‹ğŸ»ã€‚



ä»£ç åœ°å€ï¼š

- [vite-ssr - @github](https://github.com/jamessawyer/vite-ssr)



::: details è¯„è®ºåŒºå…³äºæœ¬èŠ‚çš„æ€è€ƒ

å¹²è´§æ»¡æ»¡ï¼ŒæŠŠä»£ç cloneä¸‹æ¥ï¼Œç»“åˆä½œè€…è€å¸ˆçš„ä»£ç çœ‹ï¼Œå¾ˆæœ‰æ”¶è·ï¼Œä¸ä½†å·¥ç¨‹ä¸Šæœ‰å¸®åŠ©ï¼Œé¢è¯•ä¸Šä¹Ÿæœ‰å¸®åŠ©ï¼Œæé«˜äº†å¯¹SSRçš„ç†è§£~å­¦å®Œæœ¬æ–‡ï¼Œå¯ä»¥è‡³å°‘ä¼šå›ç­”ä»¥ä¸‹é—®é¢˜ï¼š

1. CSRå­˜åœ¨çš„é—®é¢˜?
2. SSRä¸ºä»€ä¹ˆèƒ½åŠ å¿«é¦–å±åŠ è½½é€Ÿåº¦å’Œæœ‰åˆ©äºSEOï¼Ÿ
3. SSRåº”ç”¨çš„ä¸¤å¤§ç”Ÿå‘½å‘¨æœŸæ˜¯ä»€ä¹ˆï¼Ÿ
4. SSRåœ¨â€œæ„å»ºæ—¶â€éœ€è¦åšå“ªäº›äº‹æƒ…ï¼Ÿ
5. SSRåœ¨â€è¿è¡Œæ—¶â€éƒ½éœ€è¦åšå“ªäº›äº‹ï¼Ÿ
6. ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦ç”±SSRé™çº§åˆ°CSR?
7. SSRä¸­ä¸èƒ½ä½¿ç”¨windowï¼Œdocumentä¹‹ç±»çš„APIå¦‚ä½•è§£å†³ï¼Ÿ
8. SSRä¸­å¦‚ä½•è‡ªå®šä¹‰Head?
9. SSRä¸­ä½¿ç”¨æµå¼æ¸²æŸ“æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿæœ‰ä»€ä¹ˆé™åˆ¶ï¼Ÿ
10. ä¸ºä»€ä¹ˆå³è¾¹è¦åœ¨SSRä¸­ä½¿ç”¨ç¼“å­˜ï¼Ÿéƒ½ç¼“å­˜ä»€ä¹ˆå†…å®¹ï¼Ÿ
11. SSRæ€§èƒ½ç›‘æ§éƒ½å…³æ³¨å“ªäº›æŒ‡æ ‡ï¼Ÿ

:::



ğŸš€ å…³äºVite SSR å¯ä»¥å‚è€ƒï¼š

- [Vite-plugin-SSR](https://cn.vite-plugin-ssr.com/) æ’ä»¶é¡¹ç›®ğŸ‘
- [Vite SSR - Vite Doc](https://cn.vitejs.dev/guide/ssr.html)
- [Vite Server Options - Vite Doc](https://cn.vitejs.dev/config/server-options.html#server-middlewaremode)





2023å¹´02æœˆ27æ—¥14:03:00


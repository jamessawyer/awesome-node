---
title: Rollupæ’ä»¶æœºåˆ¶
---

ä¸Šä¸€èŠ‚æˆ‘ä»¬å­¦ä¼šäº† Rollup æ„å»ºå·¥å…·çš„ä½¿ç”¨ï¼Œç›¸ä¿¡ä½ å·²ç»å¯¹ Rollup çš„åŸºç¡€æ¦‚å¿µå’Œä½¿ç”¨æœ‰äº†åŸºæœ¬çš„æŒæ¡ã€‚åŒæ—¶æˆ‘ä»¬ä¹ŸçŸ¥é“ï¼Œä»…ä»…ä½¿ç”¨ Rollup å†…ç½®çš„æ‰“åŒ…èƒ½åŠ›å¾ˆéš¾æ»¡è¶³é¡¹ç›®æ—¥ç›Šå¤æ‚çš„æ„å»ºéœ€æ±‚ã€‚å¯¹äºä¸€ä¸ªçœŸå®çš„é¡¹ç›®æ„å»ºåœºæ™¯æ¥è¯´ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘åˆ°`æ¨¡å—æ‰“åŒ…`ä¹‹å¤–çš„é—®é¢˜ï¼Œæ¯”å¦‚**è·¯å¾„åˆ«å(alias)** ã€**å…¨å±€å˜é‡æ³¨å…¥**å’Œ**ä»£ç å‹ç¼©**ç­‰ç­‰ã€‚

å¯è¦æ˜¯æŠŠè¿™äº›åœºæ™¯çš„å¤„ç†é€»è¾‘ä¸æ ¸å¿ƒçš„æ‰“åŒ…é€»è¾‘éƒ½å†™åˆ°ä¸€èµ·ï¼Œä¸€æ¥æ‰“åŒ…å™¨æœ¬èº«çš„ä»£ç ä¼šå˜å¾—ååˆ†è‡ƒè‚¿ï¼ŒäºŒæ¥ä¹Ÿä¼šå¯¹åŸæœ‰çš„æ ¸å¿ƒä»£ç äº§ç”Ÿä¸€å®šçš„ä¾µå…¥æ€§ï¼Œæ··å…¥å¾ˆå¤šä¸æ ¸å¿ƒæµç¨‹æ— å…³çš„ä»£ç ï¼Œä¸æ˜“äºåæœŸçš„ç»´æŠ¤ã€‚å› æ­¤ ï¼ŒRollup è®¾è®¡å‡ºäº†ä¸€å¥—å®Œæ•´çš„**æ’ä»¶æœºåˆ¶**ï¼Œå°†è‡ªèº«çš„æ ¸å¿ƒé€»è¾‘ä¸æ’ä»¶é€»è¾‘åˆ†ç¦»ï¼Œè®©ä½ èƒ½æŒ‰éœ€å¼•å…¥æ’ä»¶åŠŸèƒ½ï¼Œæé«˜äº† Rollup è‡ªèº«çš„å¯æ‰©å±•æ€§ã€‚

æˆ‘ä¸ªäººä¹Ÿéå¸¸å–œæ¬¢ Rollup çš„æ’ä»¶æœºåˆ¶ï¼ŒåŠŸèƒ½å®Œå¤‡åˆç®€å•æ˜“ä¸Šæ‰‹ï¼Œä½“ç°äº† Rollup æœ¬èº«å°è€Œç¾çš„é£æ ¼ã€‚é‚£æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šå¸¦ä½ åˆ†æ Rollup çš„æ’ä»¶æœºåˆ¶ï¼Œç†Ÿæ‚‰ Rollup æ’ä»¶çš„å®Œæ•´æ„å»ºé˜¶æ®µå’Œå·¥ä½œæµç¨‹ï¼Œå¹¶ä¸”ç»“åˆæ¡ˆä¾‹æ·±å…¥æ’ä»¶å¼€å‘ç»†èŠ‚ã€‚

Rollup çš„æ‰“åŒ…è¿‡ç¨‹ä¸­ï¼Œä¼šå®šä¹‰ä¸€å¥—å®Œæ•´çš„æ„å»ºç”Ÿå‘½å‘¨æœŸï¼Œä»å¼€å§‹æ‰“åŒ…åˆ°äº§ç‰©è¾“å‡ºï¼Œä¸­é€”ä¼šç»å†ä¸€äº›**æ ‡å¿—æ€§çš„é˜¶æ®µ**ï¼Œå¹¶ä¸”åœ¨ä¸åŒé˜¶æ®µä¼šè‡ªåŠ¨æ‰§è¡Œå¯¹åº”çš„æ’ä»¶é’©å­å‡½æ•°(Hook)ã€‚å¯¹ Rollup æ’ä»¶æ¥è®²ï¼Œæœ€é‡è¦çš„éƒ¨åˆ†æ˜¯é’©å­å‡½æ•°ï¼Œä¸€æ–¹é¢å®ƒå®šä¹‰äº†æ’ä»¶çš„æ‰§è¡Œé€»è¾‘ï¼Œä¹Ÿå°±æ˜¯"åšä»€ä¹ˆ"ï¼›å¦ä¸€æ–¹é¢ä¹Ÿå£°æ˜äº†æ’ä»¶çš„ä½œç”¨é˜¶æ®µï¼Œå³"ä»€ä¹ˆæ—¶å€™åš"ï¼Œè¿™ä¸ Rollup æœ¬èº«çš„æ„å»ºç”Ÿå‘½å‘¨æœŸæ¯æ¯ç›¸å…³ã€‚

å› æ­¤ï¼Œè¦çœŸæ­£ç†è§£æ’ä»¶çš„ä½œç”¨èŒƒå›´å’Œé˜¶æ®µï¼Œé¦–å…ˆéœ€è¦äº†è§£ Rollup æ•´ä½“çš„æ„å»ºè¿‡ç¨‹ä¸­åˆ°åº•åšäº†äº›ä»€ä¹ˆã€‚



## Rollup æ•´ä½“æ„å»ºé˜¶æ®µ

åœ¨æ‰§è¡Œ `rollup` å‘½ä»¤ä¹‹åï¼Œåœ¨ cli å†…éƒ¨çš„ä¸»è¦é€»è¾‘ç®€åŒ–å¦‚ä¸‹:

```js {1,4,7}
// 1ï¸âƒ£ Build é˜¶æ®µ
const bundle = await rollup.rollup(inputOptions)

// 2ï¸âƒ£ Output é˜¶æ®µ
await Promise.all(outputOptions.map(bundle.write))

// 3ï¸âƒ£ æ„å»ºç»“æŸ
await bundle.close()
```

Rollupå†…éƒ¨ä¸»è¦ç»å†äº† `Build` å’Œ `Output` ä¸¤å¤§é˜¶æ®µï¼š

![Rollupæ„å»ºé˜¶æ®µ](./imgs/11-1.webp)

é¦–å…ˆï¼ŒBuild é˜¶æ®µä¸»è¦è´Ÿè´£åˆ›å»ºæ¨¡å—ä¾èµ–å›¾ï¼Œåˆå§‹åŒ–å„ä¸ªæ¨¡å—çš„ AST ä»¥åŠæ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚ä¸‹é¢æˆ‘ä»¬ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥æ„Ÿå—ä¸€ä¸‹:

```js
// src/index.js
import { a } from './module-a';
console.log(a);

// src/module-a.js
export const a = 1;
```

ç„¶åæ‰§è¡Œå¦‚ä¸‹çš„æ„å»ºè„šæœ¬:

```js
import { rollup } from 'rollup'
import { inspect } from 'node:util'

async function build() {
  const bundle = await rollup({
    input: ['./src/index.js']
  })
  console.log(inspect(bundle))

}

build()

```

å¯ä»¥çœ‹åˆ°è¿™æ ·çš„ `bundle` å¯¹è±¡ä¿¡æ¯:

```js
{
  cache: {
     modules: [
      {
        ast: 'AST èŠ‚ç‚¹ä¿¡æ¯ï¼Œå…·ä½“å†…å®¹çœç•¥',
        code: 'export const a = 1;',
        dependencies: [],
        id: '/Users/code/rollup-demo/src/module-a.js',
        resolveIds: {},
        // å…¶å®ƒå±æ€§çœç•¥
      },
      {
        ast: 'AST èŠ‚ç‚¹ä¿¡æ¯ï¼Œå…·ä½“å†…å®¹çœç•¥',
        code: "import { a } from './module-a.js';\n\nconsole.log(a);",
        dependencies: [
          '/Users/code/rollup-demo/src/module-a.js'
        ],
        id: '/Users/code/rollup-demo/src/index.js',
        resolveIds: {
          './module-a.js': {
            assertions: {},
            external: false,
            id: '/Users/code/rollup-demo/src/module-a.js',
            meta: {},
            moduleSideEffects: true,
            resolvedBy: 'rollup',
            syntheticNamedExports: false
          },
        }
        // å…¶å®ƒå±æ€§çœç•¥
      }
    ],
    plugins: [Object: null prototype] {}
  },
  closed: false,
  // æŒ‚è½½åç»­é˜¶æ®µä¼šæ‰§è¡Œçš„æ–¹æ³•
  close: [AsyncFunction: close],
  generate: [AsyncFunction: generate],
  write: [AsyncFunction: write]
  
  watchFiles: [
    '/Users/code/rollup-demo/src/index.js',
    '/Users/code/rollup-demo/src/module-a.js'
  ],
}
```

ä»ä¸Šé¢çš„ä¿¡æ¯ä¸­å¯ä»¥çœ‹å‡ºï¼Œç›®å‰ç»è¿‡ Build é˜¶æ®µçš„ `bundle` å¯¹è±¡å…¶å®å¹¶æ²¡æœ‰è¿›è¡Œæ¨¡å—çš„æ‰“åŒ…ï¼Œè¿™ä¸ªå¯¹è±¡çš„ä½œç”¨åœ¨äºå­˜å‚¨å„ä¸ªæ¨¡å—çš„å†…å®¹åŠä¾èµ–å…³ç³»ï¼ŒåŒæ—¶æš´éœ²`generate`å’Œ`write`æ–¹æ³•ï¼Œä»¥è¿›å…¥åˆ°åç»­çš„ `Output` é˜¶æ®µï¼ˆ`write`å’Œ`generate`æ–¹æ³•å”¯ä¸€çš„åŒºåˆ«åœ¨äºå‰è€…æ‰“åŒ…å®Œäº§ç‰©ä¼šå†™å…¥ç£ç›˜ï¼Œè€Œåè€…ä¸ä¼šï¼‰ã€‚

æ‰€ä»¥ï¼ŒçœŸæ­£è¿›è¡Œæ‰“åŒ…çš„è¿‡ç¨‹ä¼šåœ¨ `Output` é˜¶æ®µè¿›è¡Œï¼Œå³åœ¨`bundle`å¯¹è±¡çš„ `generate`æˆ–è€…`write`æ–¹æ³•ä¸­è¿›è¡Œã€‚è¿˜æ˜¯ä»¥ä¸Šé¢çš„ demo ä¸ºä¾‹ï¼Œæˆ‘ä»¬ç¨ç¨æ”¹åŠ¨ä¸€ä¸‹æ„å»ºé€»è¾‘:

```js {7-9}
import { rollup } from 'rollup'

async function build() {
  const bundle = await rollup({
    input: ['./src/module-b.js']
  })
  const result = await bundle.generate({
    format: 'es'
  })
  console.log(result)
}

build()
```

æ‰§è¡Œåå¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„è¾“å‡º:

```js
{
  output: [
    {
      exports: [],
      facadeModuleId: '/Users/code/rollup-demo/src/index.js',
      isDynamicEntry: false,
      isEntry: true,
      isImplicitEntry: false,
      moduleIds: [Array],
      name: 'index.js',
      type: 'chunk',
      dynamicImports: [],
      fileName: 'index.js',
      implicitlyLoadedBefore: [],
      importedBindings: {},
      imports: [],
      modules: [Object: null prototype],
      referencedFiles: [],
      code: 'const a = 1;\n\nconsole.log(a);\n',
      map: null
    }
  ]
```

è¿™é‡Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„è¾“å‡ºä¿¡æ¯ï¼Œç”Ÿæˆçš„`output`æ•°ç»„å³ä¸ºæ‰“åŒ…å®Œæˆçš„ç»“æœã€‚å½“ç„¶ï¼Œå¦‚æœä½¿ç”¨ `bundle.write` ä¼šæ ¹æ®é…ç½®å°†æœ€åçš„äº§ç‰©å†™å…¥åˆ°æŒ‡å®šçš„ç£ç›˜ç›®å½•ä¸­ã€‚

å› æ­¤ï¼Œ**å¯¹äºä¸€æ¬¡å®Œæ•´çš„æ„å»ºè¿‡ç¨‹è€Œè¨€ï¼Œ** **Rollup** **ä¼šå…ˆè¿›å…¥åˆ° Build é˜¶æ®µï¼Œè§£æå„æ¨¡å—çš„å†…å®¹åŠä¾èµ–å…³ç³»ï¼Œç„¶åè¿›å…¥**`Output`**é˜¶æ®µï¼Œå®Œæˆæ‰“åŒ…åŠè¾“å‡ºçš„è¿‡ç¨‹**ã€‚å¯¹äºä¸åŒçš„é˜¶æ®µï¼ŒRollup æ’ä»¶ä¼šæœ‰ä¸åŒçš„æ’ä»¶å·¥ä½œæµç¨‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥æ‹†è§£ä¸€ä¸‹ Rollup æ’ä»¶åœ¨ `Build` å’Œ `Output` ä¸¤ä¸ªé˜¶æ®µçš„è¯¦ç»†å·¥ä½œæµç¨‹ã€‚



## æ‹†è§£æ’ä»¶å·¥ä½œæµ



### è°ˆè°ˆæ’ä»¶ Hook ç±»å‹

åœ¨å…·ä½“è®²è¿° Rollup æ’ä»¶å·¥ä½œæµä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆç»™å¤§å®¶ä»‹ç»ä¸€ä¸‹ä¸åŒæ’ä»¶ Hook çš„ç±»å‹ï¼Œè¿™äº›ç±»å‹ä»£è¡¨äº†ä¸åŒæ’ä»¶çš„æ‰§è¡Œç‰¹ç‚¹ï¼Œæ˜¯æˆ‘ä»¬ç†è§£ Rollup æ’ä»¶å·¥ä½œæµçš„åŸºç¡€ï¼Œå› æ­¤æœ‰å¿…è¦è·Ÿå¤§å®¶å¥½å¥½æ‹†è§£ä¸€ä¸‹ã€‚

é€šè¿‡ä¸Šæ–‡çš„ä¾‹å­ï¼Œç›¸ä¿¡ä½ å¯ä»¥ç›´è§‚åœ°ç†è§£ Rollup ä¸¤å¤§æ„å»ºé˜¶æ®µï¼ˆ`Build`å’Œ`Output`ï¼‰å„è‡ªçš„åŸç†ã€‚å¯èƒ½ä½ ä¼šæœ‰ç–‘é—®ï¼Œè¿™ä¸¤ä¸ªé˜¶æ®µåˆ°åº•è·Ÿæ’ä»¶æœºåˆ¶æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿå®é™…ä¸Šï¼Œæ’ä»¶çš„å„ç§ Hook å¯ä»¥æ ¹æ®è¿™ä¸¤ä¸ªæ„å»ºé˜¶æ®µåˆ†ä¸ºä¸¤ç±»: `Build Hook` ä¸ `Output Hook`:

- `Build Hook`å³åœ¨`Build`é˜¶æ®µæ‰§è¡Œçš„é’©å­å‡½æ•°ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µä¸»è¦è¿›è¡Œæ¨¡å—ä»£ç çš„è½¬æ¢ã€AST è§£æä»¥åŠæ¨¡å—ä¾èµ–çš„è§£æï¼Œé‚£ä¹ˆè¿™ä¸ªé˜¶æ®µçš„ Hook å¯¹äºä»£ç çš„æ“ä½œç²’åº¦ä¸€èˆ¬ä¸º`æ¨¡å—`çº§åˆ«ï¼Œä¹Ÿå°±æ˜¯å•æ–‡ä»¶çº§åˆ«
- `Ouput Hook`(å®˜æ–¹ç§°ä¸º`Output Generation Hook`)ï¼Œåˆ™ä¸»è¦è¿›è¡Œä»£ç çš„æ‰“åŒ…ï¼Œå¯¹äºä»£ç è€Œè¨€ï¼Œæ“ä½œç²’åº¦ä¸€èˆ¬ä¸º `chunk`çº§åˆ«(ä¸€ä¸ª chunk é€šå¸¸æŒ‡å¾ˆå¤šæ–‡ä»¶æ‰“åŒ…åˆ°ä¸€èµ·çš„äº§ç‰©)

é™¤äº†æ ¹æ®æ„å»ºé˜¶æ®µå¯ä»¥å°† Rollup æ’ä»¶è¿›è¡Œåˆ†ç±»ï¼Œæ ¹æ®ä¸åŒçš„ Hook æ‰§è¡Œæ–¹å¼ä¹Ÿä¼šæœ‰ä¸åŒçš„åˆ†ç±»ï¼Œä¸»è¦åŒ…æ‹¬`Async`ã€`Sync`ã€`Parallel`ã€`Squential`ã€`First`è¿™äº”ç§ã€‚åœ¨åæ–‡ä¸­æˆ‘ä»¬å°†æ¥è§¦å„ç§å„æ ·çš„æ’ä»¶ Hookï¼Œä½†æ— è®ºå“ªä¸ª Hook éƒ½ç¦»ä¸å¼€è¿™äº”ç§æ‰§è¡Œæ–¹å¼ã€‚



#### **1. Async & Sync**

é¦–å…ˆæ˜¯`Async`å’Œ`Sync`é’©å­å‡½æ•°ï¼Œä¸¤è€…å…¶å®æ˜¯ç›¸å¯¹çš„ï¼Œåˆ†åˆ«ä»£è¡¨`å¼‚æ­¥`å’Œ`åŒæ­¥`çš„é’©å­å‡½æ•°ï¼Œä¸¤è€…æœ€å¤§çš„åŒºåˆ«åœ¨äºåŒæ­¥é’©å­é‡Œé¢ä¸èƒ½æœ‰å¼‚æ­¥é€»è¾‘ï¼Œè€Œå¼‚æ­¥é’©å­å¯ä»¥æœ‰ã€‚



#### **2. Parallel**

è¿™é‡ŒæŒ‡å¹¶è¡Œçš„é’©å­å‡½æ•°ã€‚å¦‚æœæœ‰å¤šä¸ªæ’ä»¶å®ç°äº†è¿™ä¸ªé’©å­çš„é€»è¾‘ï¼Œä¸€æ—¦æœ‰é’©å­å‡½æ•°æ˜¯å¼‚æ­¥é€»è¾‘ï¼Œåˆ™å¹¶å‘æ‰§è¡Œé’©å­å‡½æ•°ï¼Œä¸ä¼šç­‰å¾…å½“å‰é’©å­å®Œæˆ(åº•å±‚ä½¿ç”¨ `Promise.all`)ã€‚

æ¯”å¦‚å¯¹äº`Build`é˜¶æ®µçš„`buildStart`é’©å­ï¼Œå®ƒçš„æ‰§è¡Œæ—¶æœºå…¶å®æ˜¯åœ¨æ„å»ºåˆšå¼€å§‹çš„æ—¶å€™ï¼Œå„ä¸ªæ’ä»¶å¯ä»¥åœ¨è¿™ä¸ªé’©å­å½“ä¸­åšä¸€äº›çŠ¶æ€çš„åˆå§‹åŒ–æ“ä½œï¼Œä½†å…¶å®æ’ä»¶ä¹‹é—´çš„æ“ä½œå¹¶ä¸æ˜¯ç›¸äº’ä¾èµ–çš„ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œä»è€Œæå‡æ„å»ºæ€§èƒ½ã€‚åä¹‹ï¼Œå¯¹äºéœ€è¦**ä¾èµ–å…¶ä»–æ’ä»¶å¤„ç†ç»“æœ**çš„æƒ…å†µå°±ä¸é€‚åˆç”¨ `Parallel` é’©å­äº†ï¼Œæ¯”å¦‚ `transform`ã€‚



#### **3. Sequential**

**Sequential** æŒ‡ä¸²è¡Œçš„é’©å­å‡½æ•°ã€‚è¿™ç§ Hook å¾€å¾€é€‚ç”¨äºæ’ä»¶é—´å¤„ç†ç»“æœç›¸äº’ä¾èµ–çš„æƒ…å†µï¼Œå‰ä¸€ä¸ªæ’ä»¶ Hook çš„è¿”å›å€¼ä½œä¸ºåç»­æ’ä»¶çš„å…¥å‚ï¼Œè¿™ç§æƒ…å†µå°±éœ€è¦ç­‰å¾…å‰ä¸€ä¸ªæ’ä»¶æ‰§è¡Œå®Œ Hookï¼Œè·å¾—å…¶æ‰§è¡Œç»“æœï¼Œç„¶åæ‰èƒ½è¿›è¡Œä¸‹ä¸€ä¸ªæ’ä»¶ç›¸åº” Hook çš„è°ƒç”¨ï¼Œå¦‚`transform`ã€‚



#### **4. First**

å¦‚æœæœ‰å¤šä¸ªæ’ä»¶å®ç°äº†è¿™ä¸ª Hookï¼Œé‚£ä¹ˆ Hook å°†ä¾æ¬¡è¿è¡Œï¼Œç›´åˆ°è¿”å›ä¸€ä¸ªé `null` æˆ–é `undefined` çš„å€¼ä¸ºæ­¢ã€‚æ¯”è¾ƒå…¸å‹çš„ Hook æ˜¯ `resolveId`ï¼Œä¸€æ—¦æœ‰æ’ä»¶çš„ resolveId è¿”å›äº†ä¸€ä¸ªè·¯å¾„ï¼Œå°†åœæ­¢æ‰§è¡Œåç»­æ’ä»¶çš„ resolveId é€»è¾‘ã€‚

åˆšåˆšæˆ‘ä»¬ä»‹ç»äº† Rollup å½“ä¸­ä¸åŒæ’ä»¶ Hook çš„ç±»å‹ï¼Œå®é™…ä¸Šä¸åŒçš„ç±»å‹æ˜¯å¯ä»¥å åŠ çš„ï¼Œ`Async`/`Sync` å¯ä»¥æ­é…åé¢ä¸‰ç§ç±»å‹ä¸­çš„ä»»æ„ä¸€ç§ï¼Œæ¯”å¦‚ä¸€ä¸ª Hookæ—¢å¯ä»¥æ˜¯ `Async` ä¹Ÿå¯ä»¥æ˜¯ `First` ç±»å‹ï¼Œæ¥ç€æˆ‘ä»¬å°†æ¥å…·ä½“åˆ†æ Rollup å½“ä¸­çš„æ’ä»¶å·¥ä½œæµç¨‹ï¼Œé‡Œé¢ä¼šæ¶‰åŠåˆ°å…·ä½“çš„ä¸€äº› Hookï¼Œå¤§å®¶å¯ä»¥å…·ä½“åœ°æ„Ÿå—ä¸€ä¸‹ã€‚



### Build é˜¶æ®µå·¥ä½œæµ

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥åˆ†æ Build é˜¶æ®µçš„æ’ä»¶å·¥ä½œæµç¨‹ã€‚å¯¹äº Build é˜¶æ®µï¼Œæ’ä»¶ Hook çš„è°ƒç”¨æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æµç¨‹å›¾çš„æœ€ä¸Šé¢å£°æ˜äº†ä¸åŒ Hook çš„ç±»å‹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ä¸Šé¢æ€»ç»“çš„ 5 ç§ Hook åˆ†ç±»ï¼Œæ¯ä¸ªæ–¹å—ä»£è¡¨äº†ä¸€ä¸ª Hookï¼Œè¾¹æ¡†çš„é¢œè‰²å¯ä»¥è¡¨ç¤º`Async`å’Œ`Sync` ç±»å‹ï¼Œæ–¹å—çš„å¡«å……é¢œè‰²å¯ä»¥è¡¨ç¤º`Parallel`ã€`Sequential` å’Œ`First` ç±»å‹ã€‚

![Rollup Build Phase](./imgs/11-2.webp)

ä¹ä¸€çœ‹æ˜¯ä¸æ˜¯æ„Ÿè§‰è¿™å¼ å›¾éå¸¸å¤æ‚ï¼Ÿæ²¡å…³ç³»ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šå’Œä½ ä¸€æ­¥æ­¥åˆ†æ `Build Hooks` çš„å·¥ä½œæµç¨‹ï¼Œä½ å¯ä»¥å¯¹ç…§ç€å›¾ä¸€èµ·çœ‹:

1. é¦–å…ˆç»å† `options` é’©å­è¿›è¡Œé…ç½®çš„è½¬æ¢ï¼Œå¾—åˆ°å¤„ç†åçš„é…ç½®å¯¹è±¡ã€‚
2. éšä¹‹ Rollup ä¼šè°ƒç”¨`buildStart`é’©å­ï¼Œæ­£å¼å¼€å§‹æ„å»ºæµç¨‹ã€‚
3. Rollup å…ˆè¿›å…¥åˆ° `resolveId` é’©å­ä¸­è§£ææ–‡ä»¶è·¯å¾„ã€‚(ä» `input` é…ç½®æŒ‡å®šçš„å…¥å£æ–‡ä»¶å¼€å§‹)ã€‚
4. Rollup é€šè¿‡è°ƒç”¨`load`é’©å­åŠ è½½æ¨¡å—å†…å®¹ã€‚
5. ç´§æ¥ç€ Rollup æ‰§è¡Œæ‰€æœ‰çš„ `transform` é’©å­æ¥å¯¹æ¨¡å—å†…å®¹è¿›è¡Œè¿›è¡Œè‡ªå®šä¹‰çš„è½¬æ¢ï¼Œæ¯”å¦‚ babel è½¬è¯‘ã€‚
6. ç°åœ¨ Rollup æ‹¿åˆ°æœ€åçš„æ¨¡å—å†…å®¹ï¼Œè¿›è¡Œ AST åˆ†æï¼Œå¾—åˆ°æ‰€æœ‰çš„ import å†…å®¹ï¼Œè°ƒç”¨ `moduleParsed` é’©å­:
   1. å¦‚æœæ˜¯æ™®é€šçš„ importï¼Œåˆ™æ‰§è¡Œ `resolveId` é’©å­ï¼Œç»§ç»­å›åˆ°æ­¥éª¤`3`ã€‚
   2. å¦‚æœæ˜¯åŠ¨æ€ importï¼Œåˆ™æ‰§è¡Œ `resolveDynamicImport` é’©å­è§£æè·¯å¾„ï¼Œå¦‚æœè§£ææˆåŠŸï¼Œåˆ™å›åˆ°æ­¥éª¤`4`åŠ è½½æ¨¡å—ï¼Œå¦åˆ™å›åˆ°æ­¥éª¤`3`é€šè¿‡ `resolveId` è§£æè·¯å¾„ã€‚
7. ç›´åˆ°æ‰€æœ‰çš„ import éƒ½è§£æå®Œæ¯•ï¼ŒRollup æ‰§è¡Œ`buildEnd`é’©å­ï¼ŒBuild é˜¶æ®µç»“æŸã€‚

å½“ç„¶ï¼Œåœ¨ Rollup è§£æè·¯å¾„çš„æ—¶å€™ï¼Œå³æ‰§è¡Œ`resolveId`æˆ–è€…`resolveDynamicImport`çš„æ—¶å€™ï¼Œæœ‰äº›è·¯å¾„å¯èƒ½ä¼šè¢«æ ‡è®°ä¸º`external`(ç¿»è¯‘ä¸º`æ’é™¤`)ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸å‚åŠ  Rollup æ‰“åŒ…è¿‡ç¨‹ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¸ä¼šè¿›è¡Œ`load`ã€`transform`ç­‰ç­‰åç»­çš„å¤„ç†äº†ã€‚

åœ¨æµç¨‹å›¾æœ€ä¸Šé¢ï¼Œä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰æ³¨æ„åˆ°`watchChange`å’Œ`closeWatcher`è¿™ä¸¤ä¸ª Hookï¼Œè¿™é‡Œå…¶å®æ˜¯å¯¹åº”äº† rollup çš„`watch`æ¨¡å¼ã€‚å½“ä½ ä½¿ç”¨ `rollup --watch` æŒ‡ä»¤æˆ–è€…åœ¨é…ç½®æ–‡ä»¶é…æœ‰`watch: true`çš„å±æ€§æ—¶ï¼Œä»£è¡¨å¼€å¯äº† Rollup çš„`watch`æ‰“åŒ…æ¨¡å¼ï¼Œè¿™ä¸ªæ—¶å€™ Rollup å†…éƒ¨ä¼šåˆå§‹åŒ–ä¸€ä¸ª `watcher` å¯¹è±¡ï¼Œå½“æ–‡ä»¶å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œwatcher å¯¹è±¡ä¼šè‡ªåŠ¨è§¦å‘`watchChange`é’©å­æ‰§è¡Œå¹¶å¯¹é¡¹ç›®è¿›è¡Œé‡æ–°æ„å»ºã€‚åœ¨å½“å‰**æ‰“åŒ…è¿‡ç¨‹ç»“æŸ**æ—¶ï¼ŒRollup ä¼šè‡ªåŠ¨æ¸…é™¤ watcher å¯¹è±¡è°ƒç”¨`closeWacher`é’©å­ã€‚





### Output é˜¶æ®µå·¥ä½œæµ

å¥½ï¼Œæ¥ç€æˆ‘ä»¬æ¥çœ‹çœ‹ Output é˜¶æ®µçš„æ’ä»¶åˆ°åº•æ˜¯å¦‚ä½•æ¥è¿›è¡Œå·¥ä½œçš„ã€‚è¿™ä¸ªé˜¶æ®µçš„ Hook ç›¸æ¯”äº Build é˜¶æ®µç¨å¾®å¤šä¸€äº›ï¼Œæµç¨‹ä¸Šä¹Ÿæ›´åŠ å¤æ‚ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå…¶ä¸­ä¼šæ¶‰åŠçš„ Hook å‡½æ•°æ¯”è¾ƒå¤šï¼Œå¯èƒ½ä¼šç»™ä½ ç†è§£æ•´ä¸ªæµç¨‹å¸¦æ¥ä¸€äº›å›°æ‰°ï¼Œå› æ­¤æˆ‘ä¼šåœ¨ Hook æ‰§è¡Œçš„é˜¶æ®µè§£é‡Šå…¶å¤§è‡´çš„ä½œç”¨å’Œæ„ä¹‰ï¼Œå…³äºå…·ä½“çš„ä½¿ç”¨å¤§å®¶å¯ä»¥å» Rollup çš„å®˜ç½‘è‡ªè¡ŒæŸ¥é˜…ï¼Œæ¯•ç«Ÿè¿™é‡Œçš„ä¸»çº¿è¿˜æ˜¯åˆ†ææ’ä»¶çš„æ‰§è¡Œæµç¨‹ï¼Œæºæ‚å¤ªå¤šçš„ä½¿ç”¨ç»†èŠ‚åè€Œä¸æ˜“äºç†è§£ã€‚ä¸‹é¢æˆ‘ç»“åˆä¸€å¼ å®Œæ•´çš„æ’ä»¶æµç¨‹å›¾å’Œä½ å…·ä½“åˆ†æä¸€ä¸‹ã€‚

![Rollup Output Phase](./imgs/11-3.webp)

1. æ‰§è¡Œæ‰€æœ‰æ’ä»¶çš„ `outputOptions` é’©å­å‡½æ•°ï¼Œå¯¹ `output` é…ç½®è¿›è¡Œè½¬æ¢ã€‚

2. æ‰§è¡Œ `renderStart`ï¼Œå¹¶å‘æ‰§è¡Œ renderStart é’©å­ï¼Œæ­£å¼å¼€å§‹æ‰“åŒ…ã€‚

3. å¹¶å‘æ‰§è¡Œæ‰€æœ‰æ’ä»¶çš„`banner`ã€`footer`ã€`intro`ã€`outro` é’©å­(åº•å±‚ç”¨ Promise.all åŒ…è£¹æ‰€æœ‰çš„è¿™å››ç§é’©å­å‡½æ•°)ï¼Œè¿™å››ä¸ªé’©å­åŠŸèƒ½å¾ˆç®€å•ï¼Œå°±æ˜¯å¾€æ‰“åŒ…äº§ç‰©çš„å›ºå®šä½ç½®(æ¯”å¦‚å¤´éƒ¨å’Œå°¾éƒ¨)æ’å…¥ä¸€äº›è‡ªå®šä¹‰çš„å†…å®¹ï¼Œæ¯”å¦‚åè®®å£°æ˜å†…å®¹ã€é¡¹ç›®ä»‹ç»ç­‰ç­‰ã€‚

4. ä»å…¥å£æ¨¡å—å¼€å§‹æ‰«æï¼Œé’ˆå¯¹åŠ¨æ€ import è¯­å¥æ‰§è¡Œ `renderDynamicImport`é’©å­ï¼Œæ¥è‡ªå®šä¹‰åŠ¨æ€ import çš„å†…å®¹ã€‚

5. å¯¹æ¯ä¸ªå³å°†ç”Ÿæˆçš„ `chunk`ï¼Œæ‰§è¡Œ `augmentChunkHash`é’©å­ï¼Œæ¥å†³å®šæ˜¯å¦æ›´æ”¹ chunk çš„å“ˆå¸Œå€¼ï¼Œåœ¨ `watch` æ¨¡å¼ä¸‹å³å¯èƒ½ä¼šå¤šæ¬¡æ‰“åŒ…çš„åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªé’©å­ä¼šæ¯”è¾ƒé€‚ç”¨ã€‚

6. å¦‚æœæ²¡æœ‰é‡åˆ° `import.meta` è¯­å¥ï¼Œåˆ™è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œå¦åˆ™:

   1. å¯¹äº `import.meta.url` è¯­å¥è°ƒç”¨ `resolveFileUrl` æ¥è‡ªå®šä¹‰ url è§£æé€»è¾‘
   2. å¯¹äºå…¶ä»–`import.meta` å±æ€§ï¼Œåˆ™è°ƒç”¨ `resolveImportMeta` æ¥è¿›è¡Œè‡ªå®šä¹‰çš„è§£æã€‚

7. æ¥ç€ Rollup ä¼šç”Ÿæˆæ‰€æœ‰ chunk çš„å†…å®¹ï¼Œé’ˆå¯¹æ¯ä¸ª chunk ä¼šä¾æ¬¡è°ƒç”¨æ’ä»¶çš„`renderChunk`æ–¹æ³•è¿›è¡Œè‡ªå®šä¹‰æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è¿™é‡Œæ—¶å€™ä½ å¯ä»¥ç›´æ¥æ“ä½œæ‰“åŒ…äº§ç‰©äº†

8. éšåä¼šè°ƒç”¨ `generateBundle` é’©å­ï¼Œè¿™ä¸ªé’©å­çš„å…¥å‚é‡Œé¢ä¼šåŒ…å«æ‰€æœ‰çš„æ‰“åŒ…äº§ç‰©ä¿¡æ¯ï¼ŒåŒ…æ‹¬ `chunk` (æ‰“åŒ…åçš„ä»£ç )ã€`asset`(æœ€ç»ˆçš„é™æ€èµ„æºæ–‡ä»¶)ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œåˆ é™¤ä¸€äº› chunk æˆ–è€… assetï¼Œæœ€ç»ˆè¿™äº›å†…å®¹å°†ä¸ä¼šä½œä¸ºäº§ç‰©è¾“å‡ºã€‚

9. å‰é¢æåˆ°äº†`rollup.rollup`æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª`bundle`å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯åŒ…å«`generate`å’Œ`write`ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸¤ä¸ªæ–¹æ³•å”¯ä¸€çš„åŒºåˆ«åœ¨äºåè€…ä¼šå°†ä»£ç å†™å…¥åˆ°ç£ç›˜ä¸­ï¼ŒåŒæ—¶ä¼šè§¦å‘`writeBundle`é’©å­ï¼Œä¼ å…¥æ‰€æœ‰çš„æ‰“åŒ…äº§ç‰©ä¿¡æ¯ï¼ŒåŒ…æ‹¬ chunk å’Œ assetï¼Œå’Œ `generateBundle`é’©å­éå¸¸ç›¸ä¼¼ã€‚ä¸è¿‡å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªé’©å­æ‰§è¡Œçš„æ—¶å€™ï¼Œäº§ç‰©å·²ç»è¾“å‡ºäº†ï¼Œè€Œ generateBundle æ‰§è¡Œçš„æ—¶å€™äº§ç‰©è¿˜å¹¶æ²¡æœ‰è¾“å‡ºã€‚é¡ºåºå¦‚ä¸‹å›¾æ‰€ç¤º:

   ![generateBundle vs writeBundle](./imgs/11-4.webp)

10. å½“ä¸Šè¿°çš„`bundle`çš„`close`æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šè§¦å‘`closeBundle`é’©å­ï¼Œåˆ°è¿™é‡Œ Output é˜¶æ®µæ­£å¼ç»“æŸã€‚

::: warning

æ³¨æ„: å½“æ‰“åŒ…è¿‡ç¨‹ä¸­ä»»ä½•é˜¶æ®µå‡ºç°é”™è¯¯ï¼Œä¼šè§¦å‘ renderError é’©å­ï¼Œç„¶åæ‰§è¡ŒcloseBundleé’©å­ç»“æŸæ‰“åŒ…ã€‚

:::

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ç»ˆäºæ¢³ç†å®Œäº† Rollup å½“ä¸­å®Œæ•´çš„æ’ä»¶å·¥ä½œæµç¨‹ï¼Œä»ä¸€å¼€å§‹åœ¨**æ„å»ºç”Ÿå‘½å‘¨æœŸ**ä¸­å¯¹ä¸¤å¤§æ„å»ºé˜¶æ®µçš„æ„Ÿæ€§è®¤è¯†ï¼Œåˆ°ç°åœ¨**æ’ä»¶å·¥ä½œæµ**çš„å…·ä½“åˆ†æï¼Œä¸ç¦æ„Ÿå¹ Rollup çœ‹ä¼¼ç®€å•ï¼Œå®åˆ™å†…éƒ¨ç»†èŠ‚ç¹æ‚ã€‚å¸Œæœ›ä½ èƒ½å¯¹ç…§æµç¨‹å›¾å¥½å¥½å¤ä¹ å‡ éï¼Œå½»åº•æ¶ˆåŒ–è¿™éƒ¨åˆ†çš„çŸ¥è¯†ç‚¹ï¼Œä¸ä»…ä»…èƒ½åŠ æ·±ä½ å¯¹ Rollup æ’ä»¶æœºåˆ¶çš„ç†è§£ï¼Œå¹¶ä¸”å¯¹ Rollup æœ¬èº«æ‰“åŒ…åŸç†çš„æŒæ¡ä¹Ÿä¼šæ›´ä¸Šä¸€å±‚æ¥¼ã€‚



## å¸¸ç”¨ Hook å®æˆ˜

è¯»åˆ°è¿™é‡Œä½ å¯èƒ½ä¼šè¯´äº†ï¼šä¸Šé¢è®²äº†é‚£ä¹ˆå¤š Rollup æ’ä»¶æœºåˆ¶çš„å†…å®¹ï¼Œä½†çœŸæ­£è¦å»å†™ä¸€ä¸ªæ’ä»¶ï¼Œæ„Ÿè§‰è¿˜æ˜¯å¾ˆå›°éš¾å•Šã€‚

è¿™é‡Œæˆ‘æƒ³è¦åˆ†äº«ä¸¤ä¸ªè§‚ç‚¹ï¼šé¦–å…ˆæ˜¯**äºŒå…«å®šå¾‹**ï¼Œä¹Ÿå°±æ˜¯ 20% çš„ API åº”å¯¹ 80% çš„åœºæ™¯ï¼Œè¿™æ”¾åœ¨ Rollup å½“ä¸­ä»ç„¶æ˜¯é€‚ç”¨çš„ã€‚ç»å¸¸ä½¿ç”¨åˆ°çš„ Hook ä¹Ÿå¹¶ä¸å¤šï¼Œå†µä¸” Rollup æ’ä»¶çš„å†™æ³•ä¹Ÿéå¸¸ç®€å•ï¼Œè‡³å°‘æ¯” Webpack æ’ä»¶è¦å®¹æ˜“çš„å¤šï¼Œå› æ­¤æŒæ¡ Rollup çš„æ’ä»¶å¼€å‘éš¾åº¦å¹¶ä¸å¤§ï¼Œè¿™ä¸ªå¤§å®¶æ”¾å¿ƒã€‚

å…¶æ¬¡ï¼Œ**å­¦ä¼šæ¨¡ä»¿**ä¹Ÿç‰¹åˆ«é‡è¦ã€‚å°¤å…¶æ˜¯åˆšå¼€å§‹ä»€ä¹ˆç»éªŒéƒ½æ²¡æœ‰çš„æ—¶å€™ï¼Œè§‚å¯Ÿå’Œæ¨¡ä»¿åˆ«äººä¼˜ç§€çš„å®ç°ä¸å¤±ä¸ºä¸€ç§é«˜æ•ˆçš„å­¦ä¹ æ–¹æ³•ï¼Œæ…¢æ…¢åœ°è‡ªå·±ä¹Ÿä¼šè½»è½¦ç†Ÿè·¯ï¼Œæˆä¸ºä¸€ä¸ªç»éªŒä¸°å¯Œçš„è€å¸æœºã€‚

å®é™…ä¸Šå¼€å‘ Rollup æ’ä»¶å°±æ˜¯åœ¨ç¼–å†™ä¸€ä¸ªä¸ª Hook å‡½æ•°ï¼Œä½ å¯ä»¥ç†è§£ä¸ºä¸€ä¸ª Rollup æ’ä»¶åŸºæœ¬å°±æ˜¯å„ç§ Hook å‡½æ•°çš„ç»„åˆã€‚å› æ­¤ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šè¯¦ç»†ä»‹ç»ä¸€äº›å¸¸ç”¨çš„ Hookï¼Œå¹¶ä»¥ä¸€äº›å®˜æ–¹çš„æ’ä»¶å®ç°ä¸ºä¾‹ï¼Œä» Hook çš„ç‰¹æ€§ã€åº”ç”¨åœºæ™¯ã€å…¥å‚å’Œè¿”å›å€¼çš„æ„ä¹‰åŠå®ç°ä»£ç ç¤ºä¾‹è¿™å‡ ä¸ªè§’åº¦å¸¦ä½ æŒæ¡å„ç§ Hook å®é™…çš„ä½¿ç”¨ï¼Œå¦‚æ­¤ä¸€æ¥ï¼Œå¼€å‘ä¸€ä¸ªå®Œæ•´çš„æ’ä»¶å¯¹ä½ æ¥è¯´æƒ³å¿…ä¹Ÿä¸åœ¨è¯ä¸‹äº†ã€‚



### **è·¯å¾„è§£æ: resolveId**

resolveId é’©å­ä¸€èˆ¬ç”¨æ¥è§£ææ¨¡å—è·¯å¾„ï¼Œä¸º`Async + First`ç±»å‹å³`å¼‚æ­¥ä¼˜å…ˆ`çš„é’©å­ã€‚è¿™é‡Œæˆ‘ä»¬æ‹¿å®˜æ–¹çš„ [alias æ’ä»¶](https://github.com/rollup/plugins/blob/master/packages/alias/src/index.ts) æ¥è¯´æ˜ï¼Œè¿™ä¸ªæ’ä»¶ç”¨æ³•æ¼”ç¤ºå¦‚ä¸‹:

```js
// rollup.config.js
import alias from '@rollup/plugin-alias';

module.exports = {
  input: 'src/index.js',
  output: {
    dir: 'output',
    format: 'cjs'
  },
  plugins: [
    alias({
      entries: [
        // å°†æŠŠ import xxx from 'module-a' 
        // è½¬æ¢ä¸º import xxx from './module-a'
        { find: 'module-a', replacement: './module-a.js' },
      ]
    })
  ]
};
```

æ’ä»¶çš„ä»£ç ç®€åŒ–åå¦‚ä¸‹:

```js
export default alias(options) {
  // è·å–entriesé…ç½®
  const entries = getEntries(options)
  return {
    // ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼Œå½“å‰æ¨¡å—è·¯å¾„ã€å¼•ç”¨å½“å‰æ¨¡å—çš„æ¨¡å—è·¯å¾„ã€å…¶ä½™å‚æ•°
    resolveId(importee, importer, resolveOptions) {
      // å…ˆæ£€æŸ¥èƒ½ä¸èƒ½åŒ¹é…åˆ«åè§„åˆ™
      const matchedEntry = entries.find(entry => matches(entry.find, importee))
      // å¦‚æœä¸èƒ½åŒ¹é…æ›¿æ¢è§„åˆ™ï¼Œæˆ–è€…å½“å‰æ¨¡å—æ˜¯å…¥å£æ¨¡å—ï¼Œåˆ™ä¸ä¼šç»§ç»­åé¢çš„åˆ«åæ›¿æ¢æµç¨‹
      if (!matchedEntry || !importerId) {
        // ğŸ“š return null åï¼Œå½“å‰çš„æ¨¡å—è·¯å¾„ä¼šäº¤ç»™ä¸‹ä¸€ä¸ªæ’ä»¶å¤„ç†
        return null
      }
      // æ­£å¼æ›¿æ¢è·¯å¾„
      const updatedId = normalizeId(
        importee.replace(matchedEntry.find, matchedEntry.replacement)
      )
      // ğŸ“š æ¯ä¸ªæ’ä»¶æ‰§è¡Œæ—¶éƒ½ä¼šç»‘å®šä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ä½œä¸º this
      // è¿™é‡Œçš„ this.resolve ä¼šæ‰§è¡Œæ‰€æœ‰æ’ä»¶(é™¤å½“å‰æ’ä»¶å¤–)çš„ resolveId é’©å­
      return this.resolve(
        updateId,
        importer,
        Object.assign({ skipSelf: true }, resolveOptions)
      ).then((resolved) => {
        // æ›¿æ¢åçš„è·¯å¾„å³ updateId ä¼šç»è¿‡åˆ«çš„æ’ä»¶è¿›è¡Œå¤„ç†
        let finalResult: PartialResolvedId | null = resolved
        if (!finalResult) {
          // å¦‚æœå…¶å®ƒæ’ä»¶æ²¡æœ‰å¤„ç†è¿™ä¸ªè·¯å¾„ï¼Œåˆ™ç›´æ¥è¿”å› updateId
          finalResult = { id: updatedId }
        }
        return finalResult
      })
    }
  }
}
```

ä»è¿™é‡Œä½ å¯ä»¥çœ‹åˆ° resolveId é’©å­å‡½æ•°çš„ä¸€äº›å¸¸ç”¨ä½¿ç”¨æ–¹å¼ï¼Œå®ƒçš„å…¥å‚åˆ†åˆ«æ˜¯`å½“å‰æ¨¡å—è·¯å¾„`ã€`å¼•ç”¨å½“å‰æ¨¡å—çš„æ¨¡å—è·¯å¾„`ã€`è§£æå‚æ•°`ï¼Œè¿”å›å€¼å¯ä»¥æ˜¯ nullã€string æˆ–è€…ä¸€ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬åˆ†æƒ…å†µè®¨è®º:

- è¿”å›å€¼ä¸º null æ—¶ï¼Œä¼šé»˜è®¤äº¤ç»™ä¸‹ä¸€ä¸ªæ’ä»¶çš„ resolveId é’©å­å¤„ç†
- è¿”å›å€¼ä¸º string æ—¶ï¼Œåˆ™åœæ­¢åç»­æ’ä»¶çš„å¤„ç†ã€‚è¿™é‡Œä¸ºäº†è®©æ›¿æ¢åçš„è·¯å¾„èƒ½è¢«å…¶ä»–æ’ä»¶å¤„ç†ï¼Œç‰¹æ„è°ƒç”¨äº† this.resolve æ¥äº¤ç»™å…¶å®ƒæ’ä»¶å¤„ç†ï¼Œå¦åˆ™å°†ä¸ä¼šè¿›å…¥åˆ°å…¶å®ƒæ’ä»¶çš„å¤„ç†
- è¿”å›å€¼ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿä¼šåœæ­¢åç»­æ’ä»¶çš„å¤„ç†ï¼Œä¸è¿‡è¿™ä¸ªå¯¹è±¡å°±å¯ä»¥åŒ…å«[æ›´å¤šçš„ä¿¡æ¯](https://rollupjs.org/plugin-development/#resolveid)äº†ï¼ŒåŒ…æ‹¬è§£æåçš„è·¯å¾„ã€æ˜¯å¦è¢« enternalã€æ˜¯å¦éœ€è¦ tree-shaking ç­‰ç­‰ï¼Œä¸è¿‡å¤§éƒ¨åˆ†æƒ…å†µä¸‹è¿”å›ä¸€ä¸ª string å°±å¤Ÿç”¨äº†



### **load**

load ä¸º`Async + First`ç±»å‹ï¼Œå³**å¼‚æ­¥ä¼˜å…ˆ**çš„é’©å­ï¼Œå’Œ`resolveId`ç±»ä¼¼ã€‚å®ƒçš„ä½œç”¨æ˜¯é€šè¿‡ resolveId è§£æåçš„è·¯å¾„æ¥åŠ è½½æ¨¡å—å†…å®¹ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ä»¥å®˜æ–¹çš„ [image æ’ä»¶](https://github.com/rollup/plugins/blob/master/packages/image/src/index.js) ä¸ºä¾‹æ¥ä»‹ç»ä¸€ä¸‹ load é’©å­çš„ä½¿ç”¨ã€‚æºç ç®€åŒ–åå¦‚ä¸‹æ‰€ç¤º:

```js
const mimeTypes = {
  '.jpg': 'image/jpeg',
  // åé¢å›¾ç‰‡ç±»å‹çœç•¥
};

export default function image(opts = {}) {
  const options = Object.assign({}, defaults, opts);
  return {
    name: 'image',
    load(id) {
      const mime = mimeTypes[extname(id)];
      if (!mime) {
        // å¦‚æœä¸æ˜¯å›¾ç‰‡ç±»å‹ï¼Œè¿”å› nullï¼Œäº¤ç»™ä¸‹ä¸€ä¸ªæ’ä»¶å¤„ç†
        return null;
      }
      // åŠ è½½å›¾ç‰‡å…·ä½“å†…å®¹
      const isSvg = mime === mimeTypes['.svg'];
      const format = isSvg ? 'utf-8' : 'base64';
      const source = readFileSync(id, format).replace(/[\r\n]+/gm, '');
      const dataUri = getDataUri({ format, isSvg, mime, source });
      const code = options.dom ? domTemplate({ dataUri }) : constTemplate({ dataUri });

      return code.trim();
    }
  };
}
```

ä»ä¸­å¯ä»¥çœ‹åˆ°ï¼Œload é’©å­çš„å…¥å‚æ˜¯æ¨¡å— idï¼Œè¿”å›å€¼ä¸€èˆ¬æ˜¯ nullã€string æˆ–è€…ä¸€ä¸ªå¯¹è±¡ï¼š

- å¦‚æœè¿”å›å€¼ä¸º nullï¼Œåˆ™äº¤ç»™ä¸‹ä¸€ä¸ªæ’ä»¶å¤„ç†ï¼›
- å¦‚æœè¿”å›å€¼ä¸º string æˆ–è€…å¯¹è±¡ï¼Œåˆ™ç»ˆæ­¢åç»­æ’ä»¶çš„å¤„ç†ï¼Œå¦‚æœæ˜¯å¯¹è±¡å¯ä»¥åŒ…å« SourceMapã€AST ç­‰[æ›´è¯¦ç»†çš„ä¿¡æ¯](https://rollupjs.org/plugin-development/#load)ã€‚



### **ä»£ç è½¬æ¢: transform**

`transform` é’©å­ä¹Ÿæ˜¯éå¸¸å¸¸è§çš„ä¸€ä¸ªé’©å­å‡½æ•°ï¼Œä¸º`Async + Sequential`ç±»å‹ï¼Œä¹Ÿå°±æ˜¯`å¼‚æ­¥ä¸²è¡Œ`é’©å­ï¼Œä½œç”¨æ˜¯å¯¹åŠ è½½åçš„æ¨¡å—å†…å®¹è¿›è¡Œè‡ªå®šä¹‰çš„è½¬æ¢ã€‚æˆ‘ä»¬ä»¥å®˜æ–¹çš„ `replace` æ’ä»¶ä¸ºä¾‹ï¼Œè¿™ä¸ªæ’ä»¶çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹:

```js
// rollup.config.js
import replace from '@rollup/plugin-replace';

module.exports = {
  input: 'src/index.js',
  output: {
    dir: 'output',
    format: 'cjs'
  },
  plugins: [
    // å°†ä¼šæŠŠä»£ç ä¸­æ‰€æœ‰çš„ __TEST__ æ›¿æ¢ä¸º 1
    replace({
      __TEST__: 1
    })
  ]
};
```

å†…éƒ¨å®ç°ä¹Ÿå¹¶ä¸å¤æ‚ï¼Œä¸»è¦é€šè¿‡å­—ç¬¦ä¸²æ›¿æ¢æ¥å®ç°ï¼Œæ ¸å¿ƒé€»è¾‘ç®€åŒ–å¦‚ä¸‹:

```js
import MagicString from 'magic-string';

export default function replace(options = {}) {
  return {
    name: 'replace',
    transform(code, id) {
      // çœç•¥ä¸€äº›è¾¹ç•Œæƒ…å†µçš„å¤„ç†
      // æ‰§è¡Œä»£ç æ›¿æ¢çš„é€»è¾‘ï¼Œå¹¶ç”Ÿæˆæœ€åçš„ä»£ç å’Œ SourceMap
      return executeReplacement(code, id);
    }
  }
}

function executeReplacement(code, id) {
  const magicString = new MagicString(code);
  // é€šè¿‡ magicString.overwrite æ–¹æ³•å®ç°å­—ç¬¦ä¸²æ›¿æ¢
  if (!codeHasReplacements(code, id, magicString)) {
    return null;
  }

  const result = { code: magicString.toString() };

  if (isSourceMapEnabled()) {
    result.map = magicString.generateMap({ hires: true });
  }

  // è¿”å›ä¸€ä¸ªå¸¦æœ‰ code å’Œ map å±æ€§çš„å¯¹è±¡
  return result;
}
```

[transform é’©å­](https://rollupjs.org/plugin-development/#transform)çš„å…¥å‚åˆ†åˆ«ä¸º`æ¨¡å—ä»£ç `ã€`æ¨¡å— ID`ï¼Œè¿”å›ä¸€ä¸ªåŒ…å« `code`(ä»£ç å†…å®¹) å’Œ `map`(SourceMap å†…å®¹) å±æ€§çš„å¯¹è±¡ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è¿”å› null æ¥è·³è¿‡å½“å‰æ’ä»¶çš„ transform å¤„ç†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**å½“å‰æ’ä»¶è¿”å›çš„ä»£ç ä¼šä½œä¸ºä¸‹ä¸€ä¸ªæ’ä»¶ transform é’©å­çš„ç¬¬ä¸€ä¸ªå…¥å‚**ï¼Œå®ç°ç±»ä¼¼äºç€‘å¸ƒæµçš„å¤„ç†ã€‚



### **Chunk çº§ä»£ç ä¿®æ”¹: renderChunk**

è¿™é‡Œæˆ‘ä»¬ç»§ç»­ä»¥`replace`æ’ä»¶ä¸¾ä¾‹ï¼Œåœ¨è¿™ä¸ªæ’ä»¶ä¸­ï¼Œä¹ŸåŒæ ·å®ç°äº† renderChunk é’©å­å‡½æ•°:

```js {7}
export default function replace(options = {}) {
  return {
    name: 'replace',
    transform(code, id) {
      // transform ä»£ç çœç•¥
    },
    renderChunk(code, chunk) {
      const id = chunk.fileName;
      // çœç•¥ä¸€äº›è¾¹ç•Œæƒ…å†µçš„å¤„ç†
      // æ‹¿åˆ° chunk çš„ä»£ç åŠæ–‡ä»¶åï¼Œæ‰§è¡Œæ›¿æ¢é€»è¾‘
      return executeReplacement(code, id);
    },
  }
}
```

å¯ä»¥çœ‹åˆ°è¿™é‡Œ replace æ’ä»¶ä¸ºäº†æ›¿æ¢ç»“æœæ›´åŠ å‡†ç¡®ï¼Œåœ¨ [renderChunké’©å­](https://rollupjs.org/plugin-development/#renderchunk) ä¸­åˆè¿›è¡Œäº†ä¸€æ¬¡æ›¿æ¢ï¼Œå› ä¸ºåç»­çš„æ’ä»¶ä»ç„¶å¯èƒ½åœ¨ transform ä¸­è¿›è¡Œæ¨¡å—å†…å®¹è½¬æ¢ï¼Œè¿›è€Œå¯èƒ½å‡ºç°ç¬¦åˆæ›¿æ¢è§„åˆ™çš„å­—ç¬¦ä¸²ã€‚

è¿™é‡Œæˆ‘ä»¬æŠŠå…³æ³¨ç‚¹æ”¾åˆ° renderChunk å‡½æ•°æœ¬èº«ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªå…¥å‚ï¼Œåˆ†åˆ«ä¸º `chunk ä»£ç å†…å®¹`ã€[chunk å…ƒä¿¡æ¯](https://rollupjs.org/plugin-development/#generatebundle)ï¼Œè¿”å›å€¼è·Ÿ `transform` é’©å­ç±»ä¼¼ï¼Œæ—¢å¯ä»¥è¿”å›åŒ…å« code å’Œ map å±æ€§çš„å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è¿”å› null æ¥è·³è¿‡å½“å‰é’©å­çš„å¤„ç†ã€‚



### **äº§ç‰©ç”Ÿæˆæœ€åä¸€æ­¥: generateBundle**

generateBundle ä¹Ÿæ˜¯`å¼‚æ­¥ä¸²è¡Œ`çš„é’©å­ï¼Œä½ å¯ä»¥åœ¨è¿™ä¸ªé’©å­é‡Œé¢è‡ªå®šä¹‰åˆ é™¤ä¸€äº›æ— ç”¨çš„ chunk æˆ–è€…é™æ€èµ„æºï¼Œæˆ–è€…è‡ªå·±æ·»åŠ ä¸€äº›æ–‡ä»¶ã€‚è¿™é‡Œæˆ‘ä»¬ä»¥ Rollup å®˜æ–¹çš„`html`æ’ä»¶æ¥å…·ä½“è¯´æ˜ï¼Œè¿™ä¸ªæ’ä»¶çš„ä½œç”¨æ˜¯é€šè¿‡æ‹¿åˆ° Rollup æ‰“åŒ…åçš„èµ„æºæ¥ç”ŸæˆåŒ…å«è¿™äº›èµ„æºçš„ HTML æ–‡ä»¶ï¼Œæºç ç®€åŒ–åå¦‚ä¸‹æ‰€ç¤º:

```typescript
export default function html(opts: RollupHtmlOptions = {}): Plugin {
  // åˆå§‹åŒ–é…ç½®
  return {
    name: 'html',
    async generateBundle(output: NormalizedOutputOptions, bundle: OutputBundle) {
      // çœç•¥ä¸€äº›è¾¹ç•Œæƒ…å†µçš„å¤„ç†
      // 1. è·å–æ‰“åŒ…åçš„æ–‡ä»¶
      const files = getFiles(bundle);
      // 2. ç»„è£… HTMLï¼Œæ’å…¥ç›¸åº” metaã€link å’Œ script æ ‡ç­¾
      const source = await template({ attributes, bundle, files, meta, publicPath, title});
      // 3. é€šè¿‡ä¸Šä¸‹æ–‡å¯¹è±¡çš„ emitFile æ–¹æ³•ï¼Œè¾“å‡º html æ–‡ä»¶
      const htmlFile: EmittedAsset = {
        type: 'asset',
        source,
        name: 'Rollup HTML Asset',
        fileName
      };
      this.emitFile(htmlFile);
    }
  }
}
```

ç›¸ä¿¡ä»æ’ä»¶çš„å…·ä½“å®ç°ä¸­ï¼Œä½ ä¹Ÿèƒ½æ„Ÿå—åˆ°è¿™ä¸ªé’©å­çš„å¼ºå¤§ä½œç”¨äº†ã€‚å…¥å‚åˆ†åˆ«ä¸º`output é…ç½®`ã€[æ‰€æœ‰æ‰“åŒ…äº§ç‰©çš„å…ƒä¿¡æ¯å¯¹è±¡](https://rollupjs.org/plugin-development/#generatebundle)ï¼Œé€šè¿‡æ“ä½œå…ƒä¿¡æ¯å¯¹è±¡ä½ å¯ä»¥åˆ é™¤ä¸€äº›ä¸éœ€è¦çš„ chunk æˆ–è€…é™æ€èµ„æºï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ’ä»¶ä¸Šä¸‹æ–‡å¯¹è±¡çš„`emitFile`æ–¹æ³•è¾“å‡ºè‡ªå®šä¹‰æ–‡ä»¶ã€‚

å¥½ï¼Œå¸¸ç”¨çš„ Rollup é’©å­æˆ‘ä»¬å°±å…ˆä»‹ç»åˆ°è¿™é‡Œï¼Œç›¸ä¿¡è¿™äº›çŸ¥è¯†ç‚¹å·²ç»è¶³å¤Ÿä½ åº”ä»˜å¤§å¤šæ•°çš„æ„å»ºåœºæ™¯äº†ã€‚é¡ºä¾¿è¯´ä¸€å¥ï¼Œå¤§å®¶åœ¨åé¢çš„ç« èŠ‚å¯ä»¥äº†è§£åˆ°ï¼ŒVite çš„æ’ä»¶æœºåˆ¶ä¹Ÿæ˜¯åŸºäº Rollup æ¥å®ç°çš„ï¼Œåƒä¸Šé¢ä»‹ç»çš„è¿™äº›å¸¸ç”¨é’©å­åœ¨ Vite å½“ä¸­ä¹Ÿéšå¤„å¯è§ï¼Œå› æ­¤ï¼ŒæŒæ¡äº†è¿™äº›å¸¸ç”¨é’©å­ï¼Œä¹Ÿç›¸å½“äºç»™ Vite æ’ä»¶çš„å­¦ä¹ åšä¸‹äº†å¾ˆå¥½çš„é“ºå«ã€‚



## å°ç»“

å¥½ï¼Œåˆ°è¿™é‡Œæœ¬ç¯‡çš„å†…å®¹å°±ç»“æŸäº†ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆè®¤è¯†åˆ° Rollup ä¸ºäº†è¿½æ±‚æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œå¼•å…¥äº†æ’ä»¶æœºåˆ¶ï¼Œè€Œåç»™ä½ ä»‹ç»äº† Rollup çš„ `Build` å’Œ`Output` ä¸¤å¤§æ„å»ºé˜¶æ®µï¼Œæ¥ç€ç»™ä½ è¯¦ç»†åœ°åˆ†æäº†ä¸¤å¤§æ„å»ºé˜¶æ®µçš„æ’ä»¶å·¥ä½œæµï¼Œæœ€åé€šè¿‡å‡ ä¸ªå®é™…çš„å®˜æ–¹æ’ä»¶å¸¦ä½ ç†Ÿæ‚‰äº†ä¸€äº›å¸¸è§çš„ Hookã€‚

![Rollupæ’ä»¶å¸¸ç”¨Hooks](./imgs/11-5.webp)

Rollup çš„æ’ä»¶å¼€å‘æ•´ä½“ä¸Šæ˜¯éå¸¸ç®€æ´å’Œçµæ´»çš„ï¼Œæ€»ç»“ä¸ºä»¥ä¸‹å‡ ä¸ªæ–¹é¢:

1. **æ’ä»¶é€»è¾‘é›†ä¸­ç®¡ç†**ã€‚å„ä¸ªé˜¶æ®µçš„ Hook éƒ½å¯ä»¥æ”¾åœ¨ä¸€ä¸ªæ’ä»¶ä¸­ç¼–å†™ï¼Œæ¯”å¦‚ä¸Šè¿°ä¸¤ä¸ª Webpack çš„ Loader å’Œ Plugin åŠŸèƒ½åœ¨ Rollup åªéœ€è¦ç”¨ä¸€ä¸ªæ’ä»¶ï¼Œåˆ†åˆ«é€šè¿‡ transform å’Œ renderChunk ä¸¤ä¸ª Hook æ¥å®ç°ã€‚
2. **æ’ä»¶ API ç®€æ´ï¼Œç¬¦åˆç›´è§‰**ã€‚Rollup æ’ä»¶åŸºæœ¬ä¸Šåªéœ€è¦è¿”å›ä¸€ä¸ªåŒ…å« name å’Œå„ç§é’©å­å‡½æ•°çš„å¯¹è±¡å³å¯ï¼Œä¹Ÿå°±æ˜¯å£°æ˜ä¸€ä¸ª name å±æ€§ï¼Œç„¶åå†™å‡ ä¸ªé’©å­å‡½æ•°å³å¯ã€‚
3. **æ’ä»¶é—´çš„äº’ç›¸è°ƒç”¨**ã€‚æ¯”å¦‚åˆšåˆšä»‹ç»çš„`alias`æ’ä»¶ï¼Œå¯ä»¥é€šè¿‡æ’ä»¶ä¸Šä¸‹æ–‡å¯¹è±¡çš„`resolve`æ–¹æ³•ï¼Œç»§ç»­è°ƒç”¨å…¶å®ƒæ’ä»¶çš„ `resolveId`é’©å­ï¼Œç±»ä¼¼çš„è¿˜æœ‰`load`æ–¹æ³•ï¼Œè¿™å°±å¤§å¤§å¢åŠ äº†æ’ä»¶çš„çµæ´»æ€§ã€‚

ç°åœ¨ï¼Œç›¸ä¿¡ä½ å·²ç»ä»å®è§‚åˆ°ç»†èŠ‚ä¸Šï¼Œå·²ç»å¯¹ Rollup æ’ä»¶æœ‰äº†å…¨é¢çš„æŒæ¡ï¼Œä¸ºæ¥ä¸‹æ¥çš„ Vite å­¦ä¹ æ‰“ä¸‹äº†åšå®çš„åŸºç¡€ã€‚å¦‚æœä½ è¿˜æ²¡æœ‰å®Œå…¨æŒæ¡ï¼Œä¸ç”¨ç€æ€¥ï¼Œè¿™éƒ¨åˆ†çš„å†…å®¹æœ¬èº«æœ‰ç‚¹éš¾åº¦ï¼Œå¸Œæœ›ä½ èƒ½å›å¤´å¤ä¹ å‡ éï¼Œç›¸ä¿¡ä½ ä¸€å®šèƒ½å½»åº•æ‹¿ä¸‹è¿™äº›å†…å®¹ã€‚å¤§å®¶åŠ æ²¹å§ï¼



å‚è€ƒé“¾æ¥ï¼š

- [Rollupå®˜ç½‘ Pluginå¼€å‘](https://rollupjs.org/plugin-development/#plugins-overview)



2023å¹´02æœˆ16æ—¥11:30:38

---
title: æè‡´æ€§èƒ½ä¼˜åŒ–æŠ€å·§
---

å‰é¢ç« èŠ‚æˆ‘ä»¬å·²ç»è¯¦ç»†æ¢è®¨ Webpack ä¸­å¦‚ä½•ä½¿ç”¨åˆ†åŒ…ã€ä»£ç å‹ç¼©æå‡åº”ç”¨æ‰§è¡Œæ€§èƒ½ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸å°‘æ™®é€‚ã€ç»†ç¢çš„æ–¹æ³•ï¼Œèƒ½å¤Ÿæœ‰æ•ˆé™ä½åº”ç”¨ä½“ç§¯ï¼Œæå‡ç½‘ç»œåˆ†å‘æ€§èƒ½ï¼ŒåŒ…æ‹¬ï¼š

1. ä½¿ç”¨åŠ¨æ€åŠ è½½ï¼Œå‡å°‘é¦–å±èµ„æºåŠ è½½é‡ï¼›
2. ä½¿ç”¨ `externals`ã€Tree-Shakingã€Scope Hoisting ç‰¹æ€§ï¼Œå‡å°‘åº”ç”¨ä½“ç§¯ï¼›
3. æ­£ç¡®ä½¿ç”¨ `[hash]` å ä½ç¬¦ï¼Œä¼˜åŒ– HTTP èµ„æºç¼“å­˜æ•ˆç‡ï¼›
4. ç­‰ç­‰ã€‚

ä¸‹é¢æˆ‘ä»¬ä¸€ä¸€å±•å¼€ï¼Œè§£é‡Šæ¯æ¡æœ€ä½³å®è·µä»¥åŠèƒŒåçš„é€»è¾‘ã€‚



## åŠ¨æ€åŠ è½½

Webpack é»˜è®¤ä¼šå°†åŒä¸€ä¸ª Entry ä¸‹çš„æ‰€æœ‰æ¨¡å—å…¨éƒ¨æ‰“åŒ…æˆä¸€ä¸ªäº§ç‰©æ–‡ä»¶ â€”â€” åŒ…æ‹¬é‚£äº›ä¸é¡µé¢ [å…³é”®æ¸²æŸ“è·¯å¾„](https://web.dev/critical-rendering-path/) æ— å…³çš„ä»£ç ï¼Œè¿™ä¼šå¯¼è‡´é¡µé¢åˆå§‹åŒ–æ—¶éœ€è¦èŠ±è´¹å¤šä½™æ—¶é—´å»ä¸‹è½½è¿™éƒ¨åˆ†æš‚æ—¶ç”¨ä¸ä¸Šçš„ä»£ç ï¼Œå½±å“é¦–å±æ¸²æŸ“æ€§èƒ½ï¼Œä¾‹å¦‚ï¼š

```js
import someBigMethod from './someBigMethod'

document.getElementById('someButton').addEventListener('click', () => {
  someBigMethod()
})
```

é€»è¾‘ä¸Šï¼Œç›´åˆ°ç‚¹å‡»é¡µé¢çš„ `someButton` æŒ‰é’®æ—¶æ‰ä¼šè°ƒç”¨ `someBigMethod` æ–¹æ³•ï¼Œå› æ­¤è¿™éƒ¨åˆ†ä»£ç æ²¡å¿…è¦å‡ºç°åœ¨é¦–å±èµ„æºåˆ—è¡¨ä¸­ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Webpack çš„åŠ¨æ€åŠ è½½åŠŸèƒ½å°†è¯¥æ¨¡å—æ›´æ”¹ä¸ºå¼‚æ­¥å¯¼å…¥ï¼Œä¿®æ”¹ä¸Šè¿°ä»£ç ï¼š

```js
document.getElementById('someButton').addEventListener('click', () => {
  const someBitMehtod = await import('./someBigMethod')
  someBigMethod()
})
```

æ­¤æ—¶ï¼Œé‡æ–°æ„å»ºå°†äº§ç”Ÿé¢å¤–çš„äº§ç‰©æ–‡ä»¶ `src_someBigMethod_js.js`ï¼Œè¿™ä¸ªæ–‡ä»¶ç›´åˆ°æ‰§è¡Œ `import` è¯­å¥æ—¶ â€”â€” ä¹Ÿå°±æ˜¯ä¸Šä¾‹ `someButton` è¢«ç‚¹å‡»æ—¶æ‰è¢«åŠ è½½åˆ°æµè§ˆå™¨ï¼Œä¹Ÿå°±ä¸ä¼šå½±å“åˆ°å…³é”®æ¸²æŸ“è·¯å¾„äº†ã€‚

åŠ¨æ€åŠ è½½æ˜¯ Webpack å†…ç½®èƒ½åŠ›ä¹‹ä¸€ï¼Œæˆ‘ä»¬ä¸éœ€è¦åšä»»ä½•é¢å¤–é…ç½®å°±å¯ä»¥é€šè¿‡åŠ¨æ€å¯¼å…¥è¯­å¥(`import`ã€`require.ensure`)è½»æ˜“å®ç°ã€‚

ğŸš¨ä½†è¯·æ³¨æ„ï¼Œè¿™ä¸€ç‰¹æ€§æœ‰æ—¶å€™åè€Œä¼šå¸¦æ¥ä¸€äº›æ–°çš„æ€§èƒ½é—®é¢˜ï¼š

- **ä¸€æ˜¯è¿‡åº¦ä½¿ç”¨ä¼šä½¿äº§ç‰©å˜å¾—è¿‡åº¦ç»†ç¢ï¼Œäº§ç‰©æ–‡ä»¶è¿‡å¤šï¼Œè¿è¡Œæ—¶ HTTP é€šè®¯æ¬¡æ•°ä¹Ÿä¼šå˜å¤š**ï¼Œåœ¨ HTTP 1.x ç¯å¢ƒä¸‹è¿™å¯èƒ½åè€Œä¼šé™ä½ç½‘ç»œæ€§èƒ½ï¼Œå¾—ä¸å¿å¤±ï¼›
- **äºŒæ˜¯ä½¿ç”¨æ—¶ Webpack éœ€è¦åœ¨å®¢æˆ·ç«¯æ³¨å…¥ä¸€å¤§æ®µç”¨äºæ”¯æŒåŠ¨æ€åŠ è½½ç‰¹æ€§çš„ Runtime**ï¼š

![webpack runtime](./imgs/15-1.webp)

è¿™æ®µä»£ç å³ä½¿ç»è¿‡å‹ç¼©ä¹Ÿé«˜è¾¾ 2.5KB å·¦å³ï¼Œå¦‚æœåŠ¨æ€å¯¼å…¥çš„ä»£ç é‡å°‘äºè¿™æ®µ Runtime ä»£ç çš„ä½“ç§¯ï¼Œé‚£å°±å®Œå…¨æ˜¯ä¸€ç¬”èµ”æœ¬ä¹°å–äº†ã€‚

- ğŸŒ°  [perf-lazy-load - @github](https://github.com/Tecvan-fe/webpack-book-samples/tree/main/perf-lazy-load)



å› æ­¤ï¼Œè¯·åŠ¡å¿…æ…é‡ï¼Œå¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬æ²¡å¿…è¦ä¸ºå°æ¨¡å—ä½¿ç”¨åŠ¨æ€åŠ è½½èƒ½åŠ›ï¼`ç›®å‰ç¤¾åŒºæ¯”è¾ƒå¸¸è§çš„ç”¨æ³•æ˜¯é…åˆ SPA çš„å‰ç«¯è·¯ç”±èƒ½åŠ›å®ç°é¡µé¢çº§åˆ«çš„åŠ¨æ€åŠ è½½`ï¼Œä¾‹å¦‚åœ¨ Vue ä¸­ï¼š

```js
import { createRouter, createWebHashHistory } from "vue-router";

const Home = () => import("./Home.vue");
const Foo = () => import(/* webpackChunkName: "sub-pages" */ "./Foo.vue");
const Bar = () => import(/* webpackChunkName: "sub-pages" */ "./Bar.vue");

// åŸºç¡€é¡µé¢
const routes = [
  { path: "/bar", name: "Bar", component: Bar },
  { path: "/foo", name: "Foo", component: Foo },
  { path: "/", name: "Home", component: Home },
];

const router = createRouter({
  history: createWebHashHistory(),
  routes,
});

export default router;
```

ç¤ºä¾‹ä¸­ï¼Œ`Home/Foo/Bar` ä¸‰ä¸ªç»„ä»¶å‡é€šè¿‡ `import()` è¯­å¥åŠ¨æ€å¯¼å…¥ï¼Œè¿™ä½¿å¾—ä»…å½“é¡µé¢åˆ‡æ¢åˆ°ç›¸åº”è·¯ç”±æ—¶æ‰ä¼šåŠ è½½å¯¹åº”ç»„ä»¶ä»£ç ã€‚å¦å¤–ï¼Œ`Foo` ä¸ `Bar` ç»„ä»¶çš„å¯¼å…¥è¯­å¥æ¯”è¾ƒç‰¹æ®Šï¼š

```js
import(/* webpackChunkName: "sub-pages" */ "./Bar.vue");
```

`webpackChunkName` ç”¨äºæŒ‡å®šè¯¥å¼‚æ­¥æ¨¡å—çš„ Chunk åç§°ï¼Œç›¸åŒ Chunk åç§°çš„æ¨¡å—æœ€ç»ˆä¼šæ‰“åŒ…åœ¨ä¸€èµ·ï¼Œè¿™ä¸€ç‰¹æ€§èƒ½å¸®åŠ©å¼€å‘è€…å°†ä¸€äº›å…³è”åº¦è¾ƒé«˜ï¼Œæˆ–æ¯”è¾ƒç»†ç¢çš„æ¨¡å—åˆå¹¶åˆ°åŒä¸€ä¸ªäº§ç‰©æ–‡ä»¶ï¼Œèƒ½å¤Ÿç”¨äºç®¡ç†æœ€ç»ˆäº§ç‰©æ•°é‡ã€‚

- ğŸŒ°  [perf-vue-lazy-load - @github](https://github.com/Tecvan-fe/webpack-book-samples/tree/main/perf-vue-lazy-load)



## HTTPç¼“å­˜ä¼˜åŒ–

æ³¨æ„ï¼ŒWebpack åªæ˜¯ä¸€ä¸ªå·¥ç¨‹åŒ–æ„å»ºå·¥å…·ï¼Œæ²¡æœ‰èƒ½åŠ›å†³å®šåº”ç”¨æœ€ç»ˆåœ¨ç½‘ç»œåˆ†å‘æ—¶çš„ç¼“å­˜è§„åˆ™ï¼Œä½†æˆ‘ä»¬å¯ä»¥è°ƒæ•´äº§ç‰©æ–‡ä»¶çš„åç§°(é€šè¿‡ Hash)ä¸å†…å®¹(é€šè¿‡ [Code Splitting](https://webpack.js.org/guides/code-splitting/))ï¼Œä½¿å…¶æ›´é€‚é… HTTP æŒä¹…åŒ–ç¼“å­˜ç­–ç•¥ã€‚Code Splitting ç›¸å…³çŸ¥è¯†å·²ç»åœ¨ [å‰é¢ç« èŠ‚](https://juejin.cn/book/7115598540721618944/section/7119035452643868672) åšäº†è¯¦å°½ä»‹ç»ï¼Œæœ¬æ–‡æ¥ç€èŠèŠæ–‡ä»¶å Hash è§„åˆ™ã€‚

::: info

Hash æ˜¯ä¸€ç§å°†ä»»æ„é•¿åº¦çš„æ¶ˆæ¯å‹ç¼©åˆ°æŸä¸€å›ºå®šé•¿åº¦çš„æ¶ˆæ¯æ‘˜è¦çš„å‡½æ•°ï¼Œä¸åŒæ˜æ–‡è®¡ç®—å‡ºçš„æ‘˜è¦å€¼ä¸åŒï¼Œæ‰€ä»¥å¸¸å¸¸è¢«ç”¨ä½œå†…å®¹å”¯ä¸€æ ‡è¯†ã€‚

:::

ğŸ“šWebpack æä¾›äº†ä¸€ç§æ¨¡æ¿å­—ç¬¦ä¸²([Template String](https://webpack.js.org/configuration/output/#template-strings))èƒ½åŠ›ï¼Œç”¨äºæ ¹æ®æ„å»ºæƒ…å†µåŠ¨æ€æ‹¼æ¥äº§ç‰©æ–‡ä»¶åç§°([output.filename](https://webpack.js.org/configuration/output/#outputfilename))ï¼Œè§„åˆ™ç¨å¾®æœ‰ç‚¹å¤æ‚ï¼Œä½†ä»æ€§èƒ½è§’åº¦çœ‹ï¼Œæ¯”è¾ƒå€¼å¾—å…³æ³¨çš„æ˜¯å…¶ä¸­çš„å‡ ä¸ª Hash å ä½ç¬¦ï¼ŒåŒ…æ‹¬ï¼š

1. `[fullhash]`ï¼šæ•´ä¸ªé¡¹ç›®çš„å†…å®¹ Hash å€¼ï¼Œé¡¹ç›®ä¸­ä»»æ„æ¨¡å—å˜åŒ–éƒ½ä¼šäº§ç”Ÿæ–°çš„ `fullhash`ï¼›
2. `[chunkhash]`ï¼šäº§ç‰©å¯¹åº” Chunk çš„ Hashï¼ŒChunk ä¸­ä»»æ„æ¨¡å—å˜åŒ–éƒ½ä¼šäº§ç”Ÿæ–°çš„ `chunkhash`ï¼›
3. `[contenthash]`ï¼šäº§ç‰©å†…å®¹ Hash å€¼ï¼Œä»…å½“äº§ç‰©å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šäº§ç”Ÿæ–°çš„ `contenthash`ï¼Œå› æ­¤å®ç”¨æ€§è¾ƒé«˜ã€‚âœ…

ç”¨æ³•å¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨ `output.filename` å€¼ä¸­æ’å…¥ç›¸åº”å ä½ç¬¦å³å¯ï¼Œå¦‚ `"[name]-[contenthash].js"`ã€‚æˆ‘ä»¬æ¥çœ‹ä¸ªå®Œæ•´ä¾‹å­ï¼Œå‡è®¾å¯¹äºä¸‹è¿°æºç ç»“æ„ï¼š

::: code-group

``` js [src/index.js]
import './index.css'

console.log('a')
```

``` js [src/foo.js]
console.log('foo')
```

```js [src/index.css]
body {
  font-size: 14px;
}
```

:::



webpacké…ç½®

::: code-group

``` js [webpack.config.js] {15,29}
const path = require('node:path')
const MiniCssExtractPlugin = require('mini-css-extract-plugin')

/**
 * @type {import('webpack').Configuration}
 */
module.exports = {
  mode: 'development',
  devtool: false,
  entry: {
    index: './src/index.js',
    foo: './src/foo.js'
  },
  output: {
    filename: '[name]-[contenthash].js',
    path: path.resolve(__dirname, 'dist'),
    clean: true,
  },
  module: {
    rules: [
      {
        test: /\.css$/,
        use: [MiniCssExtractPlugin.loader, 'css-loader']
      }
    ]
  },
  plugins: [
    new MiniCssExtractPlugin({
      filename: '[name]-[contenthash].css',
    })
  ]
}
```

:::

ç¤ºä¾‹åŒ…å« `index.js` ä¸ `foo.js` ä¸¤ä¸ªå…¥å£ï¼Œä¸”åˆ†åˆ«åœ¨ `ouput.filename` ä¸ `MiniCssExtractPlugin.filename` ä¸­ä½¿ç”¨ `[contenthash]` å ä½ç¬¦ï¼Œæœ€ç»ˆæ„å»ºç»“æœï¼š

![webpackå„ç§hash](./imgs/15-2.webp)

::: tip

ä¹Ÿå¯ä»¥é€šè¿‡å ä½ç¬¦ä¼ å…¥ Hash ä½æ•°ï¼Œå¦‚ `[contenthash:7]` ï¼Œå³å¯é™å®šç”Ÿæˆçš„ Hash é•¿åº¦ã€‚

:::

å¯ä»¥çœ‹åˆ°æ¯ä¸ªäº§ç‰©æ–‡ä»¶åéƒ½ä¼šå¸¦ä¸Šä¸€æ®µç”±äº§ç‰©å†…å®¹è®¡ç®—å‡ºçš„å”¯ä¸€ Hash å€¼ï¼Œæ–‡ä»¶å†…å®¹ä¸å˜ï¼ŒHash ä¹Ÿä¸ä¼šå˜åŒ–ï¼Œè¿™å°±å¾ˆé€‚åˆç”¨ä½œ HTTP [æŒä¹…ç¼“å­˜](https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching#expires_or_max-age) èµ„æºï¼š

```bash
# HTTP Response header

Cache-Control: max-age=31536000
```

æ­¤æ—¶ï¼Œäº§ç‰©æ–‡ä»¶ä¸ä¼šè¢«é‡å¤ä¸‹è½½ï¼Œä¸€ç›´åˆ°æ–‡ä»¶å†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œå¼•èµ· Hash å˜åŒ–ç”Ÿæˆä¸åŒ URL è·¯å¾„ä¹‹åï¼Œæ‰éœ€è¦è¯·æ±‚æ–°çš„èµ„æºæ–‡ä»¶ï¼Œèƒ½æœ‰æ•ˆæå‡ç½‘ç»œæ€§èƒ½ï¼Œå› æ­¤ï¼Œç”Ÿäº§ç¯å¢ƒä¸‹åº”å°½é‡ä½¿ç”¨ `[contenthash]` ç”Ÿæˆæœ‰ç‰ˆæœ¬æ„ä¹‰çš„æ–‡ä»¶åã€‚

- ğŸŒ° [perf-hash - @github](https://github.com/Tecvan-fe/webpack-book-samples/tree/main/perf-hash)



ğŸš¨Hash è§„åˆ™å¾ˆå¥½ç”¨ï¼Œä¸è¿‡æœ‰ä¸€ä¸ªè¾¹é™… Case éœ€è¦æ³¨æ„ï¼š**å¼‚æ­¥æ¨¡å—å˜åŒ–ä¼šå¼•èµ·ä¸» Chunk Hash åŒæ­¥å‘ç”Ÿå˜åŒ–**ï¼Œä¾‹å¦‚å¯¹äºä¸‹é¢è¿™ç§æ¨¡å—å…³ç³»ï¼š

![æ¨¡å—å…³ç³»](./imgs/15-3.webp)

 `src` ç›®å½•ä»£ç ï¼š

::: code-group

``` js [index.js]
import './sync-a' // åŒæ­¥
import './sync-b'

import('./async-a') // å¼‚æ­¥
```

``` js [sync-a.js]
export default 'sync-a'
```

```js [sync-b.js]
export default 'sync-b'
```

```js [sync-c.js]
export default 'sync-c'
```

```js [async-a.js]
import './sync-c'

export default 'async-a'
```

:::

æ„å»ºåå°†ç”Ÿæˆå…¥å£ `index.js` ä¸å¼‚æ­¥æ¨¡å— `async-a.js` ä¸¤ä¸ª Chunk å¯¹åº”çš„äº§ç‰©ï¼š

![async chunks](./imgs/15-4.webp)

æ­¤æ—¶ï¼Œè‹¥å¼‚æ­¥æ¨¡å— `async-a` æˆ–å…¶å­æ¨¡å— `sync-c` å‘ç”Ÿå˜åŒ–

```js
export default 'sync-c' // [!code --]
export default 'sync-c-diff' // [!code ++]
```

ç†è®ºä¸Šåº”è¯¥åªä¼šå½±å“ `src_async-a` çš„ Hash å€¼ï¼Œä½†å®é™…æ•ˆæœå´æ˜¯ï¼š

![async chunkså˜æ›´çš„å½±å“](./imgs/15-5.webp)

çˆ¶çº§ Chunk(`index`)ä¹Ÿå—åˆ°äº†å½±å“ï¼Œç”Ÿæˆæ–°çš„ Hash å€¼ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ `index` ä¸­éœ€è¦è®°å½•å¼‚æ­¥ Chunk çš„çœŸå®è·¯å¾„ï¼š

![async chunkså˜æ›´çš„å½±å“](./imgs/15-6.webp)

ğŸš€å¼‚æ­¥ Chunk çš„è·¯å¾„å˜åŒ–è‡ªç„¶ä¹Ÿå°±å¯¼è‡´äº†çˆ¶çº§ Chunk å†…å®¹å˜åŒ–ï¼Œæ­¤æ—¶å¯ä»¥ç”¨ `optimization.runtimeChunk` å°†è¿™éƒ¨åˆ†ä»£ç æŠ½å–ä¸ºå•ç‹¬çš„ Runtime Chunkï¼Œä¾‹å¦‚ï¼š

::: code-group

``` js [webpack.config.js]
module.exports = {
  entry: { index: "./src/index.js" },
  mode: "development",
  devtool: false,
  output: {
    filename: "[name]-[contenthash].js",
    path: path.resolve(__dirname, "dist")
  },
  // å°†è¿è¡Œæ—¶ä»£ç æŠ½å–åˆ° `runtime` æ–‡ä»¶ä¸­
  optimization: { runtimeChunk: { name: "runtime" } }, // [!code ++]
};
```

:::

::: info

åç»­ç« èŠ‚ä¸­æˆ‘ä»¬ä¼šä¸“é—¨è®²è§£ Initial Chunkã€Async Chunkã€Runtime Chunk ä¸‰ç§æ¦‚å¿µã€‚

:::

ä¹‹åï¼Œ`async-a.js` æ¨¡å—çš„å˜æ›´åªä¼šå½±å“ Runtime Chunk å†…å®¹ï¼Œä¸å†å½±å“ä¸» Chunkã€‚

![runtime](./imgs/15-7.webp)

::: tip

ç»¼ä¸Šï¼Œå»ºè®®è‡³å°‘ä¸ºç”Ÿæˆç¯å¢ƒå¯åŠ¨ `[contenthash]` åŠŸèƒ½ï¼Œå¹¶æ­é… `optimization.runtimeChunk` å°†è¿è¡Œæ—¶ä»£ç æŠ½ç¦»ä¸ºå•ç‹¬äº§ç‰©æ–‡ä»¶ã€‚

:::



## ä½¿ç”¨å¤–ç½®ä¾èµ–

è®¾æƒ³ä¸€ä¸ªåœºæ™¯ï¼Œå‡å¦‚æˆ‘ä»¬æ‰‹å¤´ä¸Šæœ‰ 10 ä¸ªç”¨ React æ„å»ºçš„ SPA åº”ç”¨ï¼Œè¿™ 10 ä¸ªåº”ç”¨éƒ½éœ€è¦å„è‡ªå®‰è£…ã€æ‰“åŒ…ã€éƒ¨ç½²ã€åˆ†å‘åŒä¸€å¥—ç›¸ä¼¼çš„ React åŸºç¡€ä¾èµ–ï¼Œæœ€ç»ˆç”¨æˆ·åœ¨è®¿é—®è¿™äº›åº”ç”¨æ—¶ä¹Ÿéœ€è¦é‡å¤åŠ è½½ç›¸åŒåŸºç¡€åŒ…ä»£ç ï¼Œé‚£æœ‰æ²¡æœ‰åŠæ³•èŠ‚çœè¿™éƒ¨åˆ†æµé‡å‘¢ï¼Ÿæœ‰ â€”â€” ä½¿ç”¨ Webpack çš„ `externals` ç‰¹æ€§ã€‚

`externals` çš„ä¸»è¦ä½œç”¨æ˜¯å°†éƒ¨åˆ†æ¨¡å—æ’é™¤åœ¨ Webpack æ‰“åŒ…ç³»ç»Ÿä¹‹å¤–ï¼Œä¾‹å¦‚ï¼š

```js
module.exports = {
  // ...
  externals: {
    lodash: "_",
  },
};
```

ä½¿ç”¨ä¸Šè¿°é…ç½®åï¼ŒWebpack ä¼š **é¢„è®¾** è¿è¡Œç¯å¢ƒä¸­å·²ç»å†…ç½® Lodash åº“ â€”â€” æ— è®ºæ˜¯é€šè¿‡ CDN è¿˜æ˜¯å…¶å®ƒæ–¹å¼æ³¨å…¥ï¼Œæ‰€ä»¥ä¸éœ€è¦å†å°†è¿™äº›æ¨¡å—æ‰“åŒ…åˆ°äº§ç‰©ä¸­ï¼š

![ä½¿ç”¨å’Œä¸ä½¿ç”¨externalå¯¹æ¯”](./imgs/15-8.webp)

::: tip

`externals` ä¸ä»…é€‚ç”¨äºä¼˜åŒ–äº§ç‰©æ€§èƒ½ï¼Œåœ¨ç‰¹å®šç¯å¢ƒä¸‹è¿˜èƒ½ç”¨äºè·³è¿‡è‹¥å¹²è¿è¡Œæ—¶æ¨¡å—ï¼Œä¾‹å¦‚ Node ä¸­çš„ `fs/net` ç­‰ï¼Œé¿å…å°†è¿™éƒ¨åˆ†æºç é”™è¯¯æ‰“åŒ…è¿› Bundleï¼Œè¯¦æƒ…å¯å‚è€ƒ [webpack-node-externals](https://www.npmjs.com/package/webpack-node-externals) å·¥å…·ã€‚

:::

ğŸš€æ³¨æ„ï¼Œä½¿ç”¨ `externals` æ—¶å¿…é¡»ç¡®ä¿è¿™äº›å¤–ç½®ä¾èµ–ä»£ç å·²ç»è¢«æ­£ç¡®æ³¨å…¥åˆ°ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­ï¼Œè¿™åœ¨ Web åº”ç”¨ä¸­é€šå¸¸å¯ä»¥é€šè¿‡ CDN æ–¹å¼å®ç°ï¼Œä¾‹å¦‚ï¼š

::: code-group

```js [webpack.config.js] {18,32,33}
const path = require('node:path')
const HtmlWebpackPlugin = require('html-webpack-plugin')

/**
 * @type {import('webpack').Configuration}
 */
module.exports = {
  mode: 'development',
  devtool: false,
  entry: {
    index: './src/index.js',
  },
  output: {
    filename: '[name]-[contenthash].js',
    path: path.resolve(__dirname, 'dist2'),
    clean: true,
  },
  externals: {
    react: 'React',
    lodash: '_'
  },
  plugins: [
    new HtmlWebpackPlugin({
      templateContent: `
      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>External demo</title>
        <script defer crossorigin src="https://www.unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
        <script defer crossorigin src="https://unpkg.com/browse/lodash@4.17.21/lodash.min.js"></script>
      </head>
      <body>
        <div id="app"></div>
      </body>
      </html>
      `
    })
  ]
}
```

:::

ç¤ºä¾‹ä¸­ï¼Œ`externals` å£°æ˜äº† `react` ä¸ `lodash` ä¸¤ä¸ªå¤–ç½®ä¾èµ–ï¼Œå¹¶åœ¨åç»­çš„ `html-webpack-plugin` æ¨¡æ¿ä¸­æ³¨å…¥è¿™ä¸¤ä¸ªæ¨¡å—çš„ CDN å¼•ç”¨ï¼Œä»¥æ­¤æ„æˆå®Œæ•´ Web åº”ç”¨ã€‚

è™½ç„¶ç»“æœä¸Šçœ‹æµè§ˆå™¨è¿˜æ˜¯å¾—æ¶ˆè€—è¿™éƒ¨åˆ†æµé‡ï¼Œä½†ç»“åˆ CDN ç³»ç»Ÿç‰¹æ€§:

1. ä¸€æ˜¯èƒ½å¤Ÿå°±è¿‘è·å–èµ„æºï¼Œç¼©çŸ­ç½‘ç»œé€šè®¯é“¾è·¯ï¼›
2. äºŒæ˜¯èƒ½å¤Ÿå°†èµ„æºåˆ†å‘ä»»åŠ¡å‰ç½®åˆ°èŠ‚ç‚¹æœåŠ¡å™¨ï¼Œå‡è½»åŸæœåŠ¡å™¨ QPS è´Ÿæ‹…ï¼›
3. ä¸‰æ˜¯ç”¨æˆ·è®¿é—®ä¸åŒç«™ç‚¹èƒ½å…±äº«åŒä¸€ä»½ CDN èµ„æºå‰¯æœ¬ã€‚æ‰€ä»¥ç½‘ç»œæ€§èƒ½æ•ˆæœå¾€å¾€ä¼šæ¯”é‡å¤æ‰“åŒ…å¥½å¾ˆå¤šã€‚



## ä½¿ç”¨Tree-Shakingåˆ é™¤å¤šä½™æ¨¡å—å¯¼å‡º

Tree-Shaking è¾ƒæ—©å‰ç”± [Rich Harris](https://github.com/Rich-Harris) åœ¨ Rollup ä¸­ç‡å…ˆå®ç°ï¼ŒWebpack è‡ª 2.0 ç‰ˆæœ¬å¼€å§‹æ¥å…¥ï¼Œæ˜¯ä¸€ç§åŸºäº ES Module è§„èŒƒçš„ Dead Code Elimination æŠ€æœ¯ï¼Œå®ƒä¼šåœ¨è¿è¡Œè¿‡ç¨‹ä¸­é™æ€åˆ†ææ¨¡å—ä¹‹é—´çš„å¯¼å…¥å¯¼å‡ºï¼Œåˆ¤æ–­å“ªäº›æ¨¡å—å¯¼å‡ºå€¼æ²¡æœ‰è¢«å…¶å®ƒæ¨¡å—ä½¿ç”¨ â€”â€” ç›¸å½“äºæ¨¡å—å±‚é¢çš„ Dead Codeï¼Œå¹¶å°†å…¶åˆ é™¤ã€‚

åœ¨ Webpack ä¸­ï¼Œå¯åŠ¨ Tree Shaking åŠŸèƒ½å¿…é¡»åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š

1. é…ç½® `optimization.usedExports` ä¸º `true`ï¼Œæ ‡è®°æ¨¡å—å¯¼å…¥å¯¼å‡ºåˆ—è¡¨ï¼›
2. å¯åŠ¨ä»£ç ä¼˜åŒ–åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å®ç°ï¼š
   1. é…ç½® `mode = production`
   2. é…ç½® `optimization.minimize = true`
   3. æä¾› `optimization.minimizer` æ•°ç»„

ä¾‹å¦‚ï¼š

::: code-group

```js [webpack.config.js]
module.exports = {
  mode: "production",
  optimization: {
    usedExports: true,
  },
}
```

:::

ä¹‹åï¼ŒWebpack ä¼šå¯¹æ‰€æœ‰ä½¿ç”¨ ESM æ–¹æ¡ˆçš„æ¨¡å—å¯åŠ¨ Tree-Shakingï¼Œä¾‹å¦‚å¯¹äºä¸‹é¢çš„ä»£ç ï¼š

::: code-group

```js [index.js]
import { bar } from './bar'

console.log(bar)
```

``` js [bar.js]
export const bar = 'bar';
export const foo = 'foo';
```

:::

`bar.js` æ¨¡å—å¯¼å‡ºäº† `bar` ã€`foo` ï¼Œä½†åªæœ‰ `bar` å€¼è¢« `index` æ¨¡å—ä½¿ç”¨ï¼Œç»è¿‡ Tree Shaking å¤„ç†åï¼Œ`foo` å˜é‡ä¼šè¢«è§†ä½œæ— ç”¨ä»£ç åˆ é™¤ï¼Œæœ€ç»ˆæœ‰æ•ˆçš„ä»£ç ç»“æ„ï¼š

::: code-group

```js [bar.js]
export const bar = 'bar';
export const foo = 'foo'; // [!code --]
```

```js [index.js]
import { bar } from './bar'

console.log(bar)
```

:::

åœ¨åé¢ç« èŠ‚ä¸­æˆ‘ä»¬ä¼šå±•å¼€è®²è§£ Tree-Shaking çš„å®ç°ç»†èŠ‚åŠæ³¨æ„äº‹é¡¹ï¼Œæ­¤å¤„å…ˆç•¥è¿‡ã€‚



## ä½¿ç”¨Scope Hoistingåˆå¹¶æ¨¡å—

é»˜è®¤æƒ…å†µä¸‹ Webpack ä¼šå°†æ¨¡å—æ‰“åŒ…æˆä¸€ä¸ªä¸ªå•ç‹¬çš„å‡½æ•°ï¼Œä¾‹å¦‚ï¼š

```js
// common.js
export default "common";

// index.js
import common from './common';
console.log(common);
```

ç»è¿‡ Webpack æ‰“åŒ…åä¼šç”Ÿæˆï¼š

```js
"./src/common.js":
  ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {
     const __WEBPACK_DEFAULT_EXPORT__ = ("common");
     __webpack_require__.d(__webpack_exports__, {
      /* harmony export */
      "default": () => (__WEBPACK_DEFAULT_EXPORT__)
      /* harmony export */
    });
  }),
"./src/index.js":
  ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {
      var _common__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__( /*! ./common */ "./src/common.js");
      console.log(_common__WEBPACK_IMPORTED_MODULE_0__)
  })
```

è¿™ç§å¤„ç†æ–¹å¼éœ€è¦å°†æ¯ä¸€ä¸ªæ¨¡å—éƒ½åŒ…è£¹è¿›ä¸€æ®µç›¸ä¼¼çš„å‡½æ•°æ¨¡æ¿ä»£ç ä¸­ï¼Œå¥½çœ‹æ˜¯å¥½çœ‹ï¼Œä½†æµªè´¹ç½‘ç»œæµé‡å•Šã€‚ä¸ºæ­¤ï¼ŒWebpack æä¾›äº† `Scope Hoisting` åŠŸèƒ½ï¼Œç”¨äº **å°†ç¬¦åˆæ¡ä»¶çš„å¤šä¸ªæ¨¡å—åˆå¹¶åˆ°åŒä¸€ä¸ªå‡½æ•°ç©ºé—´** ä¸­ï¼Œä»è€Œå‡å°‘äº§ç‰©ä½“ç§¯ï¼Œä¼˜åŒ–æ€§èƒ½ã€‚ä¾‹å¦‚ä¸Šè¿°ç¤ºä¾‹ç»è¿‡ Scope Hoisting ä¼˜åŒ–åï¼Œç”Ÿæˆä»£ç ï¼š

```js
((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {
    ;// CONCATENATED MODULE: ./src/common.js
    /* harmony default export */ const common = ("common");
    
    ;// CONCATENATED MODULE: ./src/index.js
    console.log(common);
})
```

Webpack æä¾›äº†ä¸‰ç§å¼€å¯ Scope Hoisting çš„æ–¹æ³•ï¼š

1. ä½¿ç”¨ `mode = 'production'` å¼€å¯ç”Ÿäº§æ¨¡å¼ï¼›
2. ä½¿ç”¨ `optimization.concatenateModules` é…ç½®é¡¹ï¼›
3. ç›´æ¥ä½¿ç”¨ `ModuleConcatenationPlugin` æ’ä»¶ã€‚

```js
const ModuleConcatenationPlugin = require('webpack/lib/optimize/ModuleConcatenationPlugin');

module.exports = {
    // 1ï¸âƒ£ æ–¹æ³•1ï¼š å°† `mode` è®¾ç½®ä¸º productionï¼Œå³å¯å¼€å¯
    mode: "production",
    // 2ï¸âƒ£ æ–¹æ³•2ï¼š å°† `optimization.concatenateModules` è®¾ç½®ä¸º true
    optimization: {
        concatenateModules: true,
        usedExports: true,
        providedExports: true,
    },
    // 3ï¸âƒ£ æ–¹æ³•3ï¼š ç›´æ¥ä½¿ç”¨ `ModuleConcatenationPlugin` æ’ä»¶
    plugins: [new ModuleConcatenationPlugin()]
};
```

ä¸‰ç§æ–¹æ³•æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ `ModuleConcatenationPlugin` å®Œæˆæ¨¡å—åˆ†æä¸åˆå¹¶æ“ä½œã€‚

ä¸ Tree-Shaking ç±»ä¼¼ï¼ŒScope Hoisting åº•å±‚åŸºäº ES Module æ–¹æ¡ˆçš„ [é™æ€ç‰¹æ€§](https://stackoverflow.com/questions/52965907/what-is-the-meaning-of-static-import-in-es6)ï¼Œæ¨æ–­æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå¹¶è¿›ä¸€æ­¥åˆ¤æ–­æ¨¡å—ä¸æ¨¡å—èƒ½å¦åˆå¹¶ï¼Œå› æ­¤åœ¨ä»¥ä¸‹åœºæ™¯ä¸‹ä¼šå¤±æ•ˆï¼š



> 1ï¸âƒ£ **é ESM æ¨¡å—**

é‡åˆ° AMDã€CMD ä¸€ç±»æ¨¡å—æ—¶ï¼Œç”±äºå¯¼å…¥å¯¼å‡ºå†…å®¹çš„åŠ¨æ€æ€§ï¼ŒWebpack æ— æ³•ç¡®ä¿æ¨¡å—åˆå¹¶åä¸ä¼šäº§ç”Ÿæ„æ–™ä¹‹å¤–çš„å‰¯ä½œç”¨ï¼Œå› æ­¤ä¼šå…³é—­ Scope Hoisting åŠŸèƒ½ã€‚è¿™ä¸€é—®é¢˜åœ¨å¯¼å…¥ NPM åŒ…å°¤å…¶å¸¸è§ï¼Œè®¸å¤šæ¡†æ¶éƒ½ä¼šè‡ªè¡Œæ‰“åŒ…åå†ä¸Šä¼ åˆ° NPMï¼Œå¹¶ä¸”é»˜è®¤å¯¼å‡ºçš„æ˜¯å…¼å®¹æ€§æ›´ä½³çš„ CommonJS åŒ…ï¼Œå› è€Œæ— æ³•ä½¿ç”¨ Scope Hoisting åŠŸèƒ½ï¼Œæ­¤æ—¶å¯é€šè¿‡ `mainFileds` å±æ€§å°è¯•å¼•å…¥æ¡†æ¶çš„ ESM ç‰ˆæœ¬ï¼š

```js
module.exports = {
  resolve: {
    // ä¼˜å…ˆä½¿ç”¨ jsnext:main ä¸­æŒ‡å‘çš„ ES6 æ¨¡å—åŒ–è¯­æ³•çš„æ–‡ä»¶
    mainFields: ['jsnext:main', 'browser', 'main']
  },
};
```

> 2ï¸âƒ£ **æ¨¡å—è¢«å¤šä¸ª Chunk å¼•ç”¨**

å¦‚æœä¸€ä¸ªæ¨¡å—è¢«å¤šä¸ª Chunk åŒæ—¶å¼•ç”¨ï¼Œä¸ºé¿å…é‡å¤æ‰“åŒ…ï¼ŒScope Hoisting åŒæ ·ä¼šå¤±æ•ˆï¼Œä¾‹å¦‚ï¼š

```js
// common.js
export default "common"

// async.js
import common from './common';

// index.js 
import common from './common';
import("./async");
```

ç¤ºä¾‹ä¸­ï¼Œå…¥å£ `index.js` ä¸å¼‚æ­¥æ¨¡å— `async.js` åŒæ—¶ä¾èµ– `common.js` æ–‡ä»¶ï¼Œ`common.js` æ— æ³•è¢«åˆå¹¶å…¥ä»»ä¸€ Chunkï¼Œè€Œæ˜¯ä½œä¸ºç”Ÿæˆä¸ºå•ç‹¬çš„ä½œç”¨åŸŸï¼Œæœ€ç»ˆæ‰“åŒ…ç»“æœï¼š

```js
"./src/common.js":
  (() => {
    var __WEBPACK_DEFAULT_EXPORT__ = ("common");
  }),
 "./src/index.js":
  (() => {
    var _common__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__( /*! ./common */ "./src/common.js");
    __webpack_require__.e( /*! import() */ "src_async_js").then(__webpack_require__.bind(__webpack_require__, /*! ./async */ "./src/async.js"));
  }), 
```



## ç›‘æ§äº§ç‰©ä½“ç§¯

ç»¼åˆæœ€è¿‘å‡ ç« è®¨è®ºçš„ Code Splittingã€å‹ç¼©ã€ç¼“å­˜ä¼˜åŒ–ã€Tree-Shaking ç­‰æŠ€æœ¯ï¼Œä¸éš¾çœ‹å‡ºæ‰€è°“çš„åº”ç”¨æ€§èƒ½ä¼˜åŒ–å‡ ä¹éƒ½ä¸ç½‘ç»œæœ‰å…³ï¼Œè¿™æ˜¯å› ä¸ºç°ä»£è®¡ç®—æœºç½‘ç»œç¯å¢ƒéå¸¸å¤æ‚ã€ä¸ç¨³å®šï¼Œè™½ç„¶æœ‰å ªæ¯”æœ¬åœ°ç£ç›˜ååé€Ÿåº¦çš„ 5G ç½‘ç»œï¼Œä½†ä¹Ÿè¿˜å­˜åœ¨å¤§é‡ä½é€Ÿ 2Gã€3G ç½‘ç»œç”¨æˆ·ï¼Œæ•´ä½“è€Œè¨€é€šè¿‡ç½‘ç»œå®ç°å¼‚åœ°æ•°æ®äº¤æ¢ä¾ç„¶æ˜¯ä¸€ç§ç›¸å¯¹ä½æ•ˆçš„ IO æ‰‹æ®µï¼Œæœ‰å¯èƒ½æˆä¸º Web åº”ç”¨æ‰§è¡Œé“¾æ¡ä¸­æœ€å¤§çš„æ€§èƒ½ç“¶é¢ˆã€‚

å› æ­¤ï¼Œç«™åœ¨ç”Ÿäº§è€…è§’åº¦æˆ‘ä»¬æœ‰å¿…è¦å°½å¯èƒ½ä¼˜åŒ–ä»£ç åœ¨ç½‘ç»œä¸Šåˆ†å‘çš„æ•ˆç‡ï¼Œç”¨å°½å¯èƒ½å°‘çš„ç½‘ç»œæµé‡äº¤ä»˜åº”ç”¨åŠŸèƒ½ã€‚æ‰€å¹¸ Webpack ä¸“é—¨ä¸ºæ­¤æä¾›äº†ä¸€å¥— [æ€§èƒ½ç›‘æ§æ–¹æ¡ˆ](https://github.com/webpack/webpack/issues/3216)ï¼Œå½“æ„å»ºç”Ÿæˆçš„äº§ç‰©ä½“ç§¯è¶…è¿‡é˜ˆå€¼æ—¶æŠ›å‡ºå¼‚å¸¸è­¦å‘Šï¼Œä»¥æ­¤å¸®åŠ©æˆ‘ä»¬æ—¶åˆ»å…³æ³¨èµ„æºä½“ç§¯ï¼Œé¿å…å› é¡¹ç›®è¿­ä»£å¢é•¿å¸¦æ¥è¿‡å¤§çš„ç½‘ç»œä¼ è¾“ï¼Œç”¨æ³•ï¼š

::: code-group

```js [webpack.config.js]
module.exports = {
  // ...
  performance: {
    // è®¾ç½®æ‰€æœ‰äº§ç‰©ä½“ç§¯é˜ˆå€¼
    maxAssetSize: 172 * 1024,
    // è®¾ç½® entry äº§ç‰©ä½“ç§¯é˜ˆå€¼
    maxEntrypointSize: 244 * 1024,
    // æŠ¥é”™æ–¹å¼ï¼Œæ”¯æŒ `error` | `warning` | false
    hints: 'error',
    // è¿‡æ»¤éœ€è¦ç›‘æ§çš„æ–‡ä»¶ç±»å‹
    assetFilter: function(assetFilename) {
      return assetFilename.endsWith('.js')
    }
  }
}
```

:::

ğŸŒ° [perf-budget - @github](https://github1s.com/Tecvan-fe/webpack-book-samples/blob/main/perf-budget/webpack.config.js)

```js
const path = require('node:path')
const HtmlWebpackPlugin = require('html-webpack-plugin')

/**
 * @type {import('webpack').Configuration}
 */
module.exports = {
  mode: 'development',
  devtool: false,
  entry: {
    index: './src/index.js',
  },
  output: {
    filename: '[name]-[contenthash].js',
    path: path.resolve(__dirname, 'dist'),
    clean: true,
  },
  performance: { // [!code focus]
    maxAssetSize: 172 * 1024, // [!code focus]
    hints: 'error' // [!code focus]
  } // [!code focus]
}
```

ä»£ç ï¼š

```js
// ./src/index.js
import _ from 'lodash'

console.log(_.add(1, 2));
```



è‹¥æ­¤æ—¶äº§ç‰©ä½“ç§¯è¶…è¿‡ `172KB`ï¼Œåˆ™æŠ¥é”™ï¼š

![performance hints](./imgs/15-9.webp)

::: warning

è¿™é‡Œçš„æŠ¥é”™ä¸ä¼šé˜»æ–­æ„å»ºåŠŸèƒ½ï¼Œ ä¾ç„¶èƒ½æ­£å¸¸æ‰“åŒ…å‡ºåº”ç”¨äº§ç‰©ã€‚

:::

é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥è®¾ç½®å¤šå¤§çš„é˜ˆå€¼å‘¢ï¼Ÿè¿™å–å†³äºé¡¹ç›®å…·ä½“åœºæ™¯ï¼Œä¸è¿‡ï¼Œä¸€ä¸ªæ¯”è¾ƒå¥½çš„ [ç»éªŒæ³•åˆ™](https://web.dev/your-first-performance-budget/#budget-for-quantity-based-metrics) æ˜¯ç¡®ä¿ [å…³é”®è·¯å¾„](https://web.dev/critical-rendering-path/) èµ„æºä½“ç§¯å§‹ç»ˆå°äº `170KB`ï¼Œè¶…è¿‡è¿™ä¸ªä½“ç§¯å°±åº”è¯¥ä½¿ç”¨ä¸Šé¢ä»‹ç»çš„è‹¥å¹²æ–¹æ³•åšå¥½è£å‰ªä¼˜åŒ–ã€‚



## æ€»ç»“

å‹ç¼©ã€Tree-Shakingã€Scope Hoisting éƒ½åœ¨å‡å°‘äº§ç‰©ä½“ç§¯ï¼›Code Splittingã€å¤–ç½®ä¾èµ–ã€`[hash]` åˆ™æœ‰åŠ©äºæå‡ HTTP ç¼“å­˜æ•ˆç‡ï¼›åŠ¨æ€åŠ è½½åˆ™èƒ½å¤Ÿç¡®ä¿å…³é”®è·¯å¾„æœ€å°èµ„æºä¾èµ–ã€‚ç§ç§æªæ–½å„è‡ªä»ä¸åŒè§’åº¦åŠªåŠ›ä¼˜åŒ–åº”ç”¨ä»£ç åœ¨ç½‘ç»œä¸Šçš„åˆ†å‘æ•ˆç‡ï¼Œæ¯•ç«Ÿç½‘ç»œé€šè®¯æœ‰æ—¶å€™çœŸçš„å¾ˆè´µï¼

ä¸è¿‡è½¯ä»¶ä¸–ç•Œæ²¡æœ‰é“¶å¼¹ï¼Œè¿‡åº¦çš„ä¼˜åŒ–æœ‰æ—¶å€™å¯èƒ½å¸¦æ¥åæ•ˆæœï¼Œå»ºè®®å¤§å®¶å‚è€ƒ [Web Vitals](https://web.dev/vitals/) æ¨¡å‹ï¼Œå§‹ç»ˆå…³æ³¨ã€å¯¹æ¯”åº”ç”¨çš„çº¿ä¸Šè¡¨ç°ï¼Œç¡®ä¿æœ€ä½³ç”¨æˆ·ä½“éªŒã€‚



## æ€è€ƒé¢˜

ä¸ºä½• Tree-Shaking å¼ºä¾èµ–äº ESM æ¨¡å—æ–¹æ¡ˆï¼ŸESM ä¸å…¶å®ƒæ–¹æ¡ˆå¦‚ AMDã€CMD ç­‰ï¼Œæœ‰ä½•åŒºåˆ«ï¼Ÿ



::: details chatgptå›ç­”

> 1ï¸âƒ£ ä¸ºä½• Tree-Shaking å¼ºä¾èµ–äº ESM æ¨¡å—æ–¹æ¡ˆï¼Ÿ

JavaScript Tree-Shaking æ˜¯æŒ‡é€šè¿‡**é™æ€åˆ†æ**ï¼Œå»é™¤æœªè¢«ä½¿ç”¨çš„ä»£ç ï¼ˆé€šå¸¸æ˜¯å‡½æ•°æˆ–å˜é‡ï¼‰ï¼Œä»¥å‡å°‘ç”Ÿæˆçš„JavaScriptä»£ç é‡ã€‚

ESM (ES Modules) æ˜¯ä¸€ç§ECMAScriptè§„èŒƒï¼Œç”¨äºç»„ç»‡å’ŒåŠ è½½JavaScriptæ¨¡å—ã€‚ESMä¸­å®šä¹‰äº†â€œé™æ€è§£æâ€è§„åˆ™ï¼Œå³åœ¨ç¼–è¯‘æ—¶å°±èƒ½ç¡®å®šæ¯ä¸ªæ¨¡å—æ‰€ä¾èµ–çš„å…¶ä»–æ¨¡å—ï¼Œè€Œä¸”è¿™äº›ä¾èµ–å…³ç³»ä¸ä¼šåœ¨è¿è¡Œæ—¶æ”¹å˜ã€‚è¿™ä½¿å¾—ESMå¯ä»¥åœ¨ç¼–è¯‘æ—¶å¯¹æ¨¡å—è¿›è¡Œé™æ€åˆ†æï¼Œæ‰¾å‡ºæœªè¢«ä½¿ç”¨çš„ä»£ç ï¼Œå¹¶å°†å…¶å‰”é™¤æ‰ã€‚

å› æ­¤ï¼ŒJavaScript Tree-Shakingå¼ºä¾èµ–äºESMæ¨¡å—æ–¹æ¡ˆï¼Œæ˜¯å› ä¸ºåªæœ‰ ESM æ‰èƒ½æä¾›é™æ€è§£æçš„ç‰¹æ€§ï¼Œæ‰èƒ½è®© Tree-Shaking èƒ½å¤Ÿæ­£ç¡®åœ°æ‰¾å‡ºæœªè¢«ä½¿ç”¨çš„ä»£ç å¹¶æ¶ˆé™¤å®ƒä»¬ã€‚è€Œ CommonJS å’Œ AMD ç­‰æ¨¡å—æ–¹æ¡ˆåˆ™æ— æ³•æä¾›è¿™æ ·çš„ç‰¹æ€§ï¼Œå› ä¸ºå®ƒä»¬å…è®¸åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½æ¨¡å—ï¼Œå¯¼è‡´æ— æ³•åœ¨ç¼–è¯‘æ—¶ç¡®å®šæ¨¡å—çš„ä¾èµ–å…³ç³»ï¼Œä¹Ÿå°±éš¾ä»¥è¿›è¡Œé™æ€åˆ†æå’Œ Tree-Shakingã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶éæ‰€æœ‰çš„ ESM å®ç°éƒ½èƒ½æ”¯æŒ Tree-Shakingã€‚ä¾‹å¦‚ï¼Œåœ¨ TypeScript ä¸­ä½¿ç”¨ ESM æ—¶ï¼Œå°±éœ€è¦å¼€å¯ "module": "esnext" é€‰é¡¹ï¼Œä»¥ç¡®ä¿ç¼–è¯‘å™¨èƒ½å¤Ÿæ­£ç¡®åœ°è¿›è¡Œé™æ€åˆ†æå’Œ Tree-ShakingğŸ’¡ã€‚



> 2ï¸âƒ£ESM ä¸å…¶å®ƒæ–¹æ¡ˆå¦‚ AMDã€CMD ç­‰ï¼Œæœ‰ä½•åŒºåˆ«ï¼Ÿ

ESM (ES Modules)ã€AMDï¼ˆAsynchronous Module Definitionï¼‰å’Œ CMD ï¼ˆCommon Module Definitionï¼‰éƒ½æ˜¯ç”¨äºç»„ç»‡å’ŒåŠ è½½JavaScriptæ¨¡å—çš„æ–¹æ¡ˆã€‚å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«ä¸»è¦åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. è¯­æ³•

ESM çš„è¯­æ³•ä½¿ç”¨ `import` å’Œ `export` å…³é”®å­—æ¥å®šä¹‰æ¨¡å—ï¼Œè€Œ AMD å’Œ CMD åˆ™åˆ†åˆ«ä½¿ç”¨ `define` å’Œ `require` å‡½æ•°æ¥å®šä¹‰æ¨¡å—å’ŒåŠ è½½æ¨¡å—ã€‚

2. ä¾èµ–å…³ç³»

ESM å®šä¹‰çš„ä¾èµ–å…³ç³»æ˜¯é™æ€çš„ï¼Œåœ¨ç¼–è¯‘æ—¶å°±èƒ½ç¡®å®šæ¯ä¸ªæ¨¡å—æ‰€ä¾èµ–çš„å…¶ä»–æ¨¡å—ï¼Œè€Œä¸”è¿™äº›ä¾èµ–å…³ç³»ä¸ä¼šåœ¨è¿è¡Œæ—¶æ”¹å˜ã€‚è€Œ AMD å’Œ CMD åˆ™å…è®¸åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½æ¨¡å—ï¼Œå¯¼è‡´æ— æ³•åœ¨ç¼–è¯‘æ—¶ç¡®å®šæ¨¡å—çš„ä¾èµ–å…³ç³»ã€‚

3. åŠ è½½æ–¹å¼

ESM çš„åŠ è½½æ–¹å¼æ˜¯åŒæ­¥çš„ï¼Œå³é‡åˆ° `import` è¯­å¥æ—¶ä¼šç«‹å³åŠ è½½ä¾èµ–çš„æ¨¡å—ï¼Œè€Œ AMD å’Œ CMD åˆ™æ˜¯å¼‚æ­¥åŠ è½½æ¨¡å—ã€‚

4. å…¼å®¹æ€§

ESM æ˜¯ ECMAScript è§„èŒƒçš„ä¸€éƒ¨åˆ†ï¼Œåœ¨ç°ä»£æµè§ˆå™¨ä¸­å¾—åˆ°äº†å¹¿æ³›æ”¯æŒã€‚è€Œ AMD å’Œ CMD åˆ™éœ€è¦é€šè¿‡åº“æˆ–æ¡†æ¶çš„æ”¯æŒæ‰èƒ½è¿è¡Œåœ¨æµè§ˆå™¨ä¸­ã€‚

æ€»çš„æ¥è¯´ï¼ŒESM ç›¸æ¯”äº AMD å’Œ CMDï¼Œå…·æœ‰æ›´ä¸ºç®€æ´çš„è¯­æ³•ã€æ›´ä¸ºæ˜ç¡®çš„ä¾èµ–å…³ç³»å’Œæ›´ä¸ºé«˜æ•ˆçš„åŠ è½½æ–¹å¼ã€‚åŒæ—¶ï¼ŒESM è¿˜å¯ä»¥è¿›è¡Œé™æ€åˆ†æå’Œ Tree-Shaking ä¼˜åŒ–ï¼Œè¿™ä½¿å¾— ESM æˆä¸ºäº†ç›®å‰æœ€ä¸ºæµè¡Œçš„ JavaScript æ¨¡å—æ–¹æ¡ˆä¹‹ä¸€ã€‚

:::



2023å¹´04æœˆ13æ—¥14:34:20

